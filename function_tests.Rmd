---
title: "function_tests"
author: "Raine Detmer"
date: "2025-06-16"
output: html_document
---

README: testing that the functions work


load the functions

```{r}

source("coral_demographic_funs.R")
source("rse_funs.R")
```


# demographic functions

```{r}

# start by using parameters from the Acropora palmata model by Vardi et al. 2012
# NOTE in this study, fragamentation is separated from shrinkage and can result in columns adding up to more than one (if a large colony produces fragments but the majority of the colony stays in the same size class, I think)

n <- 4

# also jumping a size class can happen through fusion

col1 <- c(0.6, 0.15, 0.01, 0)/sum(0.6, 0.15, 0.01, 0)
col2 <- c(0.07, 0.69, 0.11, 0)/sum(0.07, 0.69, 0.11, 0)
col3 <- c(0, 0.1, 0.74, 0.11)/sum(0, 0.1, 0.74, 0.11)
col4 <- c(0, 0.06, 0.11, 0.83)/sum(0, 0.06, 0.11, 0.83)

sum(col1)
sum(col2)
sum(col3)
sum(col4)

#growth/fusion
growth_pars1 <- list(col1[2:4], col2[3:4], col3[4], NULL)
# shrinking
shrink_pars1 <- list(NULL, col2[1], col3[1:2], col4[1:3])
# fragmentation
frag_pars1 <- list(NULL, c(0), c(0.06, 0.06), c(0.28, 0.3, 0.23))
# survival
surv_pars1 <- 1-c(0.24, 0.13, 0.05, 0)
# fecundity (not in Vardi et al. 2012, check other studies and just make up for now)
fec_pars1 <- c(0, 0.1, 1, 2)
# recruitment
lambda1 <- 10

G_fun(years = 10, n = 4, growth_pars = growth_pars1, shrink_pars = shrink_pars1, frag_pars = frag_pars1)
Surv_fun(years = 10, n = 4, surv_pars = surv_pars1, sigma_s = 0)
Rep_fun(years = 10, n = 4, fec_pars = c(0, 0.1, 1, 2), sigma_f = 0)
Ext_fun(years = 10, lambda = lambda1, rand = F, seed1 = 10)


dist_yrs <- c(5, 7)

dist_surv <- list()
dist_surv[[1]] <- surv_pars1*0.1
dist_surv[[2]] <- surv_pars1*0.01

dist_Tmat <- list()
dist_Tmat[[1]] <- G_fun(years = 1, n, list(col1[2:4]*0.9, col2[3:4]*0.9, col3[4]*0.9, NULL), shrink_pars1, frag_pars1)$G_list[[1]]
dist_Tmat[[2]] <- G_fun(years = 1, n, growth_pars1, shrink_pars1, frag_pars1)$G_list[[1]]

dist_Fmat <- list()
dist_Fmat[[1]] <- G_fun(years = 1, n, growth_pars1, shrink_pars1, frag_pars1)$Fr_list[[1]]
dist_Fmat[[2]] <- G_fun(years = 1, n, growth_pars1, shrink_pars1, frag_pars1)$Fr_list[[1]]


dist_fec <- list()
dist_fec[[1]] <- fec_pars1*0.8
dist_fec[[2]] <- fec_pars1*1

dist_pars <- list(dist_surv = dist_surv, dist_Tmat = dist_Tmat, dist_Fmat = dist_Fmat, dist_fec = dist_fec)

dist_effects <- list()
dist_effects[[1]] <- c("survival", "Tmat", "Fmat", "fecundity")
dist_effects[[2]] <- c("survival")

mat_test <- mat_pars_fun(years = 10, n = 4, surv_pars1, growth_pars1, shrink_pars1, frag_pars1, fec_pars1, sigma_s = 0, sigma_f = 0, seeds = c(10, 100, 200), dist_yrs, dist_pars, dist_effects)

# years, n, surv_pars, growth_pars, shrink_pars, frag_pars, fec_pars,  sigma_s, sigma_f, seeds, dist_yrs, dist_pars, dist_effects

# mat_test$survival
# mat_test$growth
# mat_test$fecundity

```



# full model

```{r}
# model parameters

years <- 20 # length of simulation
n <- 5 # number of size classes

A_mids <- c(0.1, 43, 369, 2158, 11171) # mean areas in each size class (cm^2)

# restoration treatments
orchard_treatments <- c("none") # orchard
reef_treatments <- c("none") # reef
lab_treatments <- c("1_T1") # lab: all need to have prefix of either "0" (immediately outplanted) or "1" (outplanted after 1 year) followed by a "TX" (tile type)


# demographic parameters for each orchard and reef treatment
# reef parameters
surv_pars.r <- list() # probabilities of surviving on reef
surv_pars.r[[1]] <- list() # first reef 
#surv_pars.r[[1]][[1]] <- 1- c(0.24, 0.13, 0.05, 0.001) # survival probabilities for first source of recruits to first reef
surv_pars.r[[1]][[1]] <- 1- c(0.99, 0.24, 0.13, 0.05, 0.001)

growth_pars.r <- list()
growth_pars.r[[1]] <- list()
#growth_pars.r[[1]][[1]] <- list(c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL)
growth_pars.r[[1]][[1]] <- list(c(0.85, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL)

shrink_pars.r <- list()
shrink_pars.r[[1]] <- list()
#shrink_pars.r[[1]][[1]] <- list(NULL, 0.08, c(0, 0.105), c(0, 0.06, 0.11))
shrink_pars.r[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.08), c(0, 0, 0.105), c(0, 0, 0.06, 0.11))

frag_pars.r <- list()
frag_pars.r[[1]] <- list()
#frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0.06, 0.06), c(0.28, 0.3, 0.23))
#frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0))
frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.06, 0.06), c(0, 0.28, 0.3, 0.23))

fec_pars.r <- list()
fec_pars.r[[1]] <- list()
#fec_pars.r[[1]][[1]] <- c(0, 0.1, 1, 2)
fec_pars.r[[1]][[1]] <- c(0, 0, 0.1, 1, 2)

# orchard parameters
surv_pars.o <- list()
surv_pars.o[[1]] <- list()
#surv_pars.o[[1]][[1]] <- 1- c(0.24, 0.13, 0.05, 0.001) # probabilities of surviving
surv_pars.o[[1]][[1]] <- 1- c(0.99, 0.24, 0.13, 0.05, 0.001)

growth_pars.o <- list()
growth_pars.o[[1]] <- list()
#growth_pars.o[[1]][[1]] <- list(c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL)
growth_pars.o[[1]][[1]] <- list(c(0.85, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL)

shrink_pars.o <- list()
shrink_pars.o[[1]] <- list()
#shrink_pars.o[[1]][[1]] <- list(NULL, 0.08, c(0, 0.105), c(0, 0.06, 0.11))
shrink_pars.o[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.08), c(0, 0, 0.105), c(0, 0, 0.06, 0.11))

frag_pars.o <- list()
frag_pars.o[[1]] <- list()
#frag_pars.o[[1]][[1]] <- list(NULL, c(0), c(0.06, 0.06), c(0.28, 0.3, 0.23))
#frag_pars.o[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0))
frag_pars.o[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.06, 0.06), c(0, 0.28, 0.3, 0.23))


fec_pars.o <- list()
fec_pars.o[[1]] <- list()
#fec_pars.o[[1]][[1]] <- c(0, 10, 50, 100)
fec_pars.o[[1]][[1]] <- c(0, 0, 0.1, 1, 2)


# disturbance parameters
dist_yrs <- NA#c(10) # years when disturbance occurs, NA if none

# disturbance effects for each reef subpop
dist_effects.r <- list()
dist_effects.r[[1]] <- list() # list where each element is effects of disturbance on corals from each source in the 1st reef subpop
dist_effects.r[[1]][[1]] <- list() # effects of disturbances on corals from first source in first reef subpop
dist_effects.r[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)

# disturbance parameters for each reef subpop
dist_pars.r <- list() # first reef subpop
dist_pars.r[[1]] <- list() # first source in first reef subpop

dist_surv.r <- list() # first reef subpop
dist_surv.r[[1]] <- surv_pars.r[[1]][[1]]*0.1 # survival probabilities of corals from first source in first reef subpop in first disturbance year (dist_surv.r[[2]] would be second disturbance)

dist_Tmat.r <- list()
dist_Tmat.r[[1]] <- list()

dist_Fmat.r <- list()
dist_Fmat.r[[1]] <- list()

dist_fec.r <- list()
dist_fec.r[[1]] <- list()

dist_pars.r[[1]][[1]] <- list(dist_surv = dist_surv.r, dist_Tmat = dist_Tmat.r, dist_Fmat = dist_Fmat.r, dist_fec = dist_fec.r) # list of disturbance parameters for first source in the first reef subpop

# disturbance effects for each orchard subpop
dist_effects.o <- list() # first orchard treatment
dist_effects.o[[1]] <- list() # list where each element is effects of disturbance on corals from each source in the 1st orchard subpop
dist_effects.o[[1]][[1]] <- list() # effects of disturbances on corals from first source in first reef subpop
dist_effects.o[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef orchard ([[1]][[1]][[2]] would be second disturbance, etc.)

# disturbance parameters for each orchard subpop
dist_pars.o <- list()
dist_pars.o[[1]] <- list() # first source in first orchard subpop

# first orchard subpop
dist_surv.o <- list() # first orchard subpop
dist_surv.o[[1]] <- surv_pars.o[[1]][[1]]*0.1 # survival probabilities of corals from first source in first orchard subpop in first disturbance year (dist_surv.o[[2]] would be second disturbance)

dist_Tmat.o <- list()
dist_Tmat.o[[1]] <- list()

dist_Fmat.o <- list()
dist_Fmat.o[[1]] <- list()

dist_fec.o <- list()
dist_fec.o[[1]] <- list()

dist_pars.o[[1]][[1]] <- list(dist_surv = dist_surv.o, dist_Tmat = dist_Tmat.o, dist_Fmat = dist_Fmat.o, dist_fec = dist_fec.o) # list of disturbance parameters for first source in the first orchard subpop

lambda <- 0 # external recruitment to reef

# stochasticity parameters
sigma_s <- 0
sigma_f <- 0
ext_rand <- FALSE
seeds <- c(1000, 5000, 10000)

# initial conditions in each treatment subpopulation
N0.r <- list()
N0.r[[1]] <- list() # first reef subpop
N0.r[[1]][[1]] <- rep(1, n) # first source in first reef subpop

N0.o <- list()
N0.o[[1]] <- list() # first orchard subpop
N0.o[[1]] <- rep(1, n) # first source in first orchard subpop

N0.l <- list()
N0.l <- 1

# lab parameters
#sett <- c(0.5) # fraction of larvae that successfully settle in each lab treatment
#s <- c(0.7) # fraction of settled larvae in each lab treatment that survive to time of outplanting
#n_retain <- c(100) # max number of new settlers retained in each lab treatment in the lab for a year 
s0 <- c(0.9) # fraction of settled larvae in each lab treatment that survive to 2wk outplanting
s1 <- c(0.9) # fraction of settled larvae in each lab treatment that survive to 1 yr outplanting
sett_props <- list(T1 = 1) # proportion of larvae that settle on each tile type
size_props <- matrix(NA, nrow = length(lab_treatments), ncol = n) # matrix for fractions of recruits in each size class when they are outplanted
size_props[1, ] <- c(0.2, 0.8, 0, 0, 0) # c(1, 0, 0, 0, 0)
#lab_pars <- list(sett = sett, s = s, n_retain = n_retain, size_props = size_props)
#lab_pars <- list(sett = sett, s = s, size_props = size_props)
lab_pars <- list(s0 = s0, s1 = s1, sett_props = sett_props, size_props = size_props)


# restoration strategy parameters
orchard_yield <- 0 # percent of new orchard babies successfully collected
reef_yield <- 0.1 # percent of new reef babies successfully collected
#lab_props <- 1 # proportion of new babies put in each lab treatment
reef_prop <- 0.5 # proportion of lab recruits from each lab treatment outplanted to reef (1-proportion outplanted to orchard)
reef_out_props <- matrix(1, nrow = length(lab_treatments), ncol = length(reef_treatments)) # proportion recruits going from each lab treatment to each orchard treatment (row = origin lab treatment, column = destination reef treatment)
orchard_out_props <- matrix(1, nrow = length(lab_treatments), ncol = length(orchard_treatments)) # proportion recruits going from each lab treatment to each orchard treatment

# sizes allocated to each treatment
reef_areas <- c(50)*10000 # m^2 given to each reef treatment (make sure to include none -- sum of reef_areas should be size of reef), convert to cm^2
lab_max <- c(5000) # total number of settlers that the lab can accommodate
lab_retain_max <- c(1000) # total number of settlers that the lab can keep for a year
orchard_size <- c(200) # number of individuals each orchard treatment has space for

# coral transplanting
transplant <- rep(0, years)

rest_pars <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant)


sim1 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars, N0.r, N0.o, N0.l)




```




```{r}
#sim1$reef_pops

#sim1$orchard_pops

reef1_tot <- apply(sim1$reef_pops[[1]][[1]], MARGIN = 2, sum)
orch1_tot <- apply(sim1$orchard_pops[[1]][[1]], MARGIN = 2, sum)

#reef1_tot <- apply(reef_pops[[1]][[1]], MARGIN = 2, sum)
#orch1_tot <- apply(orchard_pops[[1]][[1]], MARGIN = 2, sum)

plot(x = c(1:years), y = reef1_tot, type = "l", las = 1, ylim = c(0, max(max(reef1_tot), max(orch1_tot))), xlab = "year", ylab = "Pop'n size", lwd = 2)
lines(x = c(1:years), y = orch1_tot, type = "l", col = "dodgerblue", lwd = 2, lty = 2)
legend("topleft", legend = c("reef", "orchard"), col = c("black", "dodgerblue"), lwd = 2, lty = c(1, 2))

```

NOTES: 
1) only reef treatment is "none" so there are no outplants, so varying the recruitment parameters won't change the reef dynamics here 
2) when external recruits are the dominant source of new individuals, then the population seems to smoothly approach an equilibrium that depends on lambda
3) the populations will blow up if there is fragmentation... so might need to redo fragmentation in a way that allows for making it stop if the populations are full (also not sure if any natural fragments would survive in the orchard?). Maybe make a separate F_mat (so T_mat will become T_mat + F_mat in the model)



```{r}

# try plotting total area occupied
reef1_Atot <- rep(NA, years)

for(i in 1:years){
  
  reef1_Atot[i] <- sum(sim1$reef_pops[[1]][[1]][,i]*A_mids)
  
}


plot(x = c(1:years), y = reef1_Atot, type = "l", las = 1, xlab = "year", ylab = "Area covered", lwd = 2, ylim = c(0, reef_areas[1])) # ylim = c(0, max(reef1_Atot))
abline(h = reef_areas[1], lty = 2)

```

now try multiple treatments


```{r}

years <- 20
n <- 5

orchard_treatments <- c("none", "algae_scrub") # orchard
reef_treatments <- c("none", "algae_scrub", "urchin_outplant") # reef
lab_treatments <- c("0_T1", "1_T2") # lab

# demographic parameters for each orchard and reef treatment
# reef parameters: survival
surv_pars.r <- list()
surv_pars.r[[1]] <- list() # first reef subpop (reference reef) 
#surv_pars.r[[1]][[1]] <- 1- c(0.24, 0.13, 0.05, 0.001) # survival probabilities for first source of recruits to first reef (external recruits)
surv_pars.r[[1]][[1]] <- 1- c(0.99, 0.24, 0.13, 0.05, 0.001)


surv_pars.r[[2]] <- list() # second reef subpop
surv_pars.r[[2]][[1]] <- surv_pars.r[[1]][[1]] # survival probabilities for first source of recruits to second reef subpop (external recruits)
surv_pars.r[[2]][[2]] <- surv_pars.r[[1]][[1]] # survival probabilities for second source of recruits to second reef subpop (first lab treatment)
surv_pars.r[[2]][[3]] <- surv_pars.r[[1]][[1]] # survival probabilities for third source of recruits to second reef subpop (second lab treatment)

surv_pars.r[[3]] <- list() # third reef subpop
surv_pars.r[[3]][[1]] <- surv_pars.r[[1]][[1]] 
surv_pars.r[[3]][[2]] <- surv_pars.r[[1]][[1]] 
surv_pars.r[[3]][[3]] <- surv_pars.r[[1]][[1]]

# reef parameters: growth
growth_pars.r <- list()
growth_pars.r[[1]] <- list() # first reef subpop
#growth_pars.r[[1]][[1]] <- list(c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) # first source to first reef subpop (external recruits)
growth_pars.r[[1]][[1]] <- list(c(0.85, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL)

growth_pars.r[[2]] <- list() # second reef subpop
growth_pars.r[[2]][[1]] <- growth_pars.r[[1]][[1]] # first source (ext recruits)
growth_pars.r[[2]][[2]] <- growth_pars.r[[1]][[1]] # second source (first lab treatment)
growth_pars.r[[2]][[3]] <- growth_pars.r[[1]][[1]] # third source (third lab treatment)

growth_pars.r[[3]] <- list() # third reef subpop
growth_pars.r[[3]][[1]] <- growth_pars.r[[1]][[1]] # first source (ext recruits)
growth_pars.r[[3]][[2]] <- growth_pars.r[[1]][[1]] # second source (first lab treatment)
growth_pars.r[[3]][[3]] <- growth_pars.r[[1]][[1]] # third source (third lab treatment)

# reef parameters: shrinkage
shrink_pars.r <- list()
shrink_pars.r[[1]] <- list() # first subpop
#shrink_pars.r[[1]][[1]] <- list(NULL, 0.08, c(0, 0.105), c(0, 0.06, 0.11)) # first source
shrink_pars.r[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.08), c(0, 0, 0.105), c(0, 0, 0.06, 0.11))

shrink_pars.r[[2]] <- list() # second subpop
shrink_pars.r[[2]][[1]] <- shrink_pars.r[[1]][[1]] # first source
shrink_pars.r[[2]][[2]] <- shrink_pars.r[[1]][[1]] # second source
shrink_pars.r[[2]][[3]] <- shrink_pars.r[[1]][[1]] # third source

shrink_pars.r[[3]] <- list() # third subpop
shrink_pars.r[[3]][[1]] <- shrink_pars.r[[1]][[1]] # first source
shrink_pars.r[[3]][[2]] <- shrink_pars.r[[1]][[1]] # second source
shrink_pars.r[[3]][[3]] <- shrink_pars.r[[1]][[1]] # third source


# reef parameters: fragmentation
frag_pars.r <- list()
frag_pars.r[[1]] <- list() # first subpop
#frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0.06, 0.06), c(0.28, 0.3, 0.23)) # first source

#frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.06, 0.06), c(0, 0.28, 0.3, 0.23))

frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0))


frag_pars.r[[2]] <- list() # second subpop
frag_pars.r[[2]][[1]] <- frag_pars.r[[1]][[1]] # first source
frag_pars.r[[2]][[2]] <- frag_pars.r[[1]][[1]] # second source
frag_pars.r[[2]][[3]] <- frag_pars.r[[1]][[1]] # third source

frag_pars.r[[3]] <- list() # third subpop
frag_pars.r[[3]][[1]] <- frag_pars.r[[1]][[1]] # first source
frag_pars.r[[3]][[2]] <- frag_pars.r[[1]][[1]] # second source
frag_pars.r[[3]][[3]] <- frag_pars.r[[1]][[1]] # third source

# reef parameters: fecundity

fec_pars.r <- list()
fec_pars.r[[1]] <- list() # first subpop
#fec_pars.r[[1]][[1]] <- c(0, 0.1, 1, 2) # first source
fec_pars.r[[1]][[1]] <- c(0, 0, 0.1, 1, 2)*50 # first source

fec_pars.r[[2]] <- list()
fec_pars.r[[2]][[1]] <- fec_pars.r[[1]][[1]]
fec_pars.r[[2]][[2]] <- fec_pars.r[[1]][[1]]
fec_pars.r[[2]][[3]] <- fec_pars.r[[1]][[1]]

fec_pars.r[[3]] <- list()
fec_pars.r[[3]][[1]] <- fec_pars.r[[1]][[1]]
fec_pars.r[[3]][[2]] <- fec_pars.r[[1]][[1]]
fec_pars.r[[3]][[3]] <- fec_pars.r[[1]][[1]]

# orchard parameters: survival
surv_pars.o <- list()
surv_pars.o[[1]] <- list() # first treatment
#surv_pars.o[[1]][[1]] <- 1- c(0.24, 0.13, 0.05, 0.001) # first source (first lab treatment)
surv_pars.o[[1]][[1]] <- 1- c(0.99, 0.24, 0.13, 0.05, 0.001)
surv_pars.o[[1]][[2]] <- surv_pars.o[[1]][[1]] # second source (second lab treatment)

surv_pars.o[[2]] <- list() # second treatment
surv_pars.o[[2]][[1]] <- surv_pars.o[[1]][[1]] # first source (first lab treatment)
surv_pars.o[[2]][[2]] <- surv_pars.o[[1]][[1]] # second source (second lab treatment)

# orchard parameters: growth
growth_pars.o <- list()
growth_pars.o[[1]] <- list() # first treatment
#growth_pars.o[[1]][[1]] <- list(c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) # first source
growth_pars.o[[1]][[1]] <- list(c(0.85, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL)
growth_pars.o[[1]][[2]] <- growth_pars.o[[1]][[1]] # second source

growth_pars.o[[2]] <- list() # second treatment
growth_pars.o[[2]][[1]] <-growth_pars.o[[1]][[1]] # first source
growth_pars.o[[2]][[2]] <- growth_pars.o[[1]][[1]] # second source

# orchard parameters: shrinkage
shrink_pars.o <- list()
shrink_pars.o[[1]] <- list() # first treatment
#shrink_pars.o[[1]][[1]] <- list(NULL, 0.08, c(0, 0.105), c(0, 0.06, 0.11)) # first source
shrink_pars.o[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.08), c(0, 0, 0.105), c(0, 0, 0.06, 0.11))
shrink_pars.o[[1]][[2]] <- shrink_pars.o[[1]][[1]] # second source

shrink_pars.o[[2]] <- list() # second treatment
shrink_pars.o[[2]][[1]] <- shrink_pars.o[[1]][[1]] # first source
shrink_pars.o[[2]][[2]] <- shrink_pars.o[[1]][[1]] # second source

# orchard parameters: fragmentation
frag_pars.o <- list()
frag_pars.o[[1]] <- list() # first treatment
#frag_pars.o[[1]][[1]] <- list(NULL, 0, c(0, 0), c(0, 0, 0)) # first source
frag_pars.o[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0))
frag_pars.o[[1]][[2]] <- frag_pars.o[[1]][[1]] # second source

frag_pars.o[[2]] <- list() # second treatment
frag_pars.o[[2]][[1]] <- frag_pars.o[[1]][[1]] # first source
frag_pars.o[[2]][[2]] <- frag_pars.o[[1]][[1]] # second source

fec_pars.o <- list()
fec_pars.o[[1]] <- list() # first treatment
#fec_pars.o[[1]][[1]] <- c(0, 10, 50, 100) # first source
fec_pars.o[[1]][[1]] <- c(0, 0, 0.1, 1, 2) # first source
fec_pars.o[[1]][[2]] <- fec_pars.o[[1]][[1]] # second source

fec_pars.o[[2]] <- list() # second treatment
fec_pars.o[[2]][[1]] <- c(0, 0, 0.1, 1, 2) # first source
fec_pars.o[[2]][[2]] <- fec_pars.o[[1]][[1]] # second source

lambda <- 0 # external recruitment to reef

# stochasticity parameters
sigma_s <- 0
sigma_f <- 0
ext_rand <- FALSE
seeds <- c(1000, 5000, 10000)

# initial conditions in each reef subpopulation
N0.r <- list()
N0.r[[1]] <- list() # first reef subpop
N0.r[[1]][[1]] <- rep(1, n) # first source in first reef subpop 
N0.r[[2]] <- list() # second reef subpop
N0.r[[2]][[1]] <- rep(1, n) # first source
N0.r[[2]][[2]] <- rep(1, n) # second source
N0.r[[2]][[3]] <- rep(1, n) # third source
N0.r[[3]] <- list() # third reef subpop
N0.r[[3]][[1]] <- rep(1, n) # first source
N0.r[[3]][[2]] <- rep(1, n) # second source
N0.r[[3]][[3]] <- rep(1, n) # third source

# intial conditions in each orchard subpopulation
N0.o <- list()
N0.o[[1]] <- list() # first orchard treatment
N0.o[[1]][[1]] <- rep(1, n) # first source
N0.o[[1]][[2]] <- rep(1, n) # second source
N0.o[[2]] <- list() # second orchard treatment
N0.o[[2]][[1]] <- rep(1, n) # first source
N0.o[[2]][[2]] <- rep(1, n) # second source

N0.l <- list()
N0.l[[1]] <- 1
N0.l[[2]] <- 1


# disturbance parameters
dist_yrs <- NA#c(10) # years when disturbance occurs, NA if none

# disturbance effects for each reef subpop
dist_effects.r <- list()
dist_effects.r[[1]] <- list() # list where each element is the effects of disturbnce on corals from each source in the 1st reef subpop
dist_effects.r[[1]][[1]] <- list() # effects of disturbances on corals from first source in first reef subpop
dist_effects.r[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)

# second reef subpop
dist_effects.r[[2]] <- list() 
dist_effects.r[[2]][[1]] <- list() # first source
dist_effects.r[[2]][[1]][[1]] <- c("survival")
dist_effects.r[[2]][[2]] <- list() # second source
dist_effects.r[[2]][[2]][[1]] <- c("survival")
dist_effects.r[[2]][[3]] <- list() # third source
dist_effects.r[[2]][[3]][[1]] <- c("survival")

# third reef subpop
dist_effects.r[[3]] <- list() 
dist_effects.r[[3]][[1]] <- list() # first source
dist_effects.r[[3]][[1]][[1]] <- c("survival")
dist_effects.r[[3]][[2]] <- list() # second source
dist_effects.r[[3]][[2]][[1]] <- c("survival")
dist_effects.r[[3]][[3]] <- list() # third source
dist_effects.r[[3]][[3]][[1]] <- c("survival")


# disturbance parameters for each reef subpop
dist_pars.r <- list()

# first reef subpop
dist_pars.r[[1]] <- list() # first source in first reef subpop

dist_surv.r <- list()
dist_surv.r[[1]] <- surv_pars.r[[1]][[1]]*0.1 # survival probabilities of corals from first source in first reef subpop in first disturbance year (dist_surv.r[[2]] would be second disturbance)

dist_Tmat.r <- list()
dist_Tmat.r[[1]] <- list() # first disturbance

dist_Fmat.r <- list()
dist_Fmat.r[[1]] <- list() # first disturbance

dist_fec.r <- list()
dist_fec.r[[1]] <- list() # first disturbance

dist_pars.r[[1]][[1]] <- list(dist_surv = dist_surv.r, dist_Tmat = dist_Tmat.r, dist_Fmat = dist_Fmat.r, dist_fec = dist_fec.r) # list of disturbance parameters for the first source in the first reef subpop


# second reef subpop
dist_pars.r[[2]] <- list() # first source in second reef subpop

dist_surv.r <- list()
dist_surv.r[[1]] <- surv_pars.r[[1]][[1]]*0.1 # survival probabilities of corals from first source in second reef subpop in first disturbance year (dist_surv.r[[2]] would be second disturbance)

dist_Tmat.r <- list()
dist_Tmat.r[[1]] <- list() # first disturbance

dist_Fmat.r <- list()
dist_Fmat.r[[1]] <- list() # first disturbance

dist_fec.r <- list()
dist_fec.r[[1]] <- list() # first disturbance

dist_pars.r[[2]][[1]] <- list(dist_surv = dist_surv.r, dist_Tmat = dist_Tmat.r, dist_Fmat = dist_Fmat.r, dist_fec = dist_fec.r) # list of disturbance parameters for the first source in the second reef subpop
dist_pars.r[[2]][[2]] <- list(dist_surv = dist_surv.r, dist_Tmat = dist_Tmat.r, dist_Fmat = dist_Fmat.r, dist_fec = dist_fec.r) # list of disturbance parameters for the second source in the second reef subpop
dist_pars.r[[2]][[3]] <- list(dist_surv = dist_surv.r, dist_Tmat = dist_Tmat.r, dist_Fmat = dist_Fmat.r, dist_fec = dist_fec.r) # list of disturbance parameters for the third source in the second reef subpop

# third reef subpop
dist_pars.r[[3]] <- list() # first source in first reef subpop

dist_surv.r <- list()
dist_surv.r[[1]] <- surv_pars.r[[1]][[1]]*0.1 # survival probabilities of corals from first source in first reef subpop in first disturbance year (dist_surv.r[[2]] would be second disturbance)

dist_Tmat.r <- list()
#dist_Tmat.r[[1]] <- list() # first disturbance

dist_Fmat.r <- list()
#dist_Fmat.r[[1]] <- list() # first disturbance

dist_fec.r <- list()
#dist_fec.r[[1]] <- list() # first disturbance

dist_pars.r[[3]][[1]] <- list(dist_surv = dist_surv.r, dist_Tmat = dist_Tmat.r, dist_Fmat = dist_Fmat.r, dist_fec = dist_fec.r) # list of disturbance parameters for the first source in the second reef subpop
dist_pars.r[[3]][[2]] <- list(dist_surv = dist_surv.r, dist_Tmat = dist_Tmat.r, dist_Fmat = dist_Fmat.r, dist_fec = dist_fec.r) # list of disturbance parameters for the second source in the second reef subpop
dist_pars.r[[3]][[3]] <- list(dist_surv = dist_surv.r, dist_Tmat = dist_Tmat.r, dist_Fmat = dist_Fmat.r, dist_fec = dist_fec.r) # list of disturbance parameters for the third source in the second reef subpop


# test out dist_pars_fun: run separately for each subpop/source combination, for each go through and fill in the parameters for each disturbance, output is the dist_pars.r[[3]][[1]], dist_pars.r[[3]][[2]], etc. parameter lists
# defaults for each parameter type are NULL unless specified

# dist_surv = list where ith element is the survival probabilities for the ith disturbance

# list("survival", "survival") should be replaced with dist_effects.r[[3]][[3]]
dist_pars.r.3.3 <- dist_pars_fun(dist_yrs = c(10, 20), list("survival", "survival"), dist_surv0 = list(surv_pars.r[[1]][[1]]*0.1, surv_pars.r[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)


# disturbance effects for each orchard subpop

dist_effects.o <- list()
dist_effects.o[[1]] <- list() # list where each element is the effects of disturbnce on corals from each source in the 1st orchard treatment
dist_effects.o[[1]][[1]] <- list() # effects of disturbances on corals from first source in first orchard treatment
dist_effects.o[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)
dist_effects.o[[1]][[2]] <- list() # second source
dist_effects.o[[1]][[2]][[1]] <- c("survival")

# second orchard treatment
dist_effects.o[[2]] <- list() 
dist_effects.o[[2]][[1]] <- list() # first source
dist_effects.o[[2]][[1]][[1]] <- c("survival") 
dist_effects.o[[2]][[2]] <- list() # second source
dist_effects.o[[2]][[2]][[1]] <- c("survival")

# disturbance parameters for each orchard subpop
dist_pars.o <- list()

# first orchard treatment
dist_pars.o[[1]] <- list() # first source in first orchard treatment

dist_surv.o <- list()
dist_surv.o[[1]] <- surv_pars.o[[1]][[1]]*0.1 # survival probabilities of corals from first source in first reef subpop in first disturbance year (dist_surv.r[[2]] would be second disturbance)

dist_Tmat.o <- list()
dist_Tmat.o[[1]] <- list() # first disturbance

dist_Fmat.o <- list()
dist_Fmat.o[[1]] <- list() # first disturbance

dist_fec.o <- list()
dist_fec.o[[1]] <- list() # first disturbance

dist_pars.o[[1]][[1]] <- list(dist_surv = dist_surv.o, dist_Tmat = dist_Tmat.o, dist_Fmat = dist_Fmat.o, dist_fec = dist_fec.o) # list of disturbance parameters for the first source in the first orchard treatment
dist_pars.o[[1]][[2]] <- list(dist_surv = dist_surv.o, dist_Tmat = dist_Tmat.o, dist_Fmat = dist_Fmat.o, dist_fec = dist_fec.o) # second source

# second orchard treatment
dist_pars.o[[2]] <- list() # first source in first reef subpop

dist_surv.o <- list()
dist_surv.o[[1]] <- surv_pars.o[[1]][[1]]*0.1 # survival probabilities of corals from first source in first reef subpop in first disturbance year (dist_surv.r[[2]] would be second disturbance)

dist_Tmat.o <- list()
dist_Tmat.o[[1]] <- list() # first disturbance

dist_Fmat.o <- list()
dist_Fmat.o[[1]] <- list() # first disturbance

dist_fec.o <- list()
dist_fec.o[[1]] <- list() # first disturbance

dist_pars.o[[2]][[1]] <- list(dist_surv = dist_surv.o, dist_Tmat = dist_Tmat.o, dist_Fmat = dist_Fmat.o, dist_fec = dist_fec.o) # list of disturbance parameters for the first source in the second orchard treatment
dist_pars.o[[2]][[2]] <- list(dist_surv = dist_surv.o, dist_Tmat = dist_Tmat.o, dist_Fmat = dist_Fmat.o, dist_fec = dist_fec.o) # second source


# lab parameters
s0 <- c(0.9, 0.9) # fraction of settled larvae in each lab treatment that survive to 2wk outplanting
s1 <- c(0.9, 0.9) # fraction of settled larvae in each lab treatment that survive to 1 yr outplanting
sett_props <- list(T1 = 0.5, T2 = 0.5) # proportion of larvae that settle on each tile type
size_props <- matrix(NA, nrow = length(lab_treatments), ncol = n) # matrix for fractions of retained recruits in each size class at the end of their year in the lab
size_props[1, ] <- c(1, 0, 0, 0, 0) # first lab treatment
size_props[2, ] <- c(0.2, 0.8, 0, 0, 0) # second lab treatment
#lab_pars <- list(sett = sett, s = s, n_retain = n_retain, size_props = size_props)
lab_pars <- list(s0 = s0, s1 = s1, sett_props = sett_props, size_props = size_props)



# restoration strategy parameters
orchard_yield <- 0 # percent of new orchard babies successfully collected
reef_yield <- 0.1 # percent of new reef babies successfully collected
#lab_props <- c(0.5, 0.5) # proportion of new babies put in each lab treatment
reef_prop <- c(0.5, 0.5) # proportion of lab recruits from each lab treatment outplanted to reef (1-proportion outplanted to orchard)
reef_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(reef_treatments)) # proportion recruits going from each lab treatment to each reef treatment (row = origin lab treatment, column = destination reef treatment)
reef_out_props[1,] <- c(0, 0.5, 0.5) # from first lab treatment to each reef treatment (note the "none" reef treatment shouldn't get any outplants)
reef_out_props[2,] <- c(0, 0.5, 0.5) # from second lab treatment to each reef treatment (note the "none" reef treatment shouldn't get any outplants)

orchard_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(orchard_treatments)) # proportion recruits going from each lab treatment to each orchard treatment
orchard_out_props[1,] <- c(0.5, 0.5) # from first lab treatment to each orchard treatment
orchard_out_props[2,] <- c(0.5, 0.5) # from second lab treatment to each orchard treatment

# sizes allocated to each treatment
reef_areas <- c(100, 100, 100)*10000 # m^2 given to each reef treatment (make sure to include none -- sum of reef_areas should be size of reef), convert to cm^2
lab_max <- c(5000) # total number of settlers that the lab can accommodate
lab_retain_max <- c(0) # total number of settlers that the lab can keep for a year
orchard_size <- c(11, 200) # number of individuals each orchard treatment has space for


# coral transplanting
transplant <- rep(0, years)
transplant[10] <- 1 # in 10th year, move corals from orchard to reef

# rest_pars$trans_mats[[ss]][[rr]][i,]
null_mat <- matrix(0, nrow = years, ncol = n)
trans_mats <- list()
trans_mats[[1]] <- list() # first treatment
trans_mats[[1]][[1]] <- null_mat
trans_mats[[1]][[1]][which(transplant!=0)[1],] <- c(0, 0, 0, 2,0)# number of colonies of each size class to move to reef in first transplant event
trans_mats[[1]][[2]] <- null_mat # second source

trans_mats[[2]] <- list() # second treatment
trans_mats[[2]][[1]] <- null_mat # first source
trans_mats[[2]][[2]] <- null_mat # second source

#rest_pars$trans_reef[[ss]][[rr]][i,1]
trans_reef <- list()
null_mat2 <- matrix(1, nrow = years, ncol = 2)
trans_reef[[1]] <- list() # first treatment
trans_reef[[1]][[1]] <- null_mat2
trans_reef[[1]][[1]][which(transplant!=0)[1],] <- c(2, 1)# reef area and subpopulation to transport the corals to
trans_reef[[1]][[2]] <- null_mat2 # second source

trans_reef[[2]] <- list() # second treatment
trans_reef[[2]][[1]] <- null_mat2# first source
trans_reef[[2]][[2]] <- null_mat2 # second source

rest_pars <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)



sim1 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars, N0.r, N0.o, N0.l)

```


```{r}
apply(sim1$reef_pops[[2]][[1]], MARGIN = 2, sum)[years] 
apply(sim1$reef_pops[[2]][[2]], MARGIN = 2, sum)[years] 

```

```{r}
apply(sim1$reef_pops[[2]][[1]], MARGIN = 2, sum)[years] 
apply(sim1$reef_pops[[2]][[2]], MARGIN = 2, sum)[years] 

```


plot results

```{r}


reef1_tot <- apply(sim1$reef_pops[[1]][[1]], MARGIN = 2, sum) 
reef2_tot <- apply(sim1$reef_pops[[2]][[1]], MARGIN = 2, sum) + apply(sim1$reef_pops[[2]][[2]], MARGIN = 2, sum) + apply(sim1$reef_pops[[2]][[3]], MARGIN = 2, sum)
reef3_tot <- apply(sim1$reef_pops[[3]][[1]], MARGIN = 2, sum) + apply(sim1$reef_pops[[3]][[2]], MARGIN = 2, sum) + apply(sim1$reef_pops[[3]][[3]], MARGIN = 2, sum)


orch1_tot <- apply(sim1$orchard_pops[[1]][[1]], MARGIN = 2, sum) + apply(sim1$orchard_pops[[1]][[2]], MARGIN = 2, sum)
orch2_tot <- apply(sim1$orchard_pops[[2]][[1]], MARGIN = 2, sum) + apply(sim1$orchard_pops[[2]][[2]], MARGIN = 2, sum)


plot(x = c(1:years), y = reef1_tot, type = "l", las = 1, ylim = c(0, max(reef1_tot, reef2_tot, reef3_tot, orch1_tot, orch2_tot)), xlab = "year", ylab = "Pop'n size", lwd = 2)
lines(x = c(1:years), y = reef2_tot, type = "l", lwd = 2, lty = 2)
lines(x = c(1:years), y = reef3_tot, type = "l", lwd = 3, lty = 3)
lines(x = c(1:years), y = orch1_tot, type = "l", col = "dodgerblue", lwd = 2, lty = 1)
lines(x = c(1:years), y = orch2_tot, type = "l", col = "dodgerblue", lwd = 3, lty = 2)
legend("topleft", legend = c("reef", "orchard"), col = c("black", "dodgerblue"), lwd = 2, lty = c(1, 1))

```


```{r}

plot(x = c(1:years), y = sim1$orchard_pops[[1]][[1]][1,], type = "l", las = 1, ylim = c(-1,5))
lines(x = c(1:years), y = sim1$orchard_pops[[1]][[1]][2,], type = "l", lty = 2)
lines(x = c(1:years), y = sim1$orchard_pops[[1]][[1]][3,], type = "l", lty = 3)
lines(x = c(1:years), y = sim1$orchard_pops[[1]][[1]][4,], type = "l", lty = 4)
lines(x = c(1:years), y = sim1$orchard_pops[[1]][[1]][5,], type = "l", lty = 5)

```




TO DO:


1) DONE: max areas: something controlling the sizes of all the subpopulations? Do I want each to have a carrying capacity? And based on area or individuals (scrub x m^2 of reef or scrub x individuals)? Tricky thing is that the area will apply only to the reef subpopulations, so when outplanting individuals from each lab subpop they will be grouped by reef subpop. Also orchard probably wouldn't be area, instead it would be "orchard units" (e.g., reef stars)

2) DONE: disturbance

3) density dependent growth/survival?

4) costs for each treatment effort














---
title: "rse_scenario_analysis"
author: "Raine Detmer"
date: "2025-07-11"
output: html_document
---

README: trying out some initial scenario analyses


-- use a matrix from a growing population for the reference site and a matrix from a declining population for the intervention and control sites?
-- and repeat simulations for different mortality parameters for the first size class (e.g., shouldn't matter if they have the same mortality rates). Maybe start with values from that Chamberland paper?

-- start with no external recruitment?

NOTE: should make a function that summarizes model outputs

then repeat with disturbances? (and remember to use new disturbance function for generating disturbance parameters)



from Fundemar data
-- use 0.01 for survival of first size class/newly outplanted recruits

--estimates of number of eggs from colonies (but don't know colony sizes): min = ~5200, 25% quantile = ~30000, 50% = ~93000, 75% = ~100000, max = ~140000, mean = ~72000



load the functions

```{r}

source("coral_demographic_funs.R")
source("rse_funs.R")
```


```{r}
# matrices from Vardi et al 2012
# first year (growing pop'n)
col1 <- c(0.6, 0.15, 0.01, 0)/sum(0.6, 0.15, 0.01, 0)
col2 <- c(0.07, 0.69, 0.11, 0)/sum(0.07, 0.69, 0.11, 0)
col3 <- c(0, 0.1, 0.74, 0.11)/sum(0, 0.1, 0.74, 0.11)
col4 <- c(0, 0.06, 0.11, 0.83)/sum(0, 0.06, 0.11, 0.83)

sum(col1)
sum(col2)
sum(col3)
sum(col4)

#list(col1[2:4], col2[3:4], col3[4], NULL) # growth parameters
#list(NULL, col2[1], col3[1:2], col4[1:3]) # shrinkage

# second year (declining population)
col1 <- c(0.44, 0, 0, 0)/sum(0.44, 0, 0, 0)
col2 <- c(0.14, 0.37, 0.02, 0)/sum(0.14, 0.37, 0.02, 0)
col3 <- c(0.08, 0.19, 0.43, 0)/sum(0.08, 0.19, 0.43, 0)
col4 <- c(0, 0, 0.13, 0.71)/sum(0, 0, 0.13, 0.71)

sum(col1)
sum(col2)
sum(col3)
sum(col4)

list(col1[2:4], col2[3:4], col3[4], NULL) # growth parameters
list(NULL, col2[1], col3[1:2], col4[1:3]) # shrinkage

```


reef areas

from the kml file:
-- 1.11 ac = 4492.011 m2
-- 2.49 ac = 10076.67 m2
-- 2.21 ac = 8943.55 m2

```{r}

A_reef <- mean(c(4492.011, 10076.67, 8943.55))

```




# Scenario 1: tile types

function relating total invested to lab_max

```{r}

# assume each tile can hold a max of 10 settlers, and ceramic are $2 each and cement are $1 each

# $200 = $100 ceramic or $200 cement

# inv_tot = total money invested
# prop_ceramic = proportion tiles that are ceramic
# p_ceramic = price per ceramic tile
# p_cement = price per cement tile
lab_max_fun <- function(inv_tot, prop_tiles, p_ceramic, p_cement, sett_per_tile){
  
  # get number of tiles
  # inv_tot = p_ceramic*prop_tiles*x + p_cement*(1-prop_tiles)*x
  # inv_tot = a*x + b*x = (a+b)*x
  # x = (inv_tot)/(a + b)
  
  n_tiles <- floor(inv_tot/(p_ceramic*prop_tiles + p_cement*(1-prop_tiles)))
  
  lab_max <- n_tiles*sett_per_tile
  
  return(lab_max)
    
}

# lab_max_fun(inv_tot = 20, prop_tiles = 0.25, p_ceramic = 2, p_cement = 1, sett_per_tile = 10)/10
# 
# 16*0.25*2 + 16*0.75*1

# p_ceramic = 2, p_cement = 1, sett_per_tile = 10

# reverse: inv_tot from lab max
# n_tiles = lab_max/sett_per_tile
# inv_tot = (p_ceramic*prop_tiles + p_cement*(1-prop_tiles))*lab_max/sett_per_tile

```



```{r}

years <- 20
n <- 5

A_mids <- c(0.1, 43, 369, 2158, 11171) # mean areas in each size class (cm^2)


orchard_treatments <- c("none", "algae") # two orchards
reef_treatments <- c("none", "intervention") # reef (natural population and intervention site; note don't have a "control" because just include that as one of the simulations)
lab_treatments <- c("0_T1", "0_T2") # lab (cement = T1, ceramic = T2)

# thought: make reference reef population constant by using non-zero initial conditions and no growth and 100% survival

# demographic parameters for each orchard and reef treatment
# reef parameters: survival
surv_pars.r <- list()
surv_pars.r[[1]] <- list() # first reef subpop (reference reef) 
#surv_pars.r[[1]][[1]] <- c(0.010, 0.760, 0.870, 0.950, 0.999) # survival probabilities for first source of recruits to first reef (external recruits); from 1st matrix in Vardi et al. 2012
surv_pars.r[[1]][[1]] <- c(1, 1, 1, 1, 1) # for constant pop'n
surv_pars.r[[2]] <- list() # second reef subpop (intervention reef)
surv_pars.r[[2]][[1]] <- c(0.010, 0.44, 0.53, 0.70, 0.84) # survival probabilities for first source of recruits to second reef subpop (external recruits); from 2nd matrix in Vardi et al. 2012
surv_pars.r[[2]][[2]] <- c(0.005, 0.44, 0.53, 0.70, 0.84) # survival probabilities for second source of recruits to second reef subpop (first lab treatment)
surv_pars.r[[2]][[3]] <- c(0.1, 0.44, 0.53, 0.70, 0.84) # survival probabilities for third source of recruits to second reef subpop (second lab treatment)

# reef parameters: growth
growth_pars.r <- list()
growth_pars.r[[1]] <- list() # first reef subpop
#growth_pars.r[[1]][[1]] <- list(c(0.5, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) # first source to first reef subpop (external recruits)
growth_pars.r[[1]][[1]] <- list(c(0, 0, 0, 0), c(0, 0, 0), c(0, 0), 0, NULL) # for constant population

growth_pars.r[[2]] <- list() # second reef subpop (intervention)
#growth_pars.r[[2]][[1]] <- list(c(0.2, 0, 0, 0), c(0, 0, 0), c(0.038, 0), 0, NULL) # first source (ext recruits)

# UPDATE: let them grow a little (otherwise nothing ever gets past the 2nd stage) so use the values from the first Varid et al matrix
growth_pars.r[[2]][[1]] <- list(c(0.5, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) 
growth_pars.r[[2]][[2]] <- growth_pars.r[[2]][[1]] # second source (first lab treatment)
growth_pars.r[[2]][[3]] <- growth_pars.r[[2]][[1]] # third source (third lab treatment)

# reef parameters: shrinkage
shrink_pars.r <- list()
shrink_pars.r[[1]] <- list() # first subpop
# shrink_pars.r[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.08), c(0, 0, 0.105), c(0, 0, 0.06, 0.11)) # first source
shrink_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0)) # constant population

shrink_pars.r[[2]] <- list() # second subpop
shrink_pars.r[[2]][[1]] <- list(NULL, c(0.01), c(0, 0.026), c(0, 0.11, 0.27), c(0, 0, 0, 0.15)) # first source 
shrink_pars.r[[2]][[2]] <- shrink_pars.r[[2]][[1]] # second source
shrink_pars.r[[2]][[3]] <- shrink_pars.r[[2]][[1]] # third source

# reef parameters: fragmentation
frag_pars.r <- list()
frag_pars.r[[1]] <- list() # first subpop
#frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.06, 0.06), c(0, 0.28, 0.3, 0.23)) # first source
frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0)) # constant population

frag_pars.r[[2]] <- list() # second subpop
frag_pars.r[[2]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.06, 0.06), c(0, 0.28, 0.3, 0.23)) # first source # first source
#frag_pars.r[[2]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.03, 0.03), c(0, 0.19, 0.16, 0)) # first source
frag_pars.r[[2]][[2]] <- frag_pars.r[[2]][[1]] # second source
frag_pars.r[[2]][[3]] <- frag_pars.r[[2]][[1]] # third source

# reef parameters: fecundity
fec_pars.r <- list()
fec_pars.r[[1]] <- list() # first subpop
fec_pars.r[[1]][[1]] <- c(0, 0, 5000, 50000, 100000) # first source

fec_pars.r[[2]] <- list()
fec_pars.r[[2]][[1]] <- fec_pars.r[[1]][[1]]
fec_pars.r[[2]][[2]] <- fec_pars.r[[1]][[1]]
fec_pars.r[[2]][[3]] <- fec_pars.r[[1]][[1]]

# orchard parameters: survival
surv_pars.o <- list()
surv_pars.o[[1]] <- list() # first treatment
surv_pars.o[[1]][[1]] <- 1- c(0.999, 0.24, 0.13, 0.05, 0.001) # first source (first lab treatment)
surv_pars.o[[1]][[2]] <- surv_pars.o[[1]][[1]] # second source (second lab treatment)

surv_pars.o[[2]] <- list() # second treatment
surv_pars.o[[2]][[1]] <- surv_pars.o[[1]][[1]] # first source (first lab treatment)
surv_pars.o[[2]][[2]] <- surv_pars.o[[1]][[1]] # second source (second lab treatment)

# orchard parameters: growth
growth_pars.o <- list()
growth_pars.o[[1]] <- list() # first treatment
growth_pars.o[[1]][[1]] <- list(c(0.85, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) # first source
growth_pars.o[[1]][[2]] <- growth_pars.o[[1]][[1]] # second source

growth_pars.o[[2]] <- list() # second treatment
growth_pars.o[[2]][[1]] <-growth_pars.o[[1]][[1]] # first source
growth_pars.o[[2]][[2]] <- growth_pars.o[[1]][[1]] # second source

# orchard parameters: shrinkage
shrink_pars.o <- list()
shrink_pars.o[[1]] <- list() # first treatment
shrink_pars.o[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.08), c(0, 0, 0.105), c(0, 0, 0.06, 0.11)) # first source
shrink_pars.o[[1]][[2]] <- shrink_pars.o[[1]][[1]] # second source

shrink_pars.o[[2]] <- list() # second treatment
shrink_pars.o[[2]][[1]] <- shrink_pars.o[[1]][[1]] # first source
shrink_pars.o[[2]][[2]] <- shrink_pars.o[[1]][[1]] # second source

# orchard parameters: fragmentation
frag_pars.o <- list()
frag_pars.o[[1]] <- list() # first treatment
frag_pars.o[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0)) # first source
frag_pars.o[[1]][[2]] <- frag_pars.o[[1]][[1]] # second source

frag_pars.o[[2]] <- list() # second treatment
frag_pars.o[[2]][[1]] <- frag_pars.o[[1]][[1]] # first source
frag_pars.o[[2]][[2]] <- frag_pars.o[[1]][[1]] # second source

fec_pars.o <- list()
fec_pars.o[[1]] <- list() # first treatment
fec_pars.o[[1]][[1]] <- c(0, 0, 0.1, 1, 2) # first source
fec_pars.o[[1]][[2]] <- fec_pars.o[[1]][[1]] # second source

fec_pars.o[[2]] <- list() # second treatment
fec_pars.o[[2]][[1]] <- c(0, 0, 0.1, 1, 2) # first source
fec_pars.o[[2]][[2]] <- fec_pars.o[[1]][[1]] # second source

lambda <- 0 # external recruitment to reef

# stochasticity parameters
sigma_s <- 0
sigma_f <- 0
ext_rand <- FALSE
seeds <- c(1000, 5000, 10000)

# initial conditions in each reef subpopulation
N0.r <- list()
N0.r[[1]] <- list() # first reef subpop
#N0.r[[1]][[1]] <- c(10, 20, 20, 15, 5) # first source in first reef subpop (reference reef)
N0.r[[1]][[1]] <- c(10, 20, 20, 35, 15)
N0.r[[2]] <- list() # second reef subpop
N0.r[[2]][[1]] <- rep(0, n) # first source
N0.r[[2]][[2]] <- rep(0, n) # second source
N0.r[[2]][[3]] <- rep(0, n) # third source

# intial conditions in each orchard subpopulation
N0.o <- list()
N0.o[[1]] <- list() # first orchard treatment
N0.o[[1]][[1]] <- rep(0, n) # first source
N0.o[[1]][[2]] <- rep(0, n) # second source
N0.o[[2]] <- list() # second orchard treatment
N0.o[[2]][[1]] <- rep(0, n) # first source
N0.o[[2]][[2]] <- rep(0, n) # second source

N0.l <- list()
N0.l[[1]] <- 0
N0.l[[2]] <- 0


# disturbance parameters
dist_yrs <- c(years + 10) # years when disturbance occurs, NA if none

# effects of disturbance on each reef subpop
dist_effects.r <- list()
dist_effects.r[[1]] <- list() # list where each element is the effects of disturbnce on corals from each source in the 1st reef subpop
dist_effects.r[[1]][[1]] <- list() # effects of disturbances on corals from first source in first reef subpop
dist_effects.r[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)

# second reef subpop
dist_effects.r[[2]] <- list() 
dist_effects.r[[2]][[1]] <- list() # first source
dist_effects.r[[2]][[1]][[1]] <- c("survival")
dist_effects.r[[2]][[2]] <- list() # second source
dist_effects.r[[2]][[2]][[1]] <- c("survival")
dist_effects.r[[2]][[3]] <- list() # third source
dist_effects.r[[2]][[3]][[1]] <- c("survival")


# disturbance parameters for each reef subpop
dist_pars.r <- list()

# first reef subpop
dist_pars.r[[1]] <- list() # first source in first reef subpop
dist_pars.r[[1]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[1]][[1]], dist_surv0 = list(surv_pars.r[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) # list of disturbance parameters for the third source in the third reef population (defaults for each parameter type are NULL unless the disturbance affects them, as specified in dist_effects)
# dist_surv0 = list where ith element is the survival probabilities for the ith disturbance

# second reef subpop
dist_pars.r[[2]] <- list() 
# first source to second reef subpop
dist_pars.r[[2]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[2]][[1]], dist_surv0 = list(surv_pars.r[[2]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)
# second source to second reef subpop
dist_pars.r[[2]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[2]][[2]], dist_surv0 = list(surv_pars.r[[2]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)
# third source to second reef subpop
dist_pars.r[[2]][[3]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[2]][[3]], dist_surv0 = list(surv_pars.r[[2]][[3]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)

# disturbance effects for each orchard subpop
dist_effects.o <- list()

dist_effects.o[[1]] <- list() # list where each element is the effects of disturbnce on corals from each source in the 1st orchard treatment
dist_effects.o[[1]][[1]] <- list() # effects of disturbances on corals from first source in first orchard treatment
dist_effects.o[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)
dist_effects.o[[1]][[2]] <- list() # second source
dist_effects.o[[1]][[2]][[1]] <- c("survival")

# second orchard treatment
dist_effects.o[[2]] <- list() 
dist_effects.o[[2]][[1]] <- list() # first source
dist_effects.o[[2]][[1]][[1]] <- c("survival") 
dist_effects.o[[2]][[2]] <- list() # second source
dist_effects.o[[2]][[2]][[1]] <- c("survival")

# disturbance parameters for each orchard subpop
dist_pars.o <- list()

# first orchard treatment
dist_pars.o[[1]] <- list() 
# first source in first orchard treatment
dist_pars.o[[1]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[1]][[1]], dist_surv0 = list(surv_pars.o[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) 
# second source in first orchard treatment
dist_pars.o[[1]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[1]][[2]], dist_surv0 = list(surv_pars.o[[1]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)

# second orchard treatment
dist_pars.o[[2]] <- list() 
# first source in second orchard treatment
dist_pars.o[[2]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[2]][[1]], dist_surv0 = list(surv_pars.o[[2]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) 
# second source in second orchard treatment
dist_pars.o[[2]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[2]][[2]], dist_surv0 = list(surv_pars.o[[2]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)


# lab parameters
s0 <- c(0.9, 0.9) # fraction of settled larvae in each lab treatment that survive to 2wk outplanting
s1 <- c(0.7, 0.7) # fraction of settled larvae in each lab treatment that survive to 1 yr outplanting
sett_props <- list(T1 = 0.5, T2 = 0.5) # proportion of larvae that settle on each tile type
size_props <- matrix(NA, nrow = length(lab_treatments), ncol = n) # matrix for fractions of retained recruits in each size class at the end of their year in the lab
size_props[1, ] <- c(1, 0, 0, 0, 0) # first lab treatment (0_T1)
size_props[2, ] <- c(1, 0, 0, 0, 0) # second lab treatment (0_T2)
lab_pars <- list(s0 = s0, s1 = s1, sett_props = sett_props, size_props = size_props)



# restoration strategy parameters
orchard_yield <- 0 # percent of new orchard babies successfully collected
reef_yield <- 0.001 # percent of new reef babies successfully collected and fertilized
reef_prop <- c(1, 1) # proportion of lab recruits from each lab treatment outplanted to reef (1-proportion outplanted to orchard)
reef_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(reef_treatments)) # proportion recruits going from each lab treatment to each reef treatment (row = origin lab treatment, column = destination reef treatment)
reef_out_props[1,] <- c(0, 1) # from first lab treatment to each reef treatment (note the "none" reef treatment shouldn't get any outplants)
reef_out_props[2,] <- c(0, 1) # from second lab treatment to each reef treatment (note the "none" reef treatment shouldn't get any outplants)

orchard_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(orchard_treatments)) # proportion recruits going from each lab treatment to each orchard treatment
orchard_out_props[1,] <- c(0.5, 0.5) # from first lab treatment to each orchard treatment
orchard_out_props[2,] <- c(0.5, 0.5) # from second lab treatment to each orchard treatment

# sizes allocated to each treatment
reef_areas <- c(A_reef/2, A_reef/2)*10000 # m^2 given to each post-outplanting reef treatment (make sure to include "none" and the external recruit source; sum of reef_areas should be size of reef), convert to cm^2 by multiplying by 10,000
lab_max <- c(2500) # total number of settlers that the lab can accommodate
lab_retain_max <- c(1200) # total number of settlers that the lab can keep for a year
orchard_size <- c(200, 200) # number of individuals each orchard treatment has space for

# coral transplanting
transplant <- rep(0, years)
#transplant[10] <- 1 # in 10th year, move corals from orchard to reef

# rest_pars$trans_mats[[ss]][[rr]][i,]
null_mat <- matrix(0, nrow = years, ncol = n)
trans_mats <- list()
trans_mats[[1]] <- list() # first treatment
trans_mats[[1]][[1]] <- null_mat
#trans_mats[[1]][[1]][which(transplant!=0)[1],] <- c(0, 0, 0, 2,0)# number of colonies of each size class to move to reef in first transplant event
trans_mats[[1]][[2]] <- null_mat # second source

trans_mats[[2]] <- list() # second treatment
trans_mats[[2]][[1]] <- null_mat # first source
trans_mats[[2]][[2]] <- null_mat # second source

#rest_pars$trans_reef[[ss]][[rr]][i,1]
trans_reef <- list()
null_mat2 <- matrix(1, nrow = years, ncol = 2)
trans_reef[[1]] <- list() # first treatment
trans_reef[[1]][[1]] <- null_mat2
#trans_reef[[1]][[1]][which(transplant!=0)[1],] <- c(2, 1)# reef area and subpopulation to transport the corals to
trans_reef[[1]][[2]] <- null_mat2 # second source

trans_reef[[2]] <- list() # second treatment
trans_reef[[2]][[1]] <- null_mat2# first source
trans_reef[[2]][[2]] <- null_mat2 # second source

rest_pars <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)


sim1 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars, N0.r, N0.o, N0.l)

```




```{r}

# plot results

#reef1_tot <- apply(sim1$reef_pops[[1]][[1]], MARGIN = 2, sum) 
#reef2_tot <- apply(sim1$reef_pops[[2]][[1]], MARGIN = 2, sum) + apply(sim1$reef_pops[[2]][[2]], MARGIN = 2, sum) + apply(sim1$reef_pops[[2]][[3]], MARGIN = 2, sum)

reef1_tot <- apply(sim1$reef_pops_pre[[1]][[1]], MARGIN = 2, sum) 
reef2_tot <- apply(sim1$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(sim1$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) + apply(sim1$reef_pops_pre[[2]][[3]], MARGIN = 2, sum)

orch1_tot <- apply(sim1$orchard_pops[[1]][[1]], MARGIN = 2, sum) + apply(sim1$orchard_pops[[1]][[2]], MARGIN = 2, sum)
orch2_tot <- apply(sim1$orchard_pops[[2]][[1]], MARGIN = 2, sum) + apply(sim1$orchard_pops[[2]][[2]], MARGIN = 2, sum)


plot(x = c(1:years), y = reef1_tot, type = "l", las = 1, ylim = c(0, max(reef1_tot, reef2_tot, orch1_tot, orch2_tot)), xlab = "year", ylab = "Pop'n size", lwd = 2)
lines(x = c(1:years), y = reef2_tot, type = "l", lwd = 2, lty = 2)
lines(x = c(1:years), y = orch1_tot, type = "l", col = "dodgerblue", lwd = 2, lty = 1)
lines(x = c(1:years), y = orch2_tot, type = "l", col = "dodgerblue", lwd = 3, lty = 2)
legend("topleft", legend = c("reef", "orchard"), col = c("black", "dodgerblue"), lwd = 2, lty = c(1, 1))


# check numbers being outplanted
reef2_out_tot <- sim1$reef_out[[2]][[2]] + sim1$reef_out[[2]][[3]]

#reef2_out_tot

```


if there were 100 tiles with 50 of each type and larvae had no preference, then you would have 0.5/0.5

total "area" is 100, prop of tile 1 is 0.5, but then that get's modified by larval preference: subtract x from tile 1 and add it to the other?

sett_props consists of 1) proportion of tiles that are T1 or T2 and 2) larval preferences for the different tiles. ALSO need a proportion that don't settle, with the idea that if they can't find a place that they like then they don't settle?

or even simpler: assume they don't have a choice, and just have fractions that settle to each (e.g., 90% of the larvae offered cement settle on it, and 25% of the larvae offered ceramic settle on it)


## basic timeseries


100% ceramic, 0% ceramic, and 50%

```{r}

sett_props.100 <- list(T1 = 0, T2 = 1) # proportion of larvae that settle on each tile type
lab_pars.100 <- list(s0 = s0, s1 = s1, sett_props = sett_props.100, size_props = size_props)


T2_100 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars.100, rest_pars, N0.r, N0.o, N0.l)

sett_props.50 <- list(T1 = 0.5, T2 = 0.5) # proportion of larvae that settle on each tile type
lab_pars.50 <- list(s0 = s0, s1 = s1, sett_props = sett_props.50, size_props = size_props)

T2_50 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars.50, rest_pars, N0.r, N0.o, N0.l)

sett_props.0 <- list(T1 = 1, T2 = 0) # proportion of larvae that settle on each tile type
lab_pars.0 <- list(s0 = s0, s1 = s1, sett_props = sett_props.0, size_props = size_props)

T2_0 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars.0, rest_pars, N0.r, N0.o, N0.l)

reef_100 <- apply(T2_100$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(T2_100$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) + apply(T2_100$reef_pops_pre[[2]][[3]], MARGIN = 2, sum)

reef_50 <- apply(T2_50$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(T2_50$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) + apply(T2_50$reef_pops_pre[[2]][[3]], MARGIN = 2, sum)

reef_0 <- apply(T2_0$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(T2_0$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) + apply(T2_0$reef_pops_pre[[2]][[3]], MARGIN = 2, sum)

plot(x = c(1:years), y = reef_100, type = "l", las = 1)
lines(x = c(1:years), y = reef_50, type = "l")
lines(x = c(1:years), y = reef_0, type = "l")

# plot cover (m2) instead

reef_100p <- rep(NA, years)

for(i in 1:years){
  
  reef_100p[i] <- (sum(T2_100$reef_pops_pre[[2]][[1]][,i]*A_mids) + sum(T2_100$reef_pops_pre[[2]][[2]][,i]*A_mids) + sum(T2_100$reef_pops_pre[[2]][[3]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}

reef_0p <- rep(NA, years)

for(i in 1:years){
  
  reef_0p[i] <- (sum(T2_0$reef_pops_pre[[2]][[1]][,i]*A_mids) + sum(T2_0$reef_pops_pre[[2]][[2]][,i]*A_mids) + sum(T2_0$reef_pops_pre[[2]][[3]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}

reef_50p <- rep(NA, years)

for(i in 1:years){
  
  reef_50p[i] <- (sum(T2_50$reef_pops_pre[[2]][[1]][,i]*A_mids) + sum(T2_50$reef_pops_pre[[2]][[2]][,i]*A_mids) + sum(T2_50$reef_pops_pre[[2]][[3]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}


col_set <- c("orchid", "darkorange", "lightgreen")

# calculate cost per year: 
# inv_tot = (p_ceramic*prop_tiles + p_cement*(1-prop_tiles))*lab_max/sett_per_tile
tot_100 <- (2*1 + 1*(1-1))*lab_max/10 # *years
tot_50 <- (2*0.5 + 1*(1-0.5))*lab_max/10
tot_0 <- (2*0 + 1*(1-0))*lab_max/10

plot(x = c(1:years), y = reef_100p, type = "l", las = 1, col = col_set[1], lwd = 2, xlab = NA, ylab = NA)
mtext(side = 1, "Time (years)", line = 2, cex = 1.1)
mtext(side = 2, expression("Coral Cover ("*m^2*")"), line = 1.75, cex = 1.1)
text(x = years-1, y = max(reef_100p)-0.5, paste("$", as.character(tot_100), "/year", sep = ""), col = col_set[1])
text(x = years-1, y = max(reef_50p)-0.5, paste("$", as.character(tot_50), "/year", sep = ""), col = col_set[2])
text(x = years-1, y = max(reef_0p) + 0.25, paste("$", as.character(tot_0), "/year", sep = ""), col = col_set[3])
lines(x = c(1:years), y = reef_50p, type = "l", col = col_set[2], lwd = 2)
lines(x = c(1:years), y = reef_0p, type = "l", col = col_set[3], lwd = 2)
legend("topleft", legend = c("100% ceramic", "[user choice]", "0 % ceramic"), lwd = 2, col = col_set, bty = "n")



```

NOTE: ADD number of tiles as another slider bar on the scenario 1 GUI (here this is lab_max/10 = 250 tiles per year)

## heatmap

proportion tiles and total invested in tiles




```{r}

inv_set <- seq(from = 20, to = 500, by = 20)
prop_set <- seq(from = 0, to = 1, length.out = 25)

pop_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))
#pcover_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))
area_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))

for(i in 1:length(inv_set)){
  
  for(j in 1:length(prop_set)){
    
    lab_max.ij <- lab_max_fun(inv_tot = inv_set[i], prop_tiles = prop_set[j], p_ceramic = 2, p_cement = 1, sett_per_tile = 10)
    
    sett_props.ij <- list(T1 = 1-prop_set[j], T2 = prop_set[j]) 
lab_pars.ij <- list(s0 = s0, s1 = s1, sett_props = sett_props.ij, size_props = size_props)
    
rest_pars.ij <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max.ij, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

  sim.ij <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars.ij, rest_pars.ij, N0.r, N0.o, N0.l)
    
  
  # record final population size
  pop_mat[i,j] <- sum(sim.ij$reef_pops_pre[[2]][[1]][,years]) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]) 
  
  # record area covered
  area_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[2]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]*A_mids))/10000
  
  # record final % cover
  #pcover_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[2]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]*A_mids))/sum(reef_areas)*100
  
  }
}

```


plot results

```{r}

pop_mat_test <- pop_mat

pop_mat_test[nrow(pop_mat),] <- rep(0, nrow(pop_mat))

pop_mat_test[,ncol(pop_mat)] <- rep(200, ncol(pop_mat))

#filled.contour(pop_mat_test) # x = rows, y = columns


# https://www.rdocumentation.org/packages/graphics/versions/3.6.2/topics/filled.contour
# https://www.rdocumentation.org/packages/graphics/versions/3.6.2/topics/contour
#filled.contour(x = inv_set, y = prop_set, z = pop_mat)

#library(RColorBrewer)

#rampcols <- colorRampPalette(colors = c("lightskyblue1", "darkblue"), space="Lab")(25) # 50 colors from white to blue

# more detailed function description:
# https://stat.ethz.ch/R-manual/R-devel/library/graphics/html/filled.contour.html

filled.contour(x = inv_set, y = prop_set, pop_mat, 
               color.palette = function(n) hcl.colors(n, "blues", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = inv_set, y = prop_set, pop_mat, levels = 100, lwd = 2, drawlabels = F, add = T)})
#legend("topleft", "100", lwd = 2, bty = "n")

#  labcex = 1, method = "flattest", vfont = c("sans serif", "plain")

# drawlabels = F

# brewer.pal.info["Blues",]$maxcolors


filled.contour(x = inv_set, y = prop_set, area_mat, key.title = title(main = expression("Cover ("*m^2*")"), cex.main = 0.8, line = 0.5),
               color.palette = function(n) hcl.colors(n, "blues", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = inv_set, y = prop_set, area_mat, levels = 2, lwd = 2, drawlabels = T, add = T, vfont = c("sans serif", "bold"), labcex = 1.1)})
mtext(side = 1, "Annual $ invested in tiles", line = 2.5, adj = 0.25)
mtext(side = 2, "Prop. ceramic", line = 2.5)


# no label
filled.contour(x = inv_set, y = prop_set, area_mat, key.title = title(main = expression("Cover ("*m^2*")"), cex.main = 0.8, line = 0.5),
               color.palette = function(n) hcl.colors(n, "blues", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = inv_set, y = prop_set, area_mat, levels = 2, lwd = 2, drawlabels = F, add = T)})
mtext(side = 1, "Annual $ invested in tiles", line = 2, adj = 0.25, cex = 1.1)
mtext(side = 2, "Prop. ceramic", line = 2.5, cex = 1.1)

# vfont information: https://stat.ethz.ch/R-manual/R-devel/library/grDevices/html/Hershey.html

# main = "Coral cover", sub = expression("("*m^2*")"), cex.main = 0.5, cex.sub = 0.5
```


## initial simulations:

```{r}


# sett_props <- list(T1 = 0.5, T2 = 0.5)
# lab_pars <- list(s0 = s0, s1 = s1, sett_props = sett_props, size_props = size_props)


# started with 0.001 and 0.015

surv_pars.r[[2]][[2]] <- c(0.001, 0.44, 0.53, 0.70, 0.84) # survival probabilities for second source of recruits to second reef subpop (first lab treatment)
surv_pars.r[[2]][[3]] <- c(0.01, 0.44, 0.53, 0.70, 0.84) # survival probabilities for third source of recruits to second reef subpop (second lab treatment)

T1_props <- seq(from = 0, to = 1, length.out = 20) # proportion of tiles that are cement

par_set <- T1_props


# holding matrices reef population size, area, and reproductive output at 5 and 10 years (rows = parameter values, columns = year in simulation)
reef1_pop <- matrix(NA, nrow = length(par_set), ncol = 2)
reef1_area <- matrix(NA, nrow = length(par_set), ncol = 2)
reef1_rep <- matrix(NA, nrow = length(par_set), ncol = 2)

reef2_pop <- matrix(NA, nrow = length(par_set), ncol = 2)
reef2_area <- matrix(NA, nrow = length(par_set), ncol = 2)
reef2_rep <- matrix(NA, nrow = length(par_set), ncol = 2)
reef2_out <- matrix(NA, nrow = length(par_set), ncol = 2)


# or just store the whole time series of all the values? but then each element of the list will be for a different parameter value which makes it tricky to plot...
#reef1_list <- list()
#reef2_list <- list()


for(i in 1:length(par_set)){
  
sett_props.i <- list(T1 = par_set[i]*0.8, T2 = (1-par_set[i])*0.2) # 80% of larvae offered cement settle on it, 20% offered ceramic settle on it
lab_pars.i <- list(s0 = s0, s1 = s1, sett_props = sett_props.i, size_props = size_props)

sim.i <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars.i, rest_pars, N0.r, N0.o, N0.l)
  
# save the results

reef1_pop[i,1] <- sum(sim.i$reef_pops_pre[[1]][[1]][,5])
reef1_area[i,1] <- sum(sim.i$reef_pops_pre[[1]][[1]][,5]*A_mids)
reef1_rep[i,1] <- sum(sim.i$reef_pops_pre[[1]][[1]][,5]*fec_pars.r[[1]][[1]])

reef1_pop[i,2] <- sum(sim.i$reef_pops_pre[[1]][[1]][,10])
reef1_area[i,2] <- sum(sim.i$reef_pops_pre[[1]][[1]][,10]*A_mids)
reef1_rep[i,2] <- sum(sim.i$reef_pops_pre[[1]][[1]][,10]*fec_pars.r[[1]][[1]])


reef2_pop[i,1] <- sum(sim.i$reef_pops_pre[[2]][[1]][,5]) + sum(sim.i$reef_pops_pre[[2]][[2]][,5]) + sum(sim.i$reef_pops_pre[[2]][[3]][,5])

reef2_area[i,1] <- sum(sim.i$reef_pops_pre[[2]][[1]][,5]*A_mids) + sum(sim.i$reef_pops_pre[[2]][[2]][,5]*A_mids) + sum(sim.i$reef_pops_pre[[2]][[3]][,5]*A_mids)

reef2_rep[i,1] <-sum(sim.i$reef_pops_pre[[2]][[1]][,5]*fec_pars.r[[2]][[1]]) + sum(sim.i$reef_pops_pre[[2]][[2]][,5]*fec_pars.r[[2]][[2]]) + sum(sim.i$reef_pops_pre[[2]][[3]][,5]*fec_pars.r[[2]][[3]])

reef2_out[i,1] <- sum(sim.i$reef_out[[2]][[2]][2:5]) + sum(sim.i$reef_out[[2]][[3]][2:5])

  
reef2_pop[i,2] <- sum(sim.i$reef_pops_pre[[2]][[1]][,10]) + sum(sim.i$reef_pops_pre[[2]][[2]][,10]) + sum(sim.i$reef_pops_pre[[2]][[3]][,10])

reef2_area[i,2] <- sum(sim.i$reef_pops_pre[[2]][[1]][,10]*A_mids) + sum(sim.i$reef_pops_pre[[2]][[2]][,10]*A_mids) + sum(sim.i$reef_pops_pre[[2]][[3]][,10]*A_mids)

reef2_rep[i,2] <-sum(sim.i$reef_pops_pre[[2]][[1]][,10]*fec_pars.r[[2]][[1]]) + sum(sim.i$reef_pops_pre[[2]][[2]][,10]*fec_pars.r[[2]][[2]]) + sum(sim.i$reef_pops_pre[[2]][[3]][,10]*fec_pars.r[[2]][[3]])

reef2_out[i,2] <- sum(sim.i$reef_out[[2]][[2]][2:10]) + sum(sim.i$reef_out[[2]][[3]][2:10])



}



```



```{r}

plot(x = T1_props, y = reef2_pop[,1], type = "l", ylim = c(0, 3), las = 1)
lines(x = T1_props, y = reef2_pop[,2], lty = 2)

plot(x = T1_props, y = reef2_out[,1], type = "l", las = 1, ylim = c(0, 4000))
lines(x = T1_props, y = reef2_out[,2], lty = 2)

```



```{r}

#(0.005 - 0.001)/0.001

0.001*5

0.001*2

```


```{r}

# try making a trade-off plot with T1_props on x-axis, number outplanted on y-axis, and point shading = population size

par(mar=c(0, 0, 0, 0), oma = c(4, 4, 4, 0))
plot(NULL, xlim=c(0,1), ylim=c(0,max(reef2_out[,1])), ylab=NA, xlab=NA, las = 1)
#mtext(side = 3, "5x higher survival on ceramic")
mtext(side = 3, "2x higher survival on ceramic")
mtext(side = 1, "Proportion cement tiles", line = 2.5)
mtext(side = 2, "Number outplanted", line = 2.5)
for(i in 1:length(T1_props)){
  points(x = T1_props[i], y = reef2_out[i,1], pch = 16, col = adjustcolor("dodgerblue2", alpha.f = (reef2_pop[i,1]-min(reef2_pop[,1]))/(max(reef2_pop[,1]) - min(reef2_pop[,1]))), cex = 1.5)
  points(x = T1_props[i], y = reef2_out[i,1], pch = 1, col = "dodgerblue2", cex = 1.5)
}

# try plotting number outplanted vs. reef metrics
# plot(NULL, xlim=c(0,max(reef2_out[,1])), ylim=c(0,max(reef2_pop[,1])), ylab="Reef pop'n size", xlab="Number outplanted", las = 1)
# for(i in 1:length(T1_props)){
#   points(x = reef2_out[i,1], y = reef2_pop[i,1], pch = 16, col = adjustcolor("dodgerblue2", alpha.f = (T1_props[i]-min(T1_props))/(max(T1_props) - min(T1_props))), cex = 1.5)
# }


plot(NULL, xlim=c(0,1), ylim=c(0,max(reef2_out[,1])), ylab="Number outplanted", xlab="Prop. cement tiles", las = 1)
for(i in 1:length(T1_props)){
  points(x = T1_props[i], y = reef2_out[i,1], pch = 16, col = adjustcolor("dodgerblue2", alpha.f = (reef2_area[i,1]-min(reef2_area[,1]))/(max(reef2_area[,1]) - min(reef2_area[,1]))), cex = 1.5)
}


# add a legend with a colorbar scale going from min to max values

rampcols <- colorRampPalette(colors = c("gray99", "dodgerblue2"), space="Lab")(50) # 50 colors from blue to white   

# legend
 # set the height and width of the legend rectangle
xl <- 1
yb <- 1
xr <- 1.25
yt <- 2

 plot(NA,type="n",ann=FALSE,xlim=c(1,2),ylim=c(1,2),xaxt="n",yaxt="n",bty="n")
rect(
     xl,
     head(seq(yb,yt,(yt-yb)/50),-1), # the denominator needs to match the length of the color vector rampcols_2
     xr,
     tail(seq(yb,yt,(yt-yb)/50),-1),
     col=rampcols, #colfunc(10)
     border = NA
    )



```

seems to just flip from most coral at lowest prop to most at highest prop depending on how big the differences in mortality are

Maybe a more interesting figure is to vary both settlement rates and mortality and see which combinations result in â€¦ what? Benefits of ceramic? Or for each combination calculate the optimal ratio of ceramic and cement?


```{r}
# how to incorporate costs into a figure?

# assume you have 100 tiles, cement costs $5 and ceramic costs $10 each

tot_costs <- 100*T1_props*5 + 100*(1-T1_props)*15

tot_costs # but remember this is per year so to get total costs over 5 years, need to multiply by 5


plot(x = T1_props, y = tot_costs, type = "l", las = 1)
lines(x = T1_props, y = reef2_pop[,1]*2000, type = "l", lty = 2)

# plot cost per coral and reef population size
par(mar=c(0, 0, 0, 0), oma = c(4, 4, 4, 4))
plot(x = T1_props, y = tot_costs*5/reef2_out[,1], type = "l", las = 1, xaxt = "n", yaxt = "n", ylim = c(0, 30), xlab = NA, ylab = NA, lwd = 2)
mtext(side = 1, "Proportion cement tiles", line = 2.5)
mtext(side = 2, "Cost per coral outplanted", line = 2.5)
mtext(side = 4, "Reef population size", line = 2.75)
axis(side = 1, at = seq(from = 0, to = 1, by = 0.2))
axis(side = 2, at = seq(from = 0, to = 30, by = 5), las = 1)
axis(side = 4, at = seq(from = 0, to = 1.5, by = 0.25)*20, labels = seq(from = 0, to = 1.5, by = 0.25), las = 1)
lines(x = T1_props, y = reef2_pop[,1]*20, type = "l", lty = 2, lwd = 2)
legend(x = "topright", legend = c("cost per coral", "reef pop'n size"), lty = c(1, 2), bty = "n", inset = c(0.05, 0), lwd = 2)

```

NOTE: check the Papke paper for data on growth rates on cement vs. ceramic tiles

# Scenario 2: lab retention times

parameter setup



```{r}

years <- 20
n <- 5

A_mids <- c(0.1, 43, 369, 2158, 11171) # mean areas in each size class (cm^2)


orchard_treatments <- c("none", "algae") # two orchards
reef_treatments <- c("none", "intervention") # reef (natural population and intervention site; note don't have a "control" because just include that as one of the simulations)
lab_treatments <- c("0_T1", "1_T1") # lab (outplant immediately or retain for a year)


# demographic parameters for each orchard and reef treatment
# reef parameters: survival
surv_pars.r <- list()
surv_pars.r[[1]] <- list() # first reef subpop (reference reef) 
#surv_pars.r[[1]][[1]] <- c(0.010, 0.760, 0.870, 0.950, 0.999) # survival probabilities for first source of recruits to first reef (external recruits); from 1st matrix in Vardi et al. 2012
surv_pars.r[[1]][[1]] <- c(1, 1, 1, 1, 1) # for constant pop'n
surv_pars.r[[2]] <- list() # second reef subpop (intervention reef)
surv_pars.r[[2]][[1]] <- c(0.010, 0.44, 0.53, 0.70, 0.84) # survival probabilities for first source of recruits to second reef subpop (external recruits); from 2nd matrix in Vardi et al. 2012
surv_pars.r[[2]][[2]] <- c(0.01, 0.44, 0.53, 0.70, 0.84) # survival probabilities for second source of recruits to second reef subpop (first lab treatment)
surv_pars.r[[2]][[3]] <- c(0.01, 0.44, 0.53, 0.70, 0.84) # survival probabilities for third source of recruits to second reef subpop (second lab treatment)

# reef parameters: growth
growth_pars.r <- list()
growth_pars.r[[1]] <- list() # first reef subpop
#growth_pars.r[[1]][[1]] <- list(c(0.5, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) # first source to first reef subpop (external recruits)
growth_pars.r[[1]][[1]] <- list(c(0, 0, 0, 0), c(0, 0, 0), c(0, 0), 0, NULL) # for constant population

growth_pars.r[[2]] <- list() # second reef subpop (intervention)
#growth_pars.r[[2]][[1]] <- list(c(0.2, 0, 0, 0), c(0, 0, 0), c(0.038, 0), 0, NULL) # first source (ext recruits)

# UPDATE: let them grow a little (otherwise nothing ever gets past the 2nd stage) so use the values from the first Varid et al matrix
growth_pars.r[[2]][[1]] <- list(c(0.5, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) 
growth_pars.r[[2]][[2]] <- growth_pars.r[[2]][[1]] # second source (first lab treatment)
growth_pars.r[[2]][[3]] <- growth_pars.r[[2]][[1]] # third source (third lab treatment)

# reef parameters: shrinkage
shrink_pars.r <- list()
shrink_pars.r[[1]] <- list() # first subpop
# shrink_pars.r[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.08), c(0, 0, 0.105), c(0, 0, 0.06, 0.11)) # first source
shrink_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0)) # constant population

shrink_pars.r[[2]] <- list() # second subpop
shrink_pars.r[[2]][[1]] <- list(NULL, c(0.01), c(0, 0.026), c(0, 0.11, 0.27), c(0, 0, 0, 0.15)) # first source 
shrink_pars.r[[2]][[2]] <- shrink_pars.r[[2]][[1]] # second source
shrink_pars.r[[2]][[3]] <- shrink_pars.r[[2]][[1]] # third source

# reef parameters: fragmentation
frag_pars.r <- list()
frag_pars.r[[1]] <- list() # first subpop
#frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.06, 0.06), c(0, 0.28, 0.3, 0.23)) # first source
frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0)) # constant population

frag_pars.r[[2]] <- list() # second subpop
frag_pars.r[[2]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.06, 0.06), c(0, 0.28, 0.3, 0.23)) # first source # first source
#frag_pars.r[[2]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.03, 0.03), c(0, 0.19, 0.16, 0)) # first source
frag_pars.r[[2]][[2]] <- frag_pars.r[[2]][[1]] # second source
frag_pars.r[[2]][[3]] <- frag_pars.r[[2]][[1]] # third source

# reef parameters: fecundity
fec_pars.r <- list()
fec_pars.r[[1]] <- list() # first subpop
fec_pars.r[[1]][[1]] <- c(0, 0, 5000, 50000, 100000) # first source

fec_pars.r[[2]] <- list()
fec_pars.r[[2]][[1]] <- fec_pars.r[[1]][[1]]
fec_pars.r[[2]][[2]] <- fec_pars.r[[1]][[1]]
fec_pars.r[[2]][[3]] <- fec_pars.r[[1]][[1]]

# orchard parameters: survival
surv_pars.o <- list()
surv_pars.o[[1]] <- list() # first treatment
surv_pars.o[[1]][[1]] <- 1- c(0.999, 0.24, 0.13, 0.05, 0.001) # first source (first lab treatment)
surv_pars.o[[1]][[2]] <- surv_pars.o[[1]][[1]] # second source (second lab treatment)

surv_pars.o[[2]] <- list() # second treatment
surv_pars.o[[2]][[1]] <- surv_pars.o[[1]][[1]] # first source (first lab treatment)
surv_pars.o[[2]][[2]] <- surv_pars.o[[1]][[1]] # second source (second lab treatment)

# orchard parameters: growth
growth_pars.o <- list()
growth_pars.o[[1]] <- list() # first treatment
growth_pars.o[[1]][[1]] <- list(c(0.85, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) # first source
growth_pars.o[[1]][[2]] <- growth_pars.o[[1]][[1]] # second source

growth_pars.o[[2]] <- list() # second treatment
growth_pars.o[[2]][[1]] <-growth_pars.o[[1]][[1]] # first source
growth_pars.o[[2]][[2]] <- growth_pars.o[[1]][[1]] # second source

# orchard parameters: shrinkage
shrink_pars.o <- list()
shrink_pars.o[[1]] <- list() # first treatment
shrink_pars.o[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.08), c(0, 0, 0.105), c(0, 0, 0.06, 0.11)) # first source
shrink_pars.o[[1]][[2]] <- shrink_pars.o[[1]][[1]] # second source

shrink_pars.o[[2]] <- list() # second treatment
shrink_pars.o[[2]][[1]] <- shrink_pars.o[[1]][[1]] # first source
shrink_pars.o[[2]][[2]] <- shrink_pars.o[[1]][[1]] # second source

# orchard parameters: fragmentation
frag_pars.o <- list()
frag_pars.o[[1]] <- list() # first treatment
frag_pars.o[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0)) # first source
frag_pars.o[[1]][[2]] <- frag_pars.o[[1]][[1]] # second source

frag_pars.o[[2]] <- list() # second treatment
frag_pars.o[[2]][[1]] <- frag_pars.o[[1]][[1]] # first source
frag_pars.o[[2]][[2]] <- frag_pars.o[[1]][[1]] # second source

fec_pars.o <- list()
fec_pars.o[[1]] <- list() # first treatment
fec_pars.o[[1]][[1]] <- c(0, 0, 0.1, 1, 2) # first source
fec_pars.o[[1]][[2]] <- fec_pars.o[[1]][[1]] # second source

fec_pars.o[[2]] <- list() # second treatment
fec_pars.o[[2]][[1]] <- c(0, 0, 0.1, 1, 2) # first source
fec_pars.o[[2]][[2]] <- fec_pars.o[[1]][[1]] # second source

lambda <- 0 # external recruitment to reef

# stochasticity parameters
sigma_s <- 0
sigma_f <- 0
ext_rand <- FALSE
seeds <- c(1000, 5000, 10000)

# initial conditions in each reef subpopulation
N0.r <- list()
N0.r[[1]] <- list() # first reef subpop
N0.r[[1]][[1]] <- c(10, 20, 20, 15, 5) # first source in first reef subpop (reference reef)
N0.r[[2]] <- list() # second reef subpop
N0.r[[2]][[1]] <- rep(0, n) # first source
N0.r[[2]][[2]] <- rep(0, n) # second source
N0.r[[2]][[3]] <- rep(0, n) # third source

# intial conditions in each orchard subpopulation
N0.o <- list()
N0.o[[1]] <- list() # first orchard treatment
N0.o[[1]][[1]] <- rep(0, n) # first source
N0.o[[1]][[2]] <- rep(0, n) # second source
N0.o[[2]] <- list() # second orchard treatment
N0.o[[2]][[1]] <- rep(0, n) # first source
N0.o[[2]][[2]] <- rep(0, n) # second source

N0.l <- list()
N0.l[[1]] <- 0
N0.l[[2]] <- 0


# disturbance parameters
dist_yrs <- c(years + 10) # years when disturbance occurs, NA if none

# effects of disturbance on each reef subpop
dist_effects.r <- list()
dist_effects.r[[1]] <- list() # list where each element is the effects of disturbnce on corals from each source in the 1st reef subpop
dist_effects.r[[1]][[1]] <- list() # effects of disturbances on corals from first source in first reef subpop
dist_effects.r[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)

# second reef subpop
dist_effects.r[[2]] <- list() 
dist_effects.r[[2]][[1]] <- list() # first source
dist_effects.r[[2]][[1]][[1]] <- c("survival")
dist_effects.r[[2]][[2]] <- list() # second source
dist_effects.r[[2]][[2]][[1]] <- c("survival")
dist_effects.r[[2]][[3]] <- list() # third source
dist_effects.r[[2]][[3]][[1]] <- c("survival")


# disturbance parameters for each reef subpop
dist_pars.r <- list()

# first reef subpop
dist_pars.r[[1]] <- list() # first source in first reef subpop
dist_pars.r[[1]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[1]][[1]], dist_surv0 = list(surv_pars.r[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) # list of disturbance parameters for the third source in the third reef population (defaults for each parameter type are NULL unless the disturbance affects them, as specified in dist_effects)
# dist_surv0 = list where ith element is the survival probabilities for the ith disturbance

# second reef subpop
dist_pars.r[[2]] <- list() 
# first source to second reef subpop
dist_pars.r[[2]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[2]][[1]], dist_surv0 = list(surv_pars.r[[2]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)
# second source to second reef subpop
dist_pars.r[[2]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[2]][[2]], dist_surv0 = list(surv_pars.r[[2]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)
# third source to second reef subpop
dist_pars.r[[2]][[3]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[2]][[3]], dist_surv0 = list(surv_pars.r[[2]][[3]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)

# disturbance effects for each orchard subpop
dist_effects.o <- list()

dist_effects.o[[1]] <- list() # list where each element is the effects of disturbnce on corals from each source in the 1st orchard treatment
dist_effects.o[[1]][[1]] <- list() # effects of disturbances on corals from first source in first orchard treatment
dist_effects.o[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)
dist_effects.o[[1]][[2]] <- list() # second source
dist_effects.o[[1]][[2]][[1]] <- c("survival")

# second orchard treatment
dist_effects.o[[2]] <- list() 
dist_effects.o[[2]][[1]] <- list() # first source
dist_effects.o[[2]][[1]][[1]] <- c("survival") 
dist_effects.o[[2]][[2]] <- list() # second source
dist_effects.o[[2]][[2]][[1]] <- c("survival")

# disturbance parameters for each orchard subpop
dist_pars.o <- list()

# first orchard treatment
dist_pars.o[[1]] <- list() 
# first source in first orchard treatment
dist_pars.o[[1]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[1]][[1]], dist_surv0 = list(surv_pars.o[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) 
# second source in first orchard treatment
dist_pars.o[[1]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[1]][[2]], dist_surv0 = list(surv_pars.o[[1]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)

# second orchard treatment
dist_pars.o[[2]] <- list() 
# first source in second orchard treatment
dist_pars.o[[2]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[2]][[1]], dist_surv0 = list(surv_pars.o[[2]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) 
# second source in second orchard treatment
dist_pars.o[[2]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[2]][[2]], dist_surv0 = list(surv_pars.o[[2]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)


# lab parameters
s0 <- c(0.9, NA) # fraction of settled larvae in each lab treatment that survive to 2wk outplanting
s1 <- c(NA, 0.7) # fraction of settled larvae in each lab treatment that survive to 1 yr outplanting
sett_props <- list(T1 = 1) # proportion of larvae that settle on each tile type
size_props <- matrix(NA, nrow = length(lab_treatments), ncol = n) # matrix for fractions of retained recruits in each size class at the end of their year in the lab
size_props[1, ] <- c(1, 0, 0, 0, 0) # first lab treatment
size_props[2, ] <- c(0.75, 0.25, 0, 0, 0) # second lab treatment
#size_props[2, ] <- c(1, 0, 0, 0, 0) # second lab treatment
lab_pars <- list(s0 = s0, s1 = s1, sett_props = sett_props, size_props = size_props)



# restoration strategy parameters
orchard_yield <- 0 # percent of new orchard babies successfully collected
reef_yield <- 0.0005 # percent of new reef babies successfully collected and fertilized
reef_prop <- c(1, 1) # proportion of lab recruits from each lab treatment outplanted to reef (1-proportion outplanted to orchard)
reef_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(reef_treatments)) # proportion recruits going from each lab treatment to each reef treatment (row = origin lab treatment, column = destination reef treatment)
reef_out_props[1,] <- c(0, 1) # from first lab treatment to each reef treatment (note the "none" reef treatment shouldn't get any outplants)
reef_out_props[2,] <- c(0, 1) # from second lab treatment to each reef treatment (note the "none" reef treatment shouldn't get any outplants)

orchard_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(orchard_treatments)) # proportion recruits going from each lab treatment to each orchard treatment
orchard_out_props[1,] <- c(0.5, 0.5) # from first lab treatment to each orchard treatment
orchard_out_props[2,] <- c(0.5, 0.5) # from second lab treatment to each orchard treatment

# sizes allocated to each treatment
reef_areas <- c(A_reef/2, A_reef/2)*10000 # m^2 given to each post-outplanting reef treatment (make sure to include "none" and the external recruit source; sum of reef_areas should be size of reef), convert to cm^2 by multiplying by 10,000
lab_max <- c(2500) # total number of settlers that the lab can accommodate
lab_retain_max <- c(1200) # total number of settlers that the lab can keep for a year
orchard_size <- c(200, 200) # number of individuals each orchard treatment has space for


# coral transplanting
transplant <- rep(0, years)
#transplant[10] <- 1 # in 10th year, move corals from orchard to reef

# rest_pars$trans_mats[[ss]][[rr]][i,]
null_mat <- matrix(0, nrow = years, ncol = n)
trans_mats <- list()
trans_mats[[1]] <- list() # first treatment
trans_mats[[1]][[1]] <- null_mat
#trans_mats[[1]][[1]][which(transplant!=0)[1],] <- c(0, 0, 0, 2,0)# number of colonies of each size class to move to reef in first transplant event
trans_mats[[1]][[2]] <- null_mat # second source

trans_mats[[2]] <- list() # second treatment
trans_mats[[2]][[1]] <- null_mat # first source
trans_mats[[2]][[2]] <- null_mat # second source

#rest_pars$trans_reef[[ss]][[rr]][i,1]
trans_reef <- list()
null_mat2 <- matrix(1, nrow = years, ncol = 2)
trans_reef[[1]] <- list() # first treatment
trans_reef[[1]][[1]] <- null_mat2
#trans_reef[[1]][[1]][which(transplant!=0)[1],] <- c(2, 1)# reef area and subpopulation to transport the corals to
trans_reef[[1]][[2]] <- null_mat2 # second source

trans_reef[[2]] <- list() # second treatment
trans_reef[[2]][[1]] <- null_mat2# first source
trans_reef[[2]][[2]] <- null_mat2 # second source

rest_pars <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)


sim1 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars, N0.r, N0.o, N0.l)

```





```{r}

# plot results

#reef1_tot <- apply(sim1$reef_pops[[1]][[1]], MARGIN = 2, sum) 
#reef2_tot <- apply(sim1$reef_pops[[2]][[1]], MARGIN = 2, sum) + apply(sim1$reef_pops[[2]][[2]], MARGIN = 2, sum) + apply(sim1$reef_pops[[2]][[3]], MARGIN = 2, sum)

reef1_tot <- apply(sim1$reef_pops_pre[[1]][[1]], MARGIN = 2, sum) 
reef2_tot <- apply(sim1$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(sim1$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) + apply(sim1$reef_pops_pre[[2]][[3]], MARGIN = 2, sum)

orch1_tot <- apply(sim1$orchard_pops[[1]][[1]], MARGIN = 2, sum) + apply(sim1$orchard_pops[[1]][[2]], MARGIN = 2, sum)
orch2_tot <- apply(sim1$orchard_pops[[2]][[1]], MARGIN = 2, sum) + apply(sim1$orchard_pops[[2]][[2]], MARGIN = 2, sum)


plot(x = c(1:years), y = reef1_tot, type = "l", las = 1, ylim = c(0, max(reef1_tot, reef2_tot, orch1_tot, orch2_tot)), xlab = "year", ylab = "Pop'n size", lwd = 2)
lines(x = c(1:years), y = reef2_tot, type = "l", lwd = 2, lty = 2)
lines(x = c(1:years), y = orch1_tot, type = "l", col = "dodgerblue", lwd = 2, lty = 1)
lines(x = c(1:years), y = orch2_tot, type = "l", col = "dodgerblue", lwd = 3, lty = 2)
legend("topleft", legend = c("reef", "orchard"), col = c("black", "dodgerblue"), lwd = 2, lty = c(1, 1))


# check numbers being outplanted
reef2_out_tot <- sim1$reef_out[[2]][[2]] + sim1$reef_out[[2]][[3]]

#reef2_out_tot

```

figure out why it starts at 0
-- first zero: initial conditions
-- second zero: initially there are very few recruits so all go in the one year treatment (if lab_retain_max is large enough then they all fit), so everything from the first time step is still in the lab
-- third zero: population gets it's first outplants, so the population now has some recruits, but the pre population doesn't because these recruits don't appear until after outplanting 


Problem: if I add the outplanted recruits to the population size, then it always looks like there are a lot even though they die (e.g., 1000 are outplanted at time t, most of them die by t+1, but then 1000 more are added)... so either I need to record pre-outplant population sizes or just plot larger size classes. I think I want the former since then that captures how many recruits survived to one year after outplanting


## basic timeseries

100% outplanted after a year, some intermediate %, and 0%

```{r}

lab_retain_max <- c(1200) # total number of settlers that the lab can keep for a year


lab_retain_max.100 <- c(10^9) # max settlers retained for a year

rest_pars.100 <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max.100, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_100 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.100, N0.r, N0.o, N0.l)

lab_retain_max.50 <- c(500) # max settlers retained for a year

rest_pars.50 <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max.50, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_50 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.50, N0.r, N0.o, N0.l)

lab_retain_max.0 <- c(0) # max settlers retained for a year

rest_pars.0 <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max.0, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_0 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.0, N0.r, N0.o, N0.l)


reef_100 <- apply(T2_100$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(T2_100$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) + apply(T2_100$reef_pops_pre[[2]][[3]], MARGIN = 2, sum)

reef_50 <- apply(T2_50$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(T2_50$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) + apply(T2_50$reef_pops_pre[[2]][[3]], MARGIN = 2, sum)

reef_0 <- apply(T2_0$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(T2_0$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) + apply(T2_0$reef_pops_pre[[2]][[3]], MARGIN = 2, sum)

plot(x = c(1:years), y = reef_100, type = "l", las = 1)
lines(x = c(1:years), y = reef_50, type = "l")
lines(x = c(1:years), y = reef_0, type = "l")

# plot cover (m2) instead

reef_100p <- rep(NA, years)

for(i in 1:years){
  
  reef_100p[i] <- (sum(T2_100$reef_pops_pre[[2]][[1]][,i]*A_mids) + sum(T2_100$reef_pops_pre[[2]][[2]][,i]*A_mids) + sum(T2_100$reef_pops_pre[[2]][[3]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}

reef_0p <- rep(NA, years)

for(i in 1:years){
  
  reef_0p[i] <- (sum(T2_0$reef_pops_pre[[2]][[1]][,i]*A_mids) + sum(T2_0$reef_pops_pre[[2]][[2]][,i]*A_mids) + sum(T2_0$reef_pops_pre[[2]][[3]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}

reef_50p <- rep(NA, years)

for(i in 1:years){
  
  reef_50p[i] <- (sum(T2_50$reef_pops_pre[[2]][[1]][,i]*A_mids) + sum(T2_50$reef_pops_pre[[2]][[2]][,i]*A_mids) + sum(T2_50$reef_pops_pre[[2]][[3]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}


col_set <- c("orchid", "darkorange", "lightgreen")

# calculate cost per year: 
# need to know cost of lab maintenance

plot(x = c(1:years), y = reef_100p, type = "l", las = 1, col = col_set[1], lwd = 2, xlab = NA, ylab = NA)
mtext(side = 1, "Time (years)", line = 2, cex = 1.1)
mtext(side = 2, expression("Coral Cover ("*m^2*")"), line = 2, cex = 1.1)
text(x = years-1, y = max(reef_100p)-0.75, paste("$", "xx", "/year", sep = ""), col = col_set[1])
text(x = years-1, y = max(reef_50p)-0.5, paste("$", "xx", "/year", sep = ""), col = col_set[2])
text(x = years-1, y = max(reef_0p) + 0.25, paste("$", "xx", "/year", sep = ""), col = col_set[3])
lines(x = c(1:years), y = reef_50p, type = "l", col = col_set[2], lwd = 2)
lines(x = c(1:years), y = reef_0p, type = "l", col = col_set[3], lwd = 2)
legend("topleft", legend = c("All outplants 1 yr old", "[user choice]", "no yr old outplants"), lwd = 2, col = col_set, bty = "n")



```

## heatmap


```{r}


# lab parameters
s0 <- c(0.9, NA) # fraction of settled larvae in each lab treatment that survive to 2wk outplanting
s1 <- c(NA, 0.7) # fraction of settled larvae in each lab treatment that survive to 1 yr outplanting

growth_set <- seq(from = 0, to = 1, length.out = 25)
max_set <- seq(from = 0, to = 5000, length.out = 25)

pop_mat <- matrix(NA, nrow = length(growth_set), ncol = length(max_set))
#pcover_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))
area_mat <- matrix(NA, nrow = length(growth_set), ncol = length(max_set))

for(i in 1:length(growth_set)){
  
  for(j in 1:length(max_set)){
    
   
    # size props
    size_props.ij <- matrix(NA, nrow = length(lab_treatments), ncol = n) # matrix for fractions of retained recruits in each size class at the end of their year in the lab
size_props.ij[1, ] <- c(1, 0, 0, 0, 0) # first lab treatment
size_props.ij[2, ] <- c((1-growth_set[i]), growth_set[i], 0, 0, 0) # second lab treatment
    
lab_pars.ij <- list(s0 = s0, s1 = s1, sett_props = sett_props, size_props = size_props.ij)

lab_retain_max.ij <- max_set[j]
    
rest_pars.ij <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max.ij, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

  sim.ij <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars.ij, rest_pars.ij, N0.r, N0.o, N0.l)
    
  
  # record final population size
  pop_mat[i,j] <- sum(sim.ij$reef_pops_pre[[2]][[1]][,years]) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]) 
  
  # record area covered
  area_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[2]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]*A_mids))/10000
  
  # record final % cover
  #pcover_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[2]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]*A_mids))/sum(reef_areas)*100
  
  }
}

# save results

pop_mat.7 <- pop_mat
area_mat.7 <- area_mat

# repeat with higher lab mortality

```


plot heatmaps

```{r}
filled.contour(x = growth_set, y = max_set, area_mat, key.title = title(main = expression("Cover ("*m^2*")"), cex.main = 0.8, line = 0.5),
               color.palette = function(n) hcl.colors(n, "purples", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = growth_set, y = max_set, area_mat, levels = 20, lwd = 2, drawlabels = T, add = T, vfont = c("sans serif", "bold"), labcex = 1.1)})
mtext(side = 1, "Lab growth rate", line = 2.5, adj = 0.25)
mtext(side = 2, "Max # retained for yr", line = 2.5)


filled.contour(x = growth_set, y = max_set, area_mat, key.title = title(main = expression("Cover ("*m^2*")"), cex.main = 0.8, line = 0.5),
               color.palette = function(n) hcl.colors(n, "purples", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = growth_set, y = max_set, area_mat, levels = 20, lwd = 2, drawlabels = F, add = T)})
mtext(side = 1, "Lab growth rate", line = 2, adj = 0.25, cex = 1.1)
mtext(side = 2, "Max # retained for yr", line = 2.9, cex = 1.1)

#  zlim = c(0, 100) --> use if I want two plots with the same color bar scale

```

NOTE: instead of % cover, maybe coral/m2 would be a good metric?

## initial simulations
simulations: vary the number that can go in the 1 year outplant treatment and record the number after 5 years (and 10 years?)


start by plotting max lab capacity vs. number on reef with lines for different mortality rates in the lab? (UPDATE: start with different growth rates in the lab since the model seems more sensitive to how many of the year-old recruits grow into the second size class)


NOTE: since the orchard isn't doing anything right now, just put all the lab recruits on the reef

```{r}

#max_set <- seq(from = 0, to = 100, length.out = 20)

lab_retain_max_set <- seq(from = 0, to = 500, length.out = 50)

par_set <- lab_retain_max_set

lab_growth_set <- seq(from = 0, to = 0.75, by = 0.25)


# holding lists for reef population size, area, and reproductive output
reef_popL <- list()
reef_areaL <- list()
reef_repL <- list()
reef_outL <- list()


for(j in 1:length(lab_growth_set)){
  
size_props.j <- matrix(NA, nrow = length(lab_treatments), ncol = n) # matrix for fractions of retained recruits in each size class at the end of their year in the lab
size_props.j[1, ] <- c(1, 0, 0, 0, 0) # first lab treatment
size_props.j[2, ] <- c(1-lab_growth_set[j], lab_growth_set[j], 0, 0, 0) # second lab treatment
lab_pars.j <- list(s0 = s0, s1 = s1, sett_props = sett_props, size_props = size_props.j)


# holding matrices reef population size, area, and reproductive output (rows = parameter values, columns = year in simulation when values are recorded)
reef_pop <- matrix(NA, nrow = length(par_set), ncol = 1)
reef_area <- matrix(NA, nrow = length(par_set), ncol = 1)
reef_rep <- matrix(NA, nrow = length(par_set), ncol = 1)
reef_out <- matrix(NA, nrow = length(par_set), ncol = 1)

for(i in 1:length(lab_retain_max_set)){
  
  #lab_max.i <- c(100, prop_set[i])
  lab_retain_max.i <- c(lab_retain_max_set[i])
  
rest_pars.i <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max.i, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

sim.i <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars.j, rest_pars.i, N0.r, N0.o, N0.l)
  
  
# save the results

reef_pop[i,1] <- sum(sim.i$reef_pops_pre[[2]][[1]][,5]) + sum(sim.i$reef_pops_pre[[2]][[2]][,5]) + sum(sim.i$reef_pops_pre[[2]][[3]][,5])

reef_area[i,1] <- sum(sim.i$reef_pops_pre[[2]][[1]][,5]*A_mids) + sum(sim.i$reef_pops_pre[[2]][[2]][,5]*A_mids) + sum(sim.i$reef_pops_pre[[2]][[3]][,5]*A_mids)

reef_rep[i,1] <-sum(sim.i$reef_pops_pre[[2]][[1]][,5]*fec_pars.r[[2]][[1]]) + sum(sim.i$reef_pops_pre[[2]][[2]][,5]*fec_pars.r[[2]][[2]]) + sum(sim.i$reef_pops_pre[[2]][[3]][,5]*fec_pars.r[[2]][[3]])

reef_out[i,1] <- sum(sim.i$reef_out[[2]][[2]][2:5]) + sum(sim.i$reef_out[[2]][[3]][2:5])

}

# save the results for this lab growth rate
reef_popL[[j]] <- reef_pop
reef_areaL[[j]] <- reef_area
reef_repL[[j]] <- reef_rep
reef_outL[[j]] <- reef_out
  
}



```




```{r}
plot(x = lab_retain_max_set, y = reef_popL[[1]], type = "l", las = 1, ylim = c(0, max(reef_popL[[4]])), lty = 1, lwd = 2, xlab = NA, ylab = NA)
mtext(side = 1, "No. recruits kept in lab for 1 yr", line = 2.5)
mtext(side = 2, "Reef population size", line = 2.5)
lines(x = lab_retain_max_set, y = reef_popL[[2]], lty = 2, lwd = 2)
lines(x = lab_retain_max_set, y = reef_popL[[3]], lty = 3, lwd = 2)
lines(x = lab_retain_max_set, y = reef_popL[[4]], lty = 4, lwd = 2)
legend("topleft", legend = c(0, 0.25, 0.5, 0.75), lty = c(1, 2, 3, 4), lwd = 2, title = "Prop. year-old recruits in 2nd size class", ncol = 2)


# plot(x = lab_retain_max_set, y = reef_areaL[[1]], type = "l", las = 1, ylim = c(0, max(reef_areaL[[4]])), lty = 1, lwd = 2, xlab = NA, ylab = NA)
# mtext(side = 1, "No. recruits kept in lab for 1 yr", line = 2.5)
# mtext(side = 2, "Reef coral cover", line = 2.5)
# lines(x = lab_retain_max_set, y = reef_areaL[[2]], lty = 2, lwd = 2)
# lines(x = lab_retain_max_set, y = reef_areaL[[3]], lty = 3, lwd = 2)
# lines(x = lab_retain_max_set, y = reef_areaL[[4]], lty = 4, lwd = 2)
# legend("topleft", legend = c(0, 0.25, 0.5, 0.75), lty = c(1, 2, 3, 4), lwd = 2, title = "Prop. year-old recruits in 2nd size class", ncol = 2)


#plot(x = lab_retain_max_set, y = reef_outL[[1]], type = "l", las = 1)




```

I think the flattening out is the part where max set is high enough that all the larvae are kept for a year, so changing the max beyond that point has no effect since the same number of larvae will go in the lab at each point



thought: once we have an idea of a threshold for the populations (restoration target), could make plots with some parameter on x-axis (e.g., survival rate in lab) and then min lab capacity needed to reach target on the y-axis?


# Scenario 3: orchard expansion

switch to collecting from the orchard. Maybe for simplicity assume you are starting with a mature orchard (so it makes sense to collect from it) and the question is whether to expand it? then plot prop. recruits going to orchard on the x-axis and reef pop'n size on the y-axis at 2 years and 10 years (or something like that... expect benefits to materialize over longer time periods since it takes some time for the orchard recruits to mature)


Eventually will want to allow collection from orchard vs. reef to be flexible (incorporate feedbacks where orchard collection only starts once there are mature orchard colonies)


```{r}

years <- 30
n <- 5

A_mids <- c(0.1, 43, 369, 2158, 11171) # mean areas in each size class (cm^2)


orchard_treatments <- c("none") # one orchards
reef_treatments <- c("none", "intervention") # reef (natural population and intervention site; note don't have a "control" because just include that as one of the simulations)
lab_treatments <- c("0_T1") # just one tile type, outplanted immediately

# demographic parameters for each orchard and reef treatment
# reef parameters: survival
surv_pars.r <- list()
surv_pars.r[[1]] <- list() # first reef subpop (reference reef) 
#surv_pars.r[[1]][[1]] <- c(0.010, 0.760, 0.870, 0.950, 0.999) # survival probabilities for first source of recruits to first reef (external recruits); from 1st matrix in Vardi et al. 2012
surv_pars.r[[1]][[1]] <- c(1, 1, 1, 1, 1) # for constant pop'n
surv_pars.r[[2]] <- list() # second reef subpop (intervention reef)
surv_pars.r[[2]][[1]] <- c(0.010, 0.44, 0.53, 0.70, 0.84) # survival probabilities for first source of recruits to second reef subpop (external recruits); from 2nd matrix in Vardi et al. 2012
surv_pars.r[[2]][[2]] <- c(0.01, 0.44, 0.53, 0.70, 0.84) # survival probabilities for second source of recruits to second reef subpop (first lab treatment)
surv_pars.r[[2]][[3]] <- c(0.01, 0.44, 0.53, 0.70, 0.84) # survival probabilities for third source of recruits to second reef subpop (second lab treatment)

# reef parameters: growth
growth_pars.r <- list()
growth_pars.r[[1]] <- list() # first reef subpop
#growth_pars.r[[1]][[1]] <- list(c(0.5, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) # first source to first reef subpop (external recruits)
growth_pars.r[[1]][[1]] <- list(c(0, 0, 0, 0), c(0, 0, 0), c(0, 0), 0, NULL) # for constant population

growth_pars.r[[2]] <- list() # second reef subpop (intervention)
#growth_pars.r[[2]][[1]] <- list(c(0.2, 0, 0, 0), c(0, 0, 0), c(0.038, 0), 0, NULL) # first source (ext recruits)

# UPDATE: let them grow a little (otherwise nothing ever gets past the 2nd stage) so use the values from the first Varid et al matrix
growth_pars.r[[2]][[1]] <- list(c(0.5, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) 
growth_pars.r[[2]][[2]] <- growth_pars.r[[2]][[1]] # second source (first lab treatment)
growth_pars.r[[2]][[3]] <- growth_pars.r[[2]][[1]] # third source (third lab treatment)

# reef parameters: shrinkage
shrink_pars.r <- list()
shrink_pars.r[[1]] <- list() # first subpop
# shrink_pars.r[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.08), c(0, 0, 0.105), c(0, 0, 0.06, 0.11)) # first source
shrink_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0)) # constant population

shrink_pars.r[[2]] <- list() # second subpop
shrink_pars.r[[2]][[1]] <- list(NULL, c(0.01), c(0, 0.026), c(0, 0.11, 0.27), c(0, 0, 0, 0.15)) # first source 
shrink_pars.r[[2]][[2]] <- shrink_pars.r[[2]][[1]] # second source
shrink_pars.r[[2]][[3]] <- shrink_pars.r[[2]][[1]] # third source

# reef parameters: fragmentation
frag_pars.r <- list()
frag_pars.r[[1]] <- list() # first subpop
#frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.06, 0.06), c(0, 0.28, 0.3, 0.23)) # first source
frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0)) # constant population

frag_pars.r[[2]] <- list() # second subpop
frag_pars.r[[2]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.06, 0.06), c(0, 0.28, 0.3, 0.23)) # first source # first source
#frag_pars.r[[2]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.03, 0.03), c(0, 0.19, 0.16, 0)) # first source
frag_pars.r[[2]][[2]] <- frag_pars.r[[2]][[1]] # second source
frag_pars.r[[2]][[3]] <- frag_pars.r[[2]][[1]] # third source

# reef parameters: fecundity
fec_pars.r <- list()
fec_pars.r[[1]] <- list() # first subpop
fec_pars.r[[1]][[1]] <- c(0, 0, 5000, 50000, 100000) # first source

fec_pars.r[[2]] <- list()
fec_pars.r[[2]][[1]] <- fec_pars.r[[1]][[1]]
fec_pars.r[[2]][[2]] <- fec_pars.r[[1]][[1]]

# orchard parameters: survival
surv_pars.o <- list()
surv_pars.o[[1]] <- list() # first treatment
surv_pars.o[[1]][[1]] <- c(0.010, 0.760, 0.870, 0.950, 0.999) # first source (first lab treatment)
surv_pars.o[[1]][[2]] <- surv_pars.o[[1]][[1]] # second source (second lab treatment)

surv_pars.o[[2]] <- list() # second treatment
surv_pars.o[[2]][[1]] <- surv_pars.o[[1]][[1]] # first source (first lab treatment)
surv_pars.o[[2]][[2]] <- surv_pars.o[[1]][[1]] # second source (second lab treatment)

# orchard parameters: growth
growth_pars.o <- list()
growth_pars.o[[1]] <- list() # first treatment
growth_pars.o[[1]][[1]] <- list(c(0.85, 0, 0, 0), c(0.197, 0.0132, 0), c(0.126, 0), 0.1158, NULL) # first source (first lab treatment)


# orchard parameters: shrinkage
shrink_pars.o <- list()
shrink_pars.o[[1]] <- list() # first treatment
shrink_pars.o[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.08), c(0, 0, 0.105), c(0, 0, 0.06, 0.11)) # first source


# orchard parameters: fragmentation
frag_pars.o <- list()
frag_pars.o[[1]] <- list() # first treatment
frag_pars.o[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0)) # first source
frag_pars.o[[1]][[2]] <- frag_pars.o[[1]][[1]] # second source


fec_pars.o <- list()
fec_pars.o[[1]] <- list() # first treatment
fec_pars.o[[1]][[1]] <- c(0, 0, 5000, 50000, 100000) # first source


lambda <- 0 # external recruitment to reef

# stochasticity parameters
sigma_s <- 0
sigma_f <- 0
ext_rand <- FALSE
seeds <- c(1000, 5000, 10000)

# initial conditions in each reef subpopulation
N0.r <- list()
N0.r[[1]] <- list() # first reef subpop
N0.r[[1]][[1]] <- c(10, 20, 20, 15, 5) # first source in first reef subpop (reference reef)
N0.r[[2]] <- list() # second reef subpop
N0.r[[2]][[1]] <- rep(0, n) # first source
N0.r[[2]][[2]] <- rep(0, n) # second source

# initial conditions in each orchard subpopulation
N0.o <- list()
N0.o[[1]] <- list() # first orchard treatment
N0.o[[1]][[1]] <- c(50, 10, 1, 0, 0) # first source

# initial conditions in lab
N0.l <- list()
N0.l[[1]] <- 0
N0.l[[2]] <- 0


# disturbance parameters
dist_yrs <- c(years + 10) # years when disturbance occurs, NA if none

# effects of disturbance on each reef subpop
dist_effects.r <- list()
dist_effects.r[[1]] <- list() # list where each element is the effects of disturbnce on corals from each source in the 1st reef subpop
dist_effects.r[[1]][[1]] <- list() # effects of disturbances on corals from first source in first reef subpop
dist_effects.r[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)

# second reef subpop
dist_effects.r[[2]] <- list() 
dist_effects.r[[2]][[1]] <- list() # first source
dist_effects.r[[2]][[1]][[1]] <- c("survival")
dist_effects.r[[2]][[2]] <- list() # second source
dist_effects.r[[2]][[2]][[1]] <- c("survival")

# disturbance parameters for each reef subpop
dist_pars.r <- list()

# first reef subpop
dist_pars.r[[1]] <- list() # first source in first reef subpop
dist_pars.r[[1]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[1]][[1]], dist_surv0 = list(surv_pars.r[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) # list of disturbance parameters for the third source in the third reef population (defaults for each parameter type are NULL unless the disturbance affects them, as specified in dist_effects)
# dist_surv0 = list where ith element is the survival probabilities for the ith disturbance

# second reef subpop
dist_pars.r[[2]] <- list() 
# first source to second reef subpop
dist_pars.r[[2]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[2]][[1]], dist_surv0 = list(surv_pars.r[[2]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)
# second source to second reef subpop
dist_pars.r[[2]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[2]][[2]], dist_surv0 = list(surv_pars.r[[2]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)
# third source to second reef subpop

# disturbance effects for each orchard subpop
dist_effects.o <- list()

dist_effects.o[[1]] <- list() # list where each element is the effects of disturbnce on corals from each source in the 1st orchard treatment
dist_effects.o[[1]][[1]] <- list() # effects of disturbances on corals from first source in first orchard treatment
dist_effects.o[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)


# disturbance parameters for each orchard subpop
dist_pars.o <- list()

# first orchard treatment
dist_pars.o[[1]] <- list() 
# first source in first orchard treatment
dist_pars.o[[1]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[1]][[1]], dist_surv0 = list(surv_pars.o[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) 


# lab parameters
s0 <- c(0.9, 0.9) # fraction of settled larvae in each lab treatment that survive to 2wk outplanting
s1 <- c(0.7, 0.7) # fraction of settled larvae in each lab treatment that survive to 1 yr outplanting
sett_props <- list(T1 = 1) # proportion of larvae that settle on each tile type
size_props <- matrix(NA, nrow = length(lab_treatments), ncol = n) # matrix for fractions of retained recruits in each size class at the end of their year in the lab
size_props[1, ] <- c(1, 0, 0, 0, 0) # first lab treatment (0_T1)
#size_props[2, ] <- c(1, 0, 0, 0, 0) # second lab treatment (0_T2)
lab_pars <- list(s0 = s0, s1 = s1, sett_props = sett_props, size_props = size_props)



# restoration strategy parameters
orchard_yield <- 0.05 # proportion of new orchard babies successfully collected and fertilized
reef_yield <- 0 # proportion of new reef babies successfully collected and fertilized
reef_prop <- c(1) # proportion of lab recruits from each lab treatment outplanted to reef (1-proportion outplanted to orchard)
reef_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(reef_treatments)) # proportion recruits going from each lab treatment to each reef treatment (row = origin lab treatment, column = destination reef treatment)
reef_out_props[1,] <- c(0, 1) # from first lab treatment to each reef treatment (note the "none" reef treatment shouldn't get any outplants)

orchard_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(orchard_treatments)) # proportion recruits going from each lab treatment to each orchard treatment
orchard_out_props[1,] <- c(1) # from first lab treatment to each orchard treatment

# sizes allocated to each treatment
reef_areas <- c(100, 100)*10000 # m^2 given to each reef treatment (make sure to include none -- sum of reef_areas should be size of reef), convert to cm^2
lab_max <- c(5000) # total number of settlers that the lab can accommodate
lab_retain_max <- c(0) # total number of settlers that the lab can keep for a year
orchard_size <- c(10000) # number of individuals each orchard treatment has space for

# coral transplanting
transplant <- rep(0, years)
#transplant[10] <- 1 # in 10th year, move corals from orchard to reef

# rest_pars$trans_mats[[ss]][[rr]][i,]
null_mat <- matrix(0, nrow = years, ncol = n)
trans_mats <- list()
trans_mats[[1]] <- list() # first treatment
trans_mats[[1]][[1]] <- null_mat

#rest_pars$trans_reef[[ss]][[rr]][i,1]
trans_reef <- list()
null_mat2 <- matrix(1, nrow = years, ncol = 2)
trans_reef[[1]] <- list() # first treatment
trans_reef[[1]][[1]] <- null_mat2
#trans_reef[[1]][[1]][which(transplant!=0)[1],] <- c(2, 1)# reef area and subpopulation to transport the corals to

trans_reef[[2]] <- list() # second treatment
trans_reef[[2]][[1]] <- null_mat2# first source

rest_pars <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)


sim1 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars, N0.r, N0.o, N0.l)

```


```{r}
reef1_tot <- apply(sim1$reef_pops_pre[[1]][[1]], MARGIN = 2, sum) 
reef2_tot <- apply(sim1$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(sim1$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) 

orch1_tot <- apply(sim1$orchard_pops_pre[[1]][[1]], MARGIN = 2, sum) 

#orch1_tot <- apply(sim1$orchard_pops[[1]][[1]], MARGIN = 2, sum) # shows whether population reached its max


plot(x = c(1:years), y = reef1_tot, type = "l", las = 1, ylim = c(0, max(reef1_tot, reef2_tot, orch1_tot)), xlab = "year", ylab = "Pop'n size", lwd = 2)
lines(x = c(1:years), y = reef2_tot, type = "l", lwd = 2, lty = 2)
lines(x = c(1:years), y = orch1_tot, type = "l", col = "dodgerblue", lwd = 2, lty = 1)
legend("topleft", legend = c("reef", "orchard"), col = c("black", "dodgerblue"), lwd = 2, lty = c(1, 1))


plot(x = c(1:years), y = reef2_tot, type = "l", las = 1, ylim = c(0, 150), xlab = "year", ylab = "Pop'n size", lwd = 2, xlim = c(1, 5), lty = 2)
lines(x = c(1:years), y = orch1_tot, type = "l", col = "dodgerblue", lwd = 2, lty = 1)


```

REMEMBER the reef can still get recruits even if 100% go the the orchard first because any recruits that don't fit in the orchard will get put on the reef anyway (should update the model function to make this a parameter: should surplus recruits go to the reef?)


## basic timeseries

all recruits to orchard, intermediate, all recruits to lab

```{r}


reef_prop.100 <- c(1) 


rest_pars.100 <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop.100, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_100 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.100, N0.r, N0.o, N0.l)

reef_prop.50 <- c(0.5) 

rest_pars.50 <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop.50, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_50 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.50, N0.r, N0.o, N0.l)

reef_prop.0 <- c(0) 

rest_pars.0 <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop.0, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_0 <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.0, N0.r, N0.o, N0.l)


reef_100 <- apply(T2_100$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(T2_100$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) 

reef_50 <- apply(T2_50$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(T2_50$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) 

reef_0 <- apply(T2_0$reef_pops_pre[[2]][[1]], MARGIN = 2, sum) + apply(T2_0$reef_pops_pre[[2]][[2]], MARGIN = 2, sum) 

# orchard production
orchp_100 <- T2_100$orchard_rep[[1]][[1]] 

orchp_50 <- T2_50$orchard_rep[[1]][[1]]

orchp_0 <- T2_0$orchard_rep[[1]][[1]]

plot(x = c(1:years), y = reef_100, type = "l", las = 1)
lines(x = c(1:years), y = reef_50, type = "l")
lines(x = c(1:years), y = reef_0, type = "l")



# plot cover (m2) instead

reef_100p <- rep(NA, years)

for(i in 1:years){
  
  reef_100p[i] <- (sum(T2_100$reef_pops_pre[[2]][[1]][,i]*A_mids) + sum(T2_100$reef_pops_pre[[2]][[2]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}

reef_0p <- rep(NA, years)

for(i in 1:years){
  
  reef_0p[i] <- (sum(T2_0$reef_pops_pre[[2]][[1]][,i]*A_mids) + sum(T2_0$reef_pops_pre[[2]][[2]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}

reef_50p <- rep(NA, years)

for(i in 1:years){
  
  reef_50p[i] <- (sum(T2_50$reef_pops_pre[[2]][[1]][,i]*A_mids) + sum(T2_50$reef_pops_pre[[2]][[2]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}


col_set <- c("orchid", "darkorange", "lightgreen")

# calculate cost per year: 
# need to know cost of lab maintenance

#par(mfrow = c(1, 2))
par(mar=c(0, 3.5, 0.5, 1), oma = c(3.5, 1.5, 2, 0))
plot(x = c(1:years), y = reef_100p, type = "l", las = 1, col = col_set[1], lwd = 2, xlab = NA, ylab = NA)
mtext(side = 1, "Time (years)", line = 2, cex = 1.2)
mtext(side = 2, expression("Coral Cover ("*m^2*")"), line = 2, cex = 1.2)
#text(x = years-1, y = max(reef_100p)-0.75, paste("$", "xx", "/year", sep = ""), col = col_set[1])
#text(x = years-1, y = max(reef_50p)-0.5, paste("$", "xx", "/year", sep = ""), col = col_set[2])
#text(x = years-1, y = max(reef_0p) + 0.25, paste("$", "xx", "/year", sep = ""), col = col_set[3])
lines(x = c(1:years), y = reef_50p, type = "l", col = col_set[2], lwd = 2)
lines(x = c(1:years), y = reef_0p, type = "l", col = col_set[3], lwd = 2)
legend("topleft", legend = c("100% to reef", "[user choice]", "0% to reef"), lwd = 2, col = col_set, bty = "n")


# now plot orchard production
par(mar=c(0, 3.5, 0.5, 1), oma = c(3.5, 1.5, 2, 0))
plot(x = c(1:years), y = orchp_100/(10^6), type = "l", las = 1, col = col_set[1], lwd = 2, xlab = NA, ylab = NA, ylim = c(0, max(orchp_0, orchp_50, orchp_100)/(10^6)))
mtext(side = 1, "Time (years)", line = 2, cex = 1.1)
#mtext(side = 2, "Orchard production (larvae x 10^6)", line = 2)
mtext(side = 2, expression("Orchard production (larvae x"~10^6*")"), line = 1.5, cex = 1.2)
lines(x = c(1:years), y = orchp_50/(10^6), type = "l", col = col_set[2], lwd = 2)
lines(x = c(1:years), y = orchp_0/(10^6), type = "l", col = col_set[3], lwd = 2)
legend("topleft", legend = c("100% to reef", "[user choice]", "0% to reef"), lwd = 2, col = col_set, bty = "n")


```

## heatmap

```{r}

prop_set <- seq(from = 0, to = 1, length.out = 25) # proportion outplanted to reef
cap_set <- seq(from = 0, to = 500, length.out = 25) # max orchard capacity

pop_mat <- matrix(NA, nrow = length(growth_set), ncol = length(max_set))
#pcover_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))
area_mat <- matrix(NA, nrow = length(growth_set), ncol = length(max_set))

for(i in 1:length(prop_set)){
  
  for(j in 1:length(cap_set)){
    
    reef_prop.ij <- prop_set[i]
   orchard_size.ij <- cap_set[j]
   
    
rest_pars.ij <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop.ij, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size.ij, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

  sim.ij <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.ij, N0.r, N0.o, N0.l)
    
  
  # record final population size
  pop_mat[i,j] <- sum(sim.ij$reef_pops_pre[[2]][[1]][,years]) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years])
  
  # record area covered
  area_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[2]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]*A_mids))/10000
  
  # record final % cover
  #pcover_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[2]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]*A_mids))/sum(reef_areas)*100
  
  }
}



# repeat with higher lab mortality
```



```{r}
filled.contour(x = prop_set, y = cap_set, area_mat, key.title = title(main = expression("Cover ("*m^2*")"), cex.main = 0.8, line = 0.5),
               color.palette = function(n) hcl.colors(n, "blues", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = prop_set, y = cap_set, area_mat, levels = 0.75, lwd = 2, drawlabels = T, add = T, vfont = c("sans serif", "bold"), labcex = 1.1)})
mtext(side = 1, "Prop. outplanted to reef", line = 2.5, adj = 0.25)
mtext(side = 2, "Max orchard capacity", line = 2.5)


filled.contour(x = prop_set, y = cap_set, area_mat, key.title = title(main = expression("Cover ("*m^2*")"), cex.main = 0.8, line = 0.5),
               color.palette = function(n) hcl.colors(n, "blues", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = prop_set, y = cap_set, area_mat, levels = 0.75, lwd = 2, drawlabels = F, add = T)})
mtext(side = 1, "Prop. outplanted to reef", line = 2, adj = 0.25, cex = 1.1)
mtext(side = 2, "Orchard size (max)", line = 2.5, cex = 1.1)

```


## initial simulations

```{r}


reef_props <- seq(from = 0, to = 1, length.out = 50) # proportion of recruits that get put on the reef

par_set <- reef_props


# holding matrices reef population size, area, and reproductive output at 5 and 10 years (rows = parameter values, columns = year in simulation)
reef_pop <- matrix(NA, nrow = length(par_set), ncol = 2)
reef_area <- matrix(NA, nrow = length(par_set), ncol = 2)
reef_rep <- matrix(NA, nrow = length(par_set), ncol = 2)
reef_out <- matrix(NA, nrow = length(par_set), ncol = 2)


for(i in 1:length(par_set)){
  
reef_prop.i <- c(reef_props[i]) # proportion of lab recruits from each lab treatment outplanted to reef (1-proportion outplanted to orchard)

rest_pars.i <- list(orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop.i, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

sim.i <- rse_mod(years, n, A_mids, surv_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.i, N0.r, N0.o, N0.l)
  
# save the results

reef_pop[i,1] <- sum(sim.i$reef_pops_pre[[2]][[1]][,3]) + sum(sim.i$reef_pops_pre[[2]][[2]][,3])

reef_area[i,1] <- sum(sim.i$reef_pops_pre[[2]][[1]][,3]*A_mids) + sum(sim.i$reef_pops_pre[[2]][[2]][,3]*A_mids)

reef_rep[i,1] <-sum(sim.i$reef_pops_pre[[2]][[1]][,3]*fec_pars.r[[2]][[1]]) + sum(sim.i$reef_pops_pre[[2]][[2]][,3]*fec_pars.r[[2]][[2]])

reef_out[i,1] <- sum(sim.i$reef_out[[2]][[2]][2:5])

  
reef_pop[i,2] <- sum(sim.i$reef_pops_pre[[2]][[1]][,10]) + sum(sim.i$reef_pops_pre[[2]][[2]][,10])

reef_area[i,2] <- sum(sim.i$reef_pops_pre[[2]][[1]][,10]*A_mids) + sum(sim.i$reef_pops_pre[[2]][[2]][,10]*A_mids)

reef_rep[i,2] <-sum(sim.i$reef_pops_pre[[2]][[1]][,10]*fec_pars.r[[2]][[1]]) + sum(sim.i$reef_pops_pre[[2]][[2]][,10]*fec_pars.r[[2]][[2]])

reef_out[i,2] <- sum(sim.i$reef_out[[2]][[2]][2:10])



}



```



```{r}


plot(x = reef_props, y = reef_pop[,1], type = "l", las = 1, ylim = c(0, max(reef_pop[,2])), xlab = "Prop. outplants put on reef", ylab = "Reef population size")
lines(x = reef_props, y = reef_pop[,2], lty = 2)
legend(x = "topleft", legend = c("3 years", "10 years"), lty = c(1, 2))

# plot(x = reef_props, y = reef_area[,1], type = "l", las = 1, ylim = c(0, max(reef_area[,2])))
# lines(x = reef_props, y = reef_area[,2], lty = 2)
# 
# plot(x = reef_props, y = reef_rep[,1], type = "l", las = 1, ylim = c(0, max(reef_rep[,2])))
# lines(x = reef_props, y = reef_rep[,2], lty = 2)

```



NOTE the reef population size isn't zero when reef_props = 0 because the reef still gets the extra orchard outplants (the ones that don't fit in the orchard)

NOTE: to get the unimodal relationship, need to make the max capacities really high, otherwise things get maxed out and you just see a strictly positive relationship (the decline happens but it doesn't matter if you still have enough to reach your max capacity)


















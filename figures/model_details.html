<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coral RSE Model - Components</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: #0a0a0a;
      color: #fafafa;
      min-height: 100vh;
      padding: 32px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 1px solid #1a1a1a;
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
    }

    h1 em { color: #22c55e; font-style: italic; font-weight: 400; }

    nav a {
      color: #666;
      text-decoration: none;
      font-size: 13px;
      margin-left: 24px;
      transition: color 0.15s;
    }

    nav a:hover { color: #22c55e; }
    nav a.active { color: #22c55e; }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: #111;
      border: 1px solid #1a1a1a;
      border-radius: 12px;
      padding: 24px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }

    .card-icon.reef { background: #16a34a; }
    .card-icon.lab { background: #2563eb; }
    .card-icon.orchard { background: #7c3aed; }
    .card-icon.matrix { background: #475569; }

    .card h2 {
      font-size: 16px;
      font-weight: 600;
    }

    .card h2 span {
      font-size: 12px;
      font-weight: 400;
      color: #666;
      margin-left: 8px;
    }

    .card-content {
      min-height: 200px;
    }

    svg {
      width: 100%;
      height: 100%;
    }

    .axis text {
      font-size: 10px;
      fill: #666;
    }

    .axis line, .axis path {
      stroke: #333;
    }

    .matrix-cell {
      stroke: #1a1a1a;
      stroke-width: 1;
    }

    .matrix-label {
      font-size: 9px;
      fill: #888;
      text-anchor: middle;
    }

    .lifecycle-node {
      cursor: pointer;
      transition: transform 0.2s;
    }

    .lifecycle-node:hover {
      transform: scale(1.1);
    }

    .lifecycle-label {
      font-size: 10px;
      fill: white;
      text-anchor: middle;
      pointer-events: none;
    }

    .lifecycle-size {
      font-size: 8px;
      fill: #888;
      text-anchor: middle;
    }

    .tile-box {
      rx: 6;
      ry: 6;
    }

    .tile-label {
      font-size: 11px;
      fill: white;
      text-anchor: middle;
      font-weight: 600;
    }

    .tile-sub {
      font-size: 9px;
      fill: rgba(255,255,255,0.6);
      text-anchor: middle;
    }

    .param-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #1a1a1a;
      font-size: 13px;
    }

    .param-row:last-child { border-bottom: none; }

    .param-name {
      font-family: 'SF Mono', monospace;
      color: #888;
    }

    .param-value {
      color: #22c55e;
      font-weight: 500;
    }

    .param-desc {
      color: #555;
      font-size: 11px;
      margin-top: 2px;
    }

    .equation-box {
      background: #0a0a0a;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
    }

    .equation {
      font-family: 'Times New Roman', Georgia, serif;
      font-size: 18px;
      color: #22c55e;
    }

    .equation-note {
      font-size: 11px;
      color: #555;
      margin-top: 8px;
    }

    .timeline {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-top: 20px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 30px;
      right: 30px;
      height: 2px;
      background: #333;
    }

    .timeline-step {
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .timeline-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #1a1a1a;
      border: 2px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .timeline-step:hover .timeline-dot {
      border-color: #22c55e;
      background: #16a34a;
    }

    .timeline-label {
      font-size: 10px;
      color: #666;
      max-width: 70px;
    }

    .full-width {
      grid-column: 1 / -1;
    }
  </style>
</head>
<body>
  <header>
    <h1>Coral RSE Model — <em>Acropora palmata</em></h1>
    <nav>
      <a href="model_interactive.html">System Overview</a>
      <a href="model_details.html" class="active">Components</a>
    </nav>
  </header>

  <div class="grid">
    <!-- Size Structure -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon reef">SC</div>
        <h2>Size Structure <span>5 classes</span></h2>
      </div>
      <div class="card-content">
        <svg id="lifecycle" viewBox="0 0 400 220"></svg>
      </div>
    </div>

    <!-- Transition Matrix -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon matrix">T</div>
        <h2>Transition Matrix <span>Growth + Shrinkage</span></h2>
      </div>
      <div class="card-content">
        <svg id="matrix" viewBox="0 0 400 220"></svg>
      </div>
    </div>

    <!-- Lab Tiles -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon lab">L</div>
        <h2>Lab Settlement <span>Tile types</span></h2>
      </div>
      <div class="card-content">
        <svg id="tiles" viewBox="0 0 400 200"></svg>
      </div>
    </div>

    <!-- Orchard -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon orchard">O</div>
        <h2>Orchard Nursery <span>Broodstock</span></h2>
      </div>
      <div class="card-content">
        <svg id="orchard" viewBox="0 0 400 200"></svg>
      </div>
    </div>

    <!-- Core Equation -->
    <div class="card full-width">
      <div class="card-header">
        <div class="card-icon matrix">∑</div>
        <h2>Population Dynamics <span>Core equation</span></h2>
      </div>
      <div class="equation-box">
        <div class="equation">N(t+1) = S · (T + F) · N(t) + R</div>
        <div class="equation-note">
          S = Survival matrix | T = Growth/shrinkage transitions | F = Fragmentation | R = Recruitment
        </div>
      </div>
      <div class="timeline">
        <div class="timeline-step">
          <div class="timeline-dot">1</div>
          <div class="timeline-label">Survival & Growth</div>
        </div>
        <div class="timeline-step">
          <div class="timeline-dot">2</div>
          <div class="timeline-label">Reproduction</div>
        </div>
        <div class="timeline-step">
          <div class="timeline-dot">3</div>
          <div class="timeline-label">Larvae Collection</div>
        </div>
        <div class="timeline-step">
          <div class="timeline-dot">4</div>
          <div class="timeline-label">Lab Processing</div>
        </div>
        <div class="timeline-step">
          <div class="timeline-dot">5</div>
          <div class="timeline-label">Outplanting</div>
        </div>
        <div class="timeline-step">
          <div class="timeline-dot">6</div>
          <div class="timeline-label">Transplanting</div>
        </div>
      </div>
    </div>

    <!-- Parameters -->
    <div class="card full-width">
      <div class="card-header">
        <div class="card-icon matrix">θ</div>
        <h2>Key Parameters</h2>
      </div>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
        <div>
          <h3 style="font-size: 11px; color: #16a34a; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.1em;">Reef</h3>
          <div class="param-row">
            <div>
              <div class="param-name">surv_pars.r</div>
              <div class="param-desc">Survival by size class</div>
            </div>
            <div class="param-value">0.4–0.9</div>
          </div>
          <div class="param-row">
            <div>
              <div class="param-name">growth_pars.r</div>
              <div class="param-desc">Growth transitions</div>
            </div>
            <div class="param-value">varies</div>
          </div>
          <div class="param-row">
            <div>
              <div class="param-name">frag_pars.r</div>
              <div class="param-desc">Fragmentation (SC4,5)</div>
            </div>
            <div class="param-value">literature</div>
          </div>
          <div class="param-row">
            <div>
              <div class="param-name">reef_yield</div>
              <div class="param-desc">Larvae collection %</div>
            </div>
            <div class="param-value">0.001</div>
          </div>
        </div>
        <div>
          <h3 style="font-size: 11px; color: #2563eb; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.1em;">Lab</h3>
          <div class="param-row">
            <div>
              <div class="param-name">sett_props</div>
              <div class="param-desc">Settlement by tile type</div>
            </div>
            <div class="param-value">T1, T2</div>
          </div>
          <div class="param-row">
            <div>
              <div class="param-name">s0, s1</div>
              <div class="param-desc">Settler survival</div>
            </div>
            <div class="param-value">0.7–0.9</div>
          </div>
          <div class="param-row">
            <div>
              <div class="param-name">reef_prop</div>
              <div class="param-desc">Allocation to reef</div>
            </div>
            <div class="param-value">0.5–0.75</div>
          </div>
          <div class="param-row">
            <div>
              <div class="param-name">lab_max</div>
              <div class="param-desc">Max lab capacity</div>
            </div>
            <div class="param-value">~10,000</div>
          </div>
        </div>
        <div>
          <h3 style="font-size: 11px; color: #7c3aed; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.1em;">Orchard</h3>
          <div class="param-row">
            <div>
              <div class="param-name">orchard_yield</div>
              <div class="param-desc">Larvae collection %</div>
            </div>
            <div class="param-value">0.001</div>
          </div>
          <div class="param-row">
            <div>
              <div class="param-name">trans_mats</div>
              <div class="param-desc">Transplant schedules</div>
            </div>
            <div class="param-value">matrix</div>
          </div>
          <div class="param-row">
            <div>
              <div class="param-name">orchard_size</div>
              <div class="param-desc">Max nursery capacity</div>
            </div>
            <div class="param-value">varies</div>
          </div>
          <div class="param-row">
            <div>
              <div class="param-name">lambda</div>
              <div class="param-desc">External recruitment</div>
            </div>
            <div class="param-value">~10,000</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Size classes data
    const sizeClasses = [
      { id: 1, label: 'SC1', range: '0–10', unit: 'cm²', r: 20 },
      { id: 2, label: 'SC2', range: '10–100', unit: 'cm²', r: 26 },
      { id: 3, label: 'SC3', range: '100–900', unit: 'cm²', r: 32 },
      { id: 4, label: 'SC4', range: '900–4000', unit: 'cm²', r: 38 },
      { id: 5, label: 'SC5', range: '>4000', unit: 'cm²', r: 44 }
    ];

    // Draw lifecycle diagram
    const lifecycle = d3.select('#lifecycle');

    // Arrow markers
    const defs = lifecycle.append('defs');
    defs.append('marker').attr('id', 'arrow-green').attr('viewBox', '0 -4 8 8').attr('refX', 6).attr('refY', 0)
      .attr('markerWidth', 5).attr('markerHeight', 5).attr('orient', 'auto')
      .append('path').attr('d', 'M0,-3L8,0L0,3Z').attr('fill', '#22c55e');
    defs.append('marker').attr('id', 'arrow-gray').attr('viewBox', '0 -4 8 8').attr('refX', 6).attr('refY', 0)
      .attr('markerWidth', 4).attr('markerHeight', 4).attr('orient', 'auto')
      .append('path').attr('d', 'M0,-3L8,0L0,3Z').attr('fill', '#555');
    defs.append('marker').attr('id', 'arrow-purple').attr('viewBox', '0 -4 8 8').attr('refX', 6).attr('refY', 0)
      .attr('markerWidth', 4).attr('markerHeight', 4).attr('orient', 'auto')
      .append('path').attr('d', 'M0,-3L8,0L0,3Z').attr('fill', '#a855f7');

    const lcY = 100;
    const lcStartX = 50;
    const lcSpacing = 75;

    // Growth arrows
    for (let i = 0; i < 4; i++) {
      const x1 = lcStartX + i * lcSpacing + sizeClasses[i].r + 5;
      const x2 = lcStartX + (i+1) * lcSpacing - sizeClasses[i+1].r - 8;
      lifecycle.append('path')
        .attr('d', `M${x1},${lcY - 15} L${x2},${lcY - 15}`)
        .attr('stroke', '#22c55e').attr('stroke-width', 2).attr('fill', 'none')
        .attr('marker-end', 'url(#arrow-green)');
    }

    // Shrinkage arrows
    for (let i = 1; i < 5; i++) {
      const x1 = lcStartX + i * lcSpacing - sizeClasses[i].r - 5;
      const x2 = lcStartX + (i-1) * lcSpacing + sizeClasses[i-1].r + 8;
      lifecycle.append('path')
        .attr('d', `M${x1},${lcY + 15} L${x2},${lcY + 15}`)
        .attr('stroke', '#555').attr('stroke-width', 1.5).attr('stroke-dasharray', '4,3').attr('fill', 'none')
        .attr('marker-end', 'url(#arrow-gray)');
    }

    // Fragmentation arrows from SC4, SC5
    [3, 4].forEach((i, idx) => {
      const startX = lcStartX + i * lcSpacing;
      const endX = lcStartX;
      lifecycle.append('path')
        .attr('d', `M${startX},${lcY + sizeClasses[i].r + 5} Q${(startX + endX)/2},${lcY + 70 + idx*15} ${endX},${lcY + sizeClasses[0].r + 5}`)
        .attr('stroke', '#a855f7').attr('stroke-width', 1.5).attr('fill', 'none')
        .attr('marker-end', 'url(#arrow-purple)');
    });

    // Nodes
    sizeClasses.forEach((sc, i) => {
      const cx = lcStartX + i * lcSpacing;
      const g = lifecycle.append('g').attr('class', 'lifecycle-node').attr('transform', `translate(${cx}, ${lcY})`);

      g.append('circle').attr('r', sc.r).attr('fill', '#16a34a').attr('opacity', 0.8 + i * 0.05);
      g.append('text').attr('class', 'lifecycle-label').attr('dy', '-0.1em').text(sc.label);
      g.append('text').attr('class', 'lifecycle-size').attr('dy', '1.2em').text(sc.range);
    });

    // Legend
    lifecycle.append('text').attr('x', 30).attr('y', 200).attr('fill', '#22c55e').attr('font-size', 10).text('→ Growth');
    lifecycle.append('text').attr('x', 100).attr('y', 200).attr('fill', '#555').attr('font-size', 10).text('⇢ Shrinkage');
    lifecycle.append('text').attr('x', 190).attr('y', 200).attr('fill', '#a855f7').attr('font-size', 10).text('↷ Fragmentation');

    // Transition matrix
    const matrix = d3.select('#matrix');
    const mSize = 36;
    const mStart = 60;

    // Example transition probabilities
    const transData = [
      [0.5, 0.3, 0.0, 0.0, 0.0],
      [0.2, 0.4, 0.2, 0.0, 0.0],
      [0.0, 0.2, 0.5, 0.2, 0.0],
      [0.0, 0.0, 0.2, 0.5, 0.2],
      [0.0, 0.0, 0.0, 0.3, 0.6]
    ];

    // Color scale
    const colorScale = d3.scaleSequential(d3.interpolateGreens).domain([0, 0.7]);

    // Draw cells
    transData.forEach((row, i) => {
      row.forEach((val, j) => {
        matrix.append('rect')
          .attr('class', 'matrix-cell')
          .attr('x', mStart + j * mSize)
          .attr('y', 30 + i * mSize)
          .attr('width', mSize)
          .attr('height', mSize)
          .attr('fill', val > 0 ? colorScale(val) : '#1a1a1a');

        if (val > 0) {
          matrix.append('text')
            .attr('class', 'matrix-label')
            .attr('x', mStart + j * mSize + mSize/2)
            .attr('y', 30 + i * mSize + mSize/2 + 3)
            .attr('fill', val > 0.3 ? '#000' : '#888')
            .text(val.toFixed(1));
        }
      });
    });

    // Row/col labels
    ['1','2','3','4','5'].forEach((l, i) => {
      matrix.append('text').attr('x', mStart + i * mSize + mSize/2).attr('y', 22)
        .attr('text-anchor', 'middle').attr('fill', '#666').attr('font-size', 10).text(`SC${l}`);
      matrix.append('text').attr('x', mStart - 10).attr('y', 30 + i * mSize + mSize/2 + 3)
        .attr('text-anchor', 'end').attr('fill', '#666').attr('font-size', 10).text(`SC${l}`);
    });

    matrix.append('text').attr('x', mStart + 2.5 * mSize).attr('y', 12)
      .attr('text-anchor', 'middle').attr('fill', '#555').attr('font-size', 9).text('To size class');
    matrix.append('text').attr('x', 15).attr('y', 30 + 2.5 * mSize)
      .attr('text-anchor', 'middle').attr('fill', '#555').attr('font-size', 9)
      .attr('transform', `rotate(-90, 15, ${30 + 2.5 * mSize})`).text('From');

    // Note
    matrix.append('text').attr('x', 280).attr('y', 60).attr('fill', '#555').attr('font-size', 10).text('Diagonal = stasis');
    matrix.append('text').attr('x', 280).attr('y', 78).attr('fill', '#22c55e').attr('font-size', 10).text('Above = growth');
    matrix.append('text').attr('x', 280).attr('y', 96).attr('fill', '#888').attr('font-size', 10).text('Below = shrinkage');

    // Lab tiles
    const tiles = d3.select('#tiles');
    const tileData = [
      { id: 'T1_0', type: 'T1', retention: '0', label: 'Cement', sub: 'Immediate', x: 50, color: '#1d4ed8' },
      { id: 'T1_1', type: 'T1', retention: '1', label: 'Cement', sub: '1-year hold', x: 150, color: '#1e40af' },
      { id: 'T2_0', type: 'T2', retention: '0', label: 'Ceramic', sub: 'Immediate', x: 250, color: '#0891b2' },
      { id: 'T2_1', type: 'T2', retention: '1', label: 'Ceramic', sub: '1-year hold', x: 350, color: '#0e7490' }
    ];

    tileData.forEach(t => {
      const g = tiles.append('g').attr('transform', `translate(${t.x}, 80)`);
      g.append('rect').attr('class', 'tile-box').attr('x', -40).attr('y', -35).attr('width', 80).attr('height', 70).attr('fill', t.color);
      g.append('text').attr('class', 'tile-label').attr('y', -8).text(t.label);
      g.append('text').attr('class', 'tile-sub').attr('y', 10).text(t.sub);
      g.append('text').attr('y', 55).attr('text-anchor', 'middle').attr('fill', '#555').attr('font-size', 10).text(t.id);
    });

    tiles.append('text').attr('x', 200).attr('y', 170).attr('text-anchor', 'middle').attr('fill', '#666').attr('font-size', 11)
      .text('0_ = outplant immediately | 1_ = retain 1 year');

    // Orchard diagram
    const orchard = d3.select('#orchard');

    // Broodstock representation
    const broodX = [80, 160, 240, 320];
    broodX.forEach((x, i) => {
      const g = orchard.append('g').attr('transform', `translate(${x}, 80)`);
      const size = 25 + i * 8;
      g.append('circle').attr('r', size).attr('fill', '#7c3aed').attr('opacity', 0.6 + i * 0.1);
      g.append('text').attr('text-anchor', 'middle').attr('dy', '0.35em').attr('fill', 'white').attr('font-size', 10).text(`SC${i+2}`);
    });

    // Arrows out
    orchard.append('path').attr('d', 'M200,130 L200,160').attr('stroke', '#a855f7').attr('stroke-width', 2).attr('marker-end', 'url(#arrow-purple)');
    orchard.append('text').attr('x', 200).attr('y', 180).attr('text-anchor', 'middle').attr('fill', '#666').attr('font-size', 10).text('larvae → Lab');

    orchard.append('path').attr('d', 'M320,130 Q350,150 350,160').attr('stroke', '#22c55e').attr('stroke-width', 2).attr('fill', 'none').attr('marker-end', 'url(#arrow-green)');
    orchard.append('text').attr('x', 360).attr('y', 180).attr('text-anchor', 'middle').attr('fill', '#666').attr('font-size', 10).text('transplant → Reef');

    orchard.append('text').attr('x', 200).attr('y', 25).attr('text-anchor', 'middle').attr('fill', '#888').attr('font-size', 11).text('Nursery maintains broodstock across size classes');
  </script>
</body>
</html>

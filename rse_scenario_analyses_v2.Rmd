---
title: "rse_scenario_analyses_v2"
output: html_document
date: "2025-08-29"
---

README: updated scenario analyses using the simplified version of the model

start by remaking the plots I already have, then make plots with money invested vs. coral cover for the different strategies (e.g., lines for 100%, 50%, and 0% ceramic)

from Fundemar data
-- use 0.01 for survival of first size class/newly outplanted recruits

--estimates of number of eggs from colonies (but don't know colony sizes): min = ~5200, 25% quantile = ~30000, 50% = ~93000, 75% = ~100000, max = ~140000, mean = ~72000



load the functions

```{r}

source("coral_demographic_funs.R")
source("rse_funs.R")
```

reef areas

estimated from the kml file:
-- 1.11 ac = 4492.011 m2
-- 2.49 ac = 10076.67 m2
-- 2.21 ac = 8943.55 m2

```{r}

A_reef <- mean(c(4492.011, 10076.67, 8943.55))

```


# Scenario 1 tile types


function relating total invested to lab_max

```{r}

# assume each tile can hold a max of 10 settlers, and ceramic are $2 each and cement are $1 each

# $200 = $100 ceramic or $200 cement

# inv_tot = total money invested
# prop_ceramic = proportion tiles that are ceramic
# p_ceramic = price per ceramic tile
# p_cement = price per cement tile
lab_max_fun <- function(inv_tot, prop_tiles, p_ceramic, p_cement, sett_per_tile){
  
  # get number of tiles
  # inv_tot = p_ceramic*prop_tiles*x + p_cement*(1-prop_tiles)*x
  # inv_tot = a*x + b*x = (a+b)*x
  # x = (inv_tot)/(a + b)
  
  n_tiles <- floor(inv_tot/(p_ceramic*prop_tiles + p_cement*(1-prop_tiles)))
  
  lab_max <- n_tiles*sett_per_tile
  
  return(lab_max)
    
}

# lab_max_fun(inv_tot = 20, prop_tiles = 0.25, p_ceramic = 2, p_cement = 1, sett_per_tile = 10)/10
# 
# 16*0.25*2 + 16*0.75*1

# p_ceramic = 2, p_cement = 1, sett_per_tile = 10

# reverse: inv_tot from lab max
# n_tiles = lab_max/sett_per_tile
# inv_tot = (p_ceramic*prop_tiles + p_cement*(1-prop_tiles))*lab_max/sett_per_tile

```


```{r}

years <- 20
n <- 5

A_mids <- c(0.1, 43, 369, 2158, 11171) # mean areas in each size class (cm^2)

A_reef <- mean(c(4492.011, 10076.67, 8943.55)) # area of the reef

orchard_treatments <- c("orchard1") # orchards (could have multiple orchards and/or orchards with different post-outplanting treatments)
reef_treatments <- c("reef1") # reef treatments/subpopulations (could have "urchin outplanting" or "algal removal" or other postoutplanting treatments)
lab_treatments <- c("0_T1", "0_T2") # lab (cement = T1, ceramic = T2). "TX" is tile type, "X_" indicates whether recruits are outplanted immediately (0_) or the next year (0_1)


# demographic parameters for each orchard and reef treatment/subpopulation
# reef parameters: survival
surv_pars.r <- list()
surv_pars.r[[1]] <- list() # first reef treatment/subpop
surv_pars.r[[1]][[1]] <- c(0.01, 0.44, 0.53, 0.70, 0.84) # survival probabilities for first source of recruits to first reef subpop (external recruits)
surv_pars.r[[1]][[2]] <- c(0.005, 0.44, 0.53, 0.70, 0.84) # survival probabilities for second source of recruits to first reef subpop (first lab treatment = cement)
surv_pars.r[[1]][[3]] <- c(0.1, 0.44, 0.53, 0.70, 0.84) # survival probabilities for third source of recruits to first reef subpop (second lab treatment = ceramic)
# if there were more reef treatments/subpopulations:
# surv_pars.r[[2]] <- list(), then define surv_pars.r[[2]][[1]], [[2]][[2]], [[2]][[3]]

# density dependent survival (smallest size class only for now)
dens_pars.r <- list()
dens_pars.r[[1]] <- list() # first reef treatment/subpop
dens_pars.r[[1]][[1]] <- 0
dens_pars.r[[1]][[2]] <- dens_pars.r[[1]][[1]]
dens_pars.r[[1]][[3]] <- dens_pars.r[[1]][[1]]

# reef parameters: growth
growth_pars.r <- list()
growth_pars.r[[1]] <- list() # second reef subpop (intervention)
growth_pars.r[[1]][[1]] <- list(c(0.5, 0, 0, 0), c(0.12, 0, 0), c(0.11, 0), 0.07, NULL) 
growth_pars.r[[1]][[2]] <- growth_pars.r[[1]][[1]] # second source (first lab treatment)
growth_pars.r[[1]][[3]] <- growth_pars.r[[1]][[1]] # third source (third lab treatment)

# reef parameters: shrinkage
shrink_pars.r <- list()
shrink_pars.r[[1]] <- list() # second subpop
shrink_pars.r[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.12), c(0, 0.02, 0.22), c(0, 0, 0, 0.09)) # first source 
shrink_pars.r[[1]][[2]] <- shrink_pars.r[[1]][[1]] # second source
shrink_pars.r[[1]][[3]] <- shrink_pars.r[[1]][[1]] # third source

# reef parameters: fragmentation
frag_pars.r <- list()
frag_pars.r[[1]] <- list() # second subpop
frag_pars.r[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0.09, 0.06), c(0, 0.41, 0.31, 0.03)) 
frag_pars.r[[1]][[2]] <- frag_pars.r[[1]][[1]] # second source
frag_pars.r[[1]][[3]] <- frag_pars.r[[1]][[1]] # third source

# reef parameters: fecundity (for tracking reef reproductive output)
fec_pars.r <- list()
fec_pars.r[[1]] <- list()
fec_pars.r[[1]][[1]] <- c(0, 0, 5000, 50000, 100000)
fec_pars.r[[1]][[2]] <- fec_pars.r[[1]][[1]]
fec_pars.r[[1]][[3]] <- fec_pars.r[[1]][[1]]

# orchard parameters: survival
surv_pars.o <- list()
surv_pars.o[[1]] <- list() # first treatment
surv_pars.o[[1]][[1]] <- c(0.010, 0.44, 0.53, 0.70, 0.84) # first source (first lab treatment)
surv_pars.o[[1]][[2]] <- surv_pars.o[[1]][[1]] # second source (second lab treatment)

# density dependent survival (smallest size class only for now)
dens_pars.o <- list()
dens_pars.o[[1]] <- list() # first orchard
dens_pars.o[[1]][[1]] <- 0
dens_pars.o[[1]][[2]] <- dens_pars.o[[1]][[1]]

# orchard parameters: growth
growth_pars.o <- list()
growth_pars.o[[1]] <- list() # first treatment
growth_pars.o[[1]][[1]] <- list(c(0.5, 0, 0, 0), c(0.12, 0, 0), c(0.11, 0), 0.07, NULL)   # first source
growth_pars.o[[1]][[2]] <- growth_pars.o[[1]][[1]] # second source

# orchard parameters: shrinkage
shrink_pars.o <- list()
shrink_pars.o[[1]] <- list() # first treatment
shrink_pars.o[[1]][[1]] <- list(NULL, c(0.01), c(0, 0.12), c(0, 0.02, 0.22), c(0, 0, 0, 0.09)) # first source
shrink_pars.o[[1]][[2]] <- shrink_pars.o[[1]][[1]] # second source

# orchard parameters: fragmentation
frag_pars.o <- list()
frag_pars.o[[1]] <- list() # first treatment
frag_pars.o[[1]][[1]] <- list(NULL, c(0), c(0, 0), c(0, 0, 0), c(0, 0, 0, 0)) # first source
frag_pars.o[[1]][[2]] <- frag_pars.o[[1]][[1]] # second source

fec_pars.o <- list()
fec_pars.o[[1]] <- list() # first treatment
fec_pars.o[[1]][[1]] <- c(0, 0, 5000, 50000, 100000) # first source
fec_pars.o[[1]][[2]] <- fec_pars.o[[1]][[1]] # second source

lambda <- 0 # external recruitment to reef

lambda_R <- 500000 # mean number of larvae produced by reference reefs each year

# stochasticity parameters
sigma_s <- 0
sigma_f <- 0
ext_rand <- c(FALSE, FALSE)
seeds <- c(1000, 5000, 10000, 40000)

# initial conditions in each reef subpopulation
N0.r <- list()
N0.r[[1]] <- list() # second reef subpop
N0.r[[1]][[1]] <- rep(0, n) # first source (external recruits)
N0.r[[1]][[2]] <- rep(0, n) # second source
N0.r[[1]][[3]] <- rep(0, n) # third source

# initial conditions in each orchard subpopulation
N0.o <- list()
N0.o[[1]] <- list() # first orchard treatment
N0.o[[1]][[1]] <- rep(0, n) # first source
N0.o[[1]][[2]] <- rep(0, n) # second source

N0.l <- list()
N0.l[[1]] <- 0
N0.l[[2]] <- 0


# disturbance parameters
dist_yrs <- c(years + 10) # years when disturbance occurs, can set to > years for none

# effects of disturbance on each reef subpop
dist_effects.r <- list()
dist_effects.r[[1]] <- list() # list where each element is the effects of disturbance on corals from each source in the 1st reef subpop (either "survival" for survival, "Tmat" for growth/survival, "Fmat" for fragmentation, or "fecundity" for reproduction)
dist_effects.r[[1]][[1]] <- list() # effects of disturbances on corals from first source in first reef subpop
dist_effects.r[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)
dist_effects.r[[1]][[2]] <- list() # second source
dist_effects.r[[1]][[2]][[1]] <- c("survival")
dist_effects.r[[1]][[3]] <- list() # third source
dist_effects.r[[1]][[3]][[1]] <- c("survival")


# disturbance parameters for each reef subpop (what happens to the population parameters at each disturbance eve)
dist_pars.r <- list()

# first reef population
dist_pars.r[[1]] <- list() 
# first source to second reef subpop
dist_pars.r[[1]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[1]][[1]], dist_surv0 = list(surv_pars.r[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) # list of disturbance parameters for the first source to the first reef population (defaults for each parameter type are NULL unless the disturbance affects them, as specified in dist_effects)
# second source to second reef subpop
dist_pars.r[[1]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[1]][[2]], dist_surv0 = list(surv_pars.r[[1]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)
# third source to second reef subpop
dist_pars.r[[1]][[3]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[1]][[3]], dist_surv0 = list(surv_pars.r[[1]][[3]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)

# disturbance effects for each orchard subpop
dist_effects.o <- list()

dist_effects.o[[1]] <- list() 
dist_effects.o[[1]][[1]] <- list() # effects of disturbances on corals from first source in first orchard treatment
dist_effects.o[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)
dist_effects.o[[1]][[2]] <- list() # second source
dist_effects.o[[1]][[2]][[1]] <- c("survival")


# disturbance parameters for each orchard subpop
dist_pars.o <- list()

# first orchard treatment
dist_pars.o[[1]] <- list() 
# first source in first orchard treatment
dist_pars.o[[1]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[1]][[1]], dist_surv0 = list(surv_pars.o[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) 
# second source in first orchard treatment
dist_pars.o[[1]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[1]][[2]], dist_surv0 = list(surv_pars.o[[1]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)


# lab parameters
s0 <- c(0.9, 0.9) # fraction of settled larvae in each lab treatment that survive to immediate outplanting
s1 <- c(0.7, 0.7) # fraction of settled larvae in each lab treatment that survive to 1 yr outplanting
m0 <- c(0, 0) # density dependent mortality rate of larvae in each lab treatment that get outplanted immediately
m1 <- c(0, 0) # density dependent mortality rate of larvae in each lab treatment that get outplanted after 1 year
sett_props <- list(T1 = 0.85, T2 = 0.5) # proportion of larvae that settle on each tile type (1 = cement, 2 = ceramic)
size_props <- matrix(NA, nrow = length(lab_treatments), ncol = n) # matrix for fractions of retained recruits in each size class at the end of their year in the lab
size_props[1, ] <- c(1, 0, 0, 0, 0) # first lab treatment (0_T1)
size_props[2, ] <- c(1, 0, 0, 0, 0) # second lab treatment (0_T2)
lab_pars <- list(s0 = s0, s1 = s1, m0 = m0, m1 = m1, sett_props = sett_props, size_props = size_props)

# restoration strategy parameters
tile_props <- list(T1 = 0.5, T2 = 0.5) # proportion of tiles that are each type
orchard_yield <- 0 # percent of new orchard babies successfully collected
reef_yield <- 0.001 # percent of new reef babies successfully collected and fertilized
reef_prop <- c(0.5, 0.5) # proportion of lab recruits from each lab treatment outplanted to reef (1-proportion outplanted to orchard)
reef_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(reef_treatments)) # proportion recruits going from each lab treatment to each reef treatment (row = origin lab treatment, column = destination reef treatment)
reef_out_props[1,] <- c(1) # from first lab treatment to each reef treatment (here there's just on intervention reef so they all go there)
reef_out_props[2,] <- c(1) # from second lab treatment to each reef treatment 

orchard_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(orchard_treatments)) # proportion recruits going from each lab treatment to each orchard treatment
orchard_out_props[1,] <- c(1) # from first lab treatment to each orchard 
orchard_out_props[2,] <- c(1) # from second lab treatment to each orchard 

# sizes allocated to each treatment
reef_areas <- c(A_reef)*10000 # m^2 given to each post-outplanting reef treatment/subpopulation, convert to cm^2 by multiplying by 10,000
lab_max <- c(2500) # total number of settlers that the lab can accommodate
lab_retain_max <- c(1200) # total number of settlers that the lab can keep for a year
orchard_size <- c(200) # number of individuals each orchard treatment has space for

# coral transplanting
transplant <- rep(0, years) # years in which corals get transplanted from the orchard
#transplant[10] <- 1 # in 10th year, move corals from orchard to reef

null_mat <- matrix(0, nrow = years, ncol = n)
#rest_pars$trans_mats[[1]][[1]][which(transplant!=0)[1],] <- c(0, 0, 0, 2,0)# max number of colonies of each size class to move to reef in first transplant event
trans_mats <- list()
trans_mats[[1]] <- list() # first orchard 
trans_mats[[1]][[1]] <- null_mat # number of corals in each size class that originated from the first source of colonies for this orchard to transplant at each timepoint
trans_mats[[1]][[2]] <- null_mat # number of corals in each size class that originated from the second source of colonies for this orchard to transplant at each timepoint

# trans_mats[[2]] <- list() # second orchard
# trans_mats[[2]][[1]] <- null_mat # first source
# trans_mats[[2]][[2]] <- null_mat # second source

# where on the reef to put the transplants
#rest_pars$trans_reef[[1]][[1]][which(transplant!=0)[1],] <- c(1, 1)# reef and source subpop to transport the corals to
trans_reef <- list()
trans_reef[[1]] <- list() # first orchard
trans_reef[[1]][[1]] <- matrix(c(1, 2), nrow = years, ncol = 2, byrow = T) # first source corals in this orchard get transplanted to the second source of corals in the first reef
trans_reef[[1]][[2]] <- matrix(c(1, 3), nrow = years, ncol = 2, byrow = T) # second source corals in this orchard get transplanted to the third source of corals in the second reef

rest_pars <- list(tile_props = tile_props, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)


sim1 <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars, N0.r, N0.o, N0.l)

```


```{r}
# plot results

reef1_tot <- apply(sim1$reef_pops_pre[[1]][[1]], MARGIN = 2, sum) + apply(sim1$reef_pops_pre[[1]][[2]], MARGIN = 2, sum) + apply(sim1$reef_pops_pre[[1]][[3]], MARGIN = 2, sum)
orch1_tot <- apply(sim1$orchard_pops_pre[[1]][[1]], MARGIN = 2, sum) + apply(sim1$orchard_pops_pre[[1]][[2]], MARGIN = 2, sum)

plot(x = c(1:years), y = reef1_tot, type = "l", las = 1, ylim = c(0, max(max(reef1_tot), max(orch1_tot))), xlab = "year", ylab = "Pop'n size", lwd = 2)
lines(x = c(1:years), y = orch1_tot, type = "l", col = "dodgerblue", lwd = 2, lty = 2)
legend("topleft", legend = c("reef", "orchard"), col = c("black", "dodgerblue"), lwd = 2, lty = c(1, 2))


```



## basic timeseries


100% ceramic, 0% ceramic, and 50%

```{r}

tile_props.100 <- list(T1 = 0, T2 = 1) # proportion cement vs. ceramic
rest_pars.100 <- list(tile_props = tile_props.100, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)


T2_100 <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.100, N0.r, N0.o, N0.l)

tile_props.50 <- list(T1 = 0.5, T2 = 0.5) # proportion cement vs. ceramic
rest_pars.50 <- list(tile_props = tile_props.50, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_50 <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.50, N0.r, N0.o, N0.l)

tile_props.0 <- list(T1 = 1, T2 = 0) # proportion cement vs. ceramic
rest_pars.0 <- list(tile_props = tile_props.0, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_0 <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.0, N0.r, N0.o, N0.l)

reef_100 <- apply(T2_100$reef_pops_pre[[1]][[1]], MARGIN = 2, sum) + apply(T2_100$reef_pops_pre[[1]][[2]], MARGIN = 2, sum) + apply(T2_100$reef_pops_pre[[1]][[3]], MARGIN = 2, sum)

reef_50 <- apply(T2_50$reef_pops_pre[[1]][[1]], MARGIN = 2, sum) + apply(T2_50$reef_pops_pre[[1]][[2]], MARGIN = 2, sum) + apply(T2_50$reef_pops_pre[[1]][[3]], MARGIN = 2, sum)

reef_0 <- apply(T2_0$reef_pops_pre[[1]][[1]], MARGIN = 2, sum) + apply(T2_0$reef_pops_pre[[1]][[2]], MARGIN = 2, sum) + apply(T2_0$reef_pops_pre[[1]][[3]], MARGIN = 2, sum)

plot(x = c(1:years), y = reef_100, type = "l", las = 1)
lines(x = c(1:years), y = reef_50, type = "l")
lines(x = c(1:years), y = reef_0, type = "l")

# plot cover (m2) instead

reef_100p <- rep(NA, years)

for(i in 1:years){
  
  reef_100p[i] <- (sum(T2_100$reef_pops_pre[[1]][[1]][,i]*A_mids) + sum(T2_100$reef_pops_pre[[1]][[2]][,i]*A_mids) + sum(T2_100$reef_pops_pre[[1]][[3]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}

reef_0p <- rep(NA, years)

for(i in 1:years){
  
  reef_0p[i] <- (sum(T2_0$reef_pops_pre[[1]][[1]][,i]*A_mids) + sum(T2_0$reef_pops_pre[[1]][[2]][,i]*A_mids) + sum(T2_0$reef_pops_pre[[1]][[3]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}

reef_50p <- rep(NA, years)

for(i in 1:years){
  
  reef_50p[i] <- (sum(T2_50$reef_pops_pre[[1]][[1]][,i]*A_mids) + sum(T2_50$reef_pops_pre[[1]][[2]][,i]*A_mids) + sum(T2_50$reef_pops_pre[[1]][[3]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}


col_set <- c("orchid", "darkorange", "lightgreen")

# calculate cost per year: 
# inv_tot = (p_ceramic*prop_tiles + p_cement*(1-prop_tiles))*lab_max/sett_per_tile
tot_100 <- (2*1 + 1*(1-1))*lab_max/10 # *years
tot_50 <- (2*0.5 + 1*(1-0.5))*lab_max/10
tot_0 <- (2*0 + 1*(1-0))*lab_max/10

plot(x = c(1:years), y = reef_100p, type = "l", las = 1, col = col_set[1], lwd = 2, xlab = NA, ylab = NA)
mtext(side = 1, "Time (years)", line = 2, cex = 1.1)
mtext(side = 2, expression("Coral Cover ("*m^2*")"), line = 1.75, cex = 1.1)
text(x = years-1, y = max(reef_100p)-0.5, paste("$", as.character(tot_100), "/year", sep = ""), col = col_set[1])
text(x = years-1, y = max(reef_50p)-0.5, paste("$", as.character(tot_50), "/year", sep = ""), col = col_set[2])
text(x = years-1, y = max(reef_0p) + 0.25, paste("$", as.character(tot_0), "/year", sep = ""), col = col_set[3])
lines(x = c(1:years), y = reef_50p, type = "l", col = col_set[2], lwd = 2)
lines(x = c(1:years), y = reef_0p, type = "l", col = col_set[3], lwd = 2)
legend("topleft", legend = c("100% ceramic", "[user choice]", "0 % ceramic"), lwd = 2, col = col_set, bty = "n")



```

## ROI

amount invested vs. coral cover on reef

```{r}
inv_set1 <- seq(from = 10, to = 100, length.out = 25)
prop_set1 <- c(0, 0.5, 1)

pop_mat1 <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))
#pcover_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))
area_mat1 <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))

for(i in 1:length(inv_set1)){
  
  for(j in 1:length(prop_set1)){

    
    lab_max.ij <- lab_max_fun(inv_tot = inv_set1[i], prop_tiles = prop_set1[j], p_ceramic = 2, p_cement = 1, sett_per_tile = 10)
    
    #print(lab_max.ij)
    
    tile_props.ij <- list(T1 = 1-prop_set1[j], T2 = prop_set1[j]) 

rest_pars.ij <- list(tile_props = tile_props.ij, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max.ij, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)


  sim.ij <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.ij, N0.r, N0.o, N0.l)
    
  
  # record final population size
  pop_mat1[i,j] <- sum(sim.ij$reef_pops_pre[[1]][[1]][,years]) + sum(sim.ij$reef_pops_pre[[1]][[2]][,years]) + sum(sim.ij$reef_pops_pre[[1]][[3]][,years]) 
  
  # record area covered
  area_mat1[i,j] <- (sum(sim.ij$reef_pops_pre[[1]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[1]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[1]][[3]][,years]*A_mids))/10000
  
  # record final % cover
  #pcover_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[2]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]*A_mids))/sum(reef_areas)*100
  
  }
}

```



```{r}

plot(x = inv_set1, y = area_mat1[,1], type = "l", las = 1, col = col_set[3], lwd = 2, xlab = NA, ylab = NA, ylim = c(0, 0.12))
mtext(side = 1, "$ invested", line = 2, cex = 1.1)
mtext(side = 2, expression("Coral Cover ("*m^2*")"), line = 1.75, cex = 1.1)
lines(x = inv_set1, y = area_mat1[,2], type = "l", col = col_set[2], lwd = 2)
lines(x = inv_set1, y = area_mat1[,3], type = "l", col = col_set[1], lwd = 2)
legend("topleft", legend = c("100% ceramic", "[user choice]", "0 % ceramic"), lwd = 2, col = col_set, bty = "n")


```

leveling out is when lab max is big enough that you can accomodate everybody. This happens sooner the more cement tiles you have because cement tiles are cheaper so you can get a bigger lab max for a given amount spent

## heatmap

proportion tiles and total invested in tiles


```{r}

#inv_set <- seq(from = 20, to = 500, by = 20)
inv_set <- seq(from = 10, to = 100, length.out = 25)
prop_set <- seq(from = 0, to = 1, length.out = 25)

pop_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))
#pcover_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))
area_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))

for(i in 1:length(inv_set)){
  
  for(j in 1:length(prop_set)){

    
    lab_max.ij <- lab_max_fun(inv_tot = inv_set[i], prop_tiles = prop_set[j], p_ceramic = 2, p_cement = 1, sett_per_tile = 10)
    
    #print(lab_max.ij)
    
    tile_props.ij <- list(T1 = 1-prop_set[j], T2 = prop_set[j]) 

rest_pars.ij <- list(tile_props = tile_props.ij, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max.ij, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)


  sim.ij <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.ij, N0.r, N0.o, N0.l)
    
  
  # record final population size
  pop_mat[i,j] <- sum(sim.ij$reef_pops_pre[[1]][[1]][,years]) + sum(sim.ij$reef_pops_pre[[1]][[2]][,years]) + sum(sim.ij$reef_pops_pre[[1]][[3]][,years]) 
  
  # record area covered
  area_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[1]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[1]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[1]][[3]][,years]*A_mids))/10000
  
  # record final % cover
  #pcover_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[2]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]*A_mids))/sum(reef_areas)*100
  
  }
}

```


plot results

```{r}

pop_mat_test <- pop_mat

pop_mat_test[nrow(pop_mat),] <- rep(0, nrow(pop_mat))

pop_mat_test[,ncol(pop_mat)] <- rep(200, ncol(pop_mat))

#filled.contour(pop_mat_test) # x = rows, y = columns


# https://www.rdocumentation.org/packages/graphics/versions/3.6.2/topics/filled.contour
# https://www.rdocumentation.org/packages/graphics/versions/3.6.2/topics/contour
#filled.contour(x = inv_set, y = prop_set, z = pop_mat)

#library(RColorBrewer)

#rampcols <- colorRampPalette(colors = c("lightskyblue1", "darkblue"), space="Lab")(25) # 50 colors from white to blue

# more detailed function description:
# https://stat.ethz.ch/R-manual/R-devel/library/graphics/html/filled.contour.html

filled.contour(x = inv_set, y = prop_set, pop_mat, 
               color.palette = function(n) hcl.colors(n, "blues", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = inv_set, y = prop_set, pop_mat, levels = 100, lwd = 2, drawlabels = F, add = T)})
#legend("topleft", "100", lwd = 2, bty = "n")

#  labcex = 1, method = "flattest", vfont = c("sans serif", "plain")

# drawlabels = F

# brewer.pal.info["Blues",]$maxcolors


filled.contour(x = inv_set, y = prop_set, area_mat, key.title = title(main = expression("Cover ("*m^2*")"), cex.main = 0.8, line = 0.5),
               color.palette = function(n) hcl.colors(n, "blues", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = inv_set, y = prop_set, area_mat, levels = 2, lwd = 2, drawlabels = T, add = T, vfont = c("sans serif", "bold"), labcex = 1.1)})
mtext(side = 1, "Annual $ invested in tiles", line = 2.5, adj = 0.25)
mtext(side = 2, "Prop. ceramic", line = 2.5)


# no label
filled.contour(x = inv_set, y = prop_set, area_mat, key.title = title(main = expression("Cover ("*m^2*")"), cex.main = 0.8, line = 0.5),
               color.palette = function(n) hcl.colors(n, "blues", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = inv_set, y = prop_set, area_mat, levels = 2, lwd = 2, drawlabels = F, add = T)})
mtext(side = 1, "Annual $ invested in tiles", line = 2, adj = 0.25, cex = 1.1)
mtext(side = 2, "Prop. ceramic", line = 2.5, cex = 1.1)

# vfont information: https://stat.ethz.ch/R-manual/R-devel/library/grDevices/html/Hershey.html

# main = "Coral cover", sub = expression("("*m^2*")"), cex.main = 0.5, cex.sub = 0.5
```

NOTE: if the amount invested is always large enough that lab_max is greater than the number of larvae, then you won't see any effect of varying amount invested (and this happens sooner with a higher proportion of cement tiles since cement are cheaper so you get a bigger lab max for a given amount spent)




---
title: "rse_scenario_analyses_v2"
output: html_document
date: "2025-08-29"
---

README: updated scenario analyses using the simplified version of the model with parameters informed by literature search


from Fundemar data
--estimates of number of eggs from colonies (but don't know colony sizes): min = ~5200, 25% quantile = ~30000, 50% = ~93000, 75% = ~100000, max = ~140000, mean = ~72000



load the functions

```{r}

source("coral_demographic_funs.R")
source("rse_funs.R")
```

reef areas

rough estimates from the kml file shared by Fundemar:
-- 1.11 ac = 4492.011 m2
-- 2.49 ac = 10076.67 m2
-- 2.21 ac = 8943.55 m2

```{r}

A_reef <- mean(c(4492.011, 10076.67, 8943.55)) # area of the reef

n <- 5

# define size classes
SC1 <- 0
SC2 <- 10
SC3 <- 100
SC4 <- 900
SC5 <- 4000

A_mids <- c((SC1 + SC2)/2, (SC2 + SC3)/2, (SC3 + SC4)/2, (SC4 + SC5)/2, 9325) # midpoint areas of each size class (cm^2); last value is the 50% quantile of observations greater than SC5 in the standardized data from the literature


```

# Scenario 1: tile types

hold off on this until checking with Fundemar about whether their data can be used to estimate settlement rates on cement vs. ceramic tiles


# Scenario 2: lab retention times




# Scenario 3: orchard expansion

Future scenario: collecting gametes from the orchard not natural reefs. For simplicity assume you are starting with a mature orchard (so it makes sense to collect from it) and the question is whether to expand it? then plot prop. recruits going to orchard on the x-axis and reef pop'n size on the y-axis at 2 years and 10 years (or something like that... expect benefits to materialize over longer time periods since it takes some time for the orchard recruits to mature)


Eventually will want to allow collection from orchard vs. reef to be flexible (incorporate feedbacks where orchard collection only starts once there are mature orchard colonies)?


parameter set up

```{r}

years <- 50

orchard_treatments <- c("orchard1") # orchards (could have multiple orchards and/or orchards with different post-outplanting treatments)
reef_treatments <- c("reef1") # reef treatments/subpopulations (could have "urchin outplanting" or "algal removal" or other postoutplanting treatments)
lab_treatments <- c("0_T1") # lab (cement = T1, ceramic = T2). "TX" is tile type, "X_" indicates whether recruits are outplanted immediately (0_) or the next year (0_1)

# use mean values here to get basic time series to check everything is working
all_pars <- default_pars_fun(n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments), summ_metric_list = list(field_surv = "mean", field_growth = "mean", field_shrink = "mean", field_frag = "mean", nurs_surv = "mean", nurs_growth = "mean", nurs_shrink = "mean"), field_surv1, field_growth1, nurs_surv1, nurs_growth1, apal_frag_summ)


#all_pars <- default_pars_fun(n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments), summ_metric_list = list(field_surv = "Q05", field_growth = "Q05", field_shrink = "Q05", field_frag = "Q05", nurs_surv = "Q05", nurs_growth = "Q05", nurs_shrink = "Q05"), field_surv1, field_growth1, nurs_surv1, nurs_growth1, apal_frag_summ)

#all_pars <- default_pars_fun(n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments), summ_metric_list = list(field_surv = "Q95", field_growth = "Q95", field_shrink = "Q95", field_frag = "Q95", nurs_surv = "Q95", nurs_growth = "Q95", nurs_shrink = "Q95"), field_surv1, field_growth1, nurs_surv1, nurs_growth1, apal_frag_summ)


# demographic parameters for each orchard and reef treatment/subpopulation
# density dependent survival (smallest size class only for now)
dens_pars.r <- list()
dens_pars.r[[1]] <- list() # first reef treatment/subpop
dens_pars.r[[1]][[1]] <- 0.0001
dens_pars.r[[1]][[2]] <- dens_pars.r[[1]][[1]]
#dens_pars.r[[1]][[3]] <- dens_pars.r[[1]][[1]]

# reef parameters: fecundity (for tracking reef reproductive output)
fec_pars.r <- list()
fec_pars.r[[1]] <- list()
fec_pars.r[[1]][[1]] <- c(0, 0, 5000, 50000, 100000)
fec_pars.r[[1]][[2]] <- fec_pars.r[[1]][[1]]
#fec_pars.r[[1]][[3]] <- fec_pars.r[[1]][[1]]


# reef parameters: survival
surv_pars.r <- all_pars$surv_pars.r
# reef parameters: growth
growth_pars.r <- all_pars$growth_pars.r
# reef parameters: shrinkage
shrink_pars.r <- all_pars$shrink_pars.r
# reef parameters: fragmentation
frag_pars.r <- all_pars$frag_pars.r

# orchard parameters: density dependent survival (smallest size class only for now)
dens_pars.o <- list()
dens_pars.o[[1]] <- list() # first orchard
dens_pars.o[[1]][[1]] <- 0.0001
dens_pars.o[[1]][[2]] <- dens_pars.o[[1]][[1]]

# orchard parameters: fecundity
fec_pars.o <- list()
fec_pars.o[[1]] <- list() # first treatment
fec_pars.o[[1]][[1]] <- c(0, 0, 5000, 50000, 100000) # first source
fec_pars.o[[1]][[2]] <- fec_pars.o[[1]][[1]] # second source


# orchard parameters: survival
surv_pars.o <- all_pars$surv_pars.o
# orchard parameters: growth
growth_pars.o <- all_pars$growth_pars.o
# orchard parameters: shrinkage
shrink_pars.o <- all_pars$shrink_pars.o
# orchard parameters: fragmentation
frag_pars.o <- all_pars$frag_pars.o

lambda <- 0 # external recruitment to reef

lambda_R <- 10000 # mean number of larvae produced by reference reefs each year

# stochasticity parameters
sigma_s <- 0
sigma_f <- 0
ext_rand <- c(FALSE, FALSE)
seeds <- c(1000, 5000, 10000, 40000)

# initial conditions in each reef subpopulation
N0.r <- list()
N0.r[[1]] <- list() # second reef subpop
N0.r[[1]][[1]] <- rep(0, n) # first source (external recruits)
N0.r[[1]][[2]] <- rep(0, n) # second source
N0.r[[1]][[3]] <- rep(0, n) # third source

# initial conditions in each orchard subpopulation
N0.o <- list()
N0.o[[1]] <- list() # first orchard treatment
N0.o[[1]][[1]] <- c(50, 10, 1, 0, 0) # first source
#N0.o[[1]][[2]] <- rep(0, n) # second source

N0.l <- list()
N0.l[[1]] <- 0
N0.l[[2]] <- 0


# disturbance parameters
dist_yrs <- c(years + 10) # years when disturbance occurs, can set to > years for none

# effects of disturbance on each reef subpop
dist_effects.r <- list()
dist_effects.r[[1]] <- list() # list where each element is the effects of disturbance on corals from each source in the 1st reef subpop (either "survival" for survival, "Tmat" for growth/survival, "Fmat" for fragmentation, or "fecundity" for reproduction)
dist_effects.r[[1]][[1]] <- list() # effects of disturbances on corals from first source in first reef subpop
dist_effects.r[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)
dist_effects.r[[1]][[2]] <- list() # second source
dist_effects.r[[1]][[2]][[1]] <- c("survival")
#dist_effects.r[[1]][[3]] <- list() # third source
#dist_effects.r[[1]][[3]][[1]] <- c("survival")


# disturbance parameters for each reef subpop (what happens to the population parameters at each disturbance eve)
dist_pars.r <- list()

# first reef population
dist_pars.r[[1]] <- list() 
# first source to second reef subpop
dist_pars.r[[1]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[1]][[1]], dist_surv0 = list(surv_pars.r[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) # list of disturbance parameters for the first source to the first reef population (defaults for each parameter type are NULL unless the disturbance affects them, as specified in dist_effects)
# second source to second reef subpop
dist_pars.r[[1]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[1]][[2]], dist_surv0 = list(surv_pars.r[[1]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)
# third source to second reef subpop
#dist_pars.r[[1]][[3]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.r[[1]][[3]], dist_surv0 = list(surv_pars.r[[1]][[3]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)

# disturbance effects for each orchard subpop
dist_effects.o <- list()

dist_effects.o[[1]] <- list() 
dist_effects.o[[1]][[1]] <- list() # effects of disturbances on corals from first source in first orchard treatment
dist_effects.o[[1]][[1]][[1]] <- c("survival") # effects of 1st disturbance on corals from first source in first reef subpop ([[1]][[1]][[2]] would be second disturbance, etc.)
dist_effects.o[[1]][[2]] <- list() # second source
dist_effects.o[[1]][[2]][[1]] <- c("survival")


# disturbance parameters for each orchard subpop
dist_pars.o <- list()

# first orchard treatment
dist_pars.o[[1]] <- list() 
# first source in first orchard treatment
dist_pars.o[[1]][[1]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[1]][[1]], dist_surv0 = list(surv_pars.o[[1]][[1]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL) 
# second source in first orchard treatment
#dist_pars.o[[1]][[2]] <- dist_pars_fun(dist_yrs = dist_yrs, dist_effects.o[[1]][[2]], dist_surv0 = list(surv_pars.o[[1]][[2]]*0.1), dist_Tmat0 = NULL, dist_Fmat0 = NULL, dist_fec0 = NULL)


# lab parameters
s0 <- c(0.9, NA) # fraction of settled larvae in each lab treatment that survive to immediate outplanting
s1 <- c(NA, 0.7) # fraction of settled larvae in each lab treatment that survive to 1 yr outplanting
m0 <- c(0, 0) # density dependent mortality rate of larvae in each lab treatment that get outplanted immediately
m1 <- c(0, 0) # density dependent mortality rate of larvae in each lab treatment that get outplanted after 1 year
sett_props <- list(T1 = 0.9) # proportion of larvae that settle on each tile type (1 = cement, 2 = ceramic)
size_props <- matrix(NA, nrow = length(lab_treatments), ncol = n) # matrix for fractions of retained recruits in each size class at the end of their year in the lab
size_props[1, ] <- c(1, 0, 0, 0, 0) # first lab treatment (0_T1)
#size_props[2, ] <- c(1, 0, 0, 0, 0) # second lab treatment (0_T2)
lab_pars <- list(s0 = s0, s1 = s1, m0 = m0, m1 = m1, sett_props = sett_props, size_props = size_props)

# restoration strategy parameters
tile_props <- list(T1 = 1) # proportion of tiles that are each type
orchard_yield <- 0.05 # percent of new orchard babies successfully collected
reef_yield <- 0 # percent of new reef babies successfully collected and fertilized
reef_prop <- c(0.9) # proportion of lab recruits from each lab treatment outplanted to reef (1-proportion outplanted to orchard)
reef_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(reef_treatments)) # proportion recruits going from each lab treatment to each reef treatment (row = origin lab treatment, column = destination reef treatment)
reef_out_props[1,] <- c(1) # from first lab treatment to each reef treatment (here there's just on intervention reef so they all go there)
#reef_out_props[2,] <- c(1) # from second lab treatment to each reef treatment 

orchard_out_props <- matrix(NA, nrow = length(lab_treatments), ncol = length(orchard_treatments)) # proportion recruits going from each lab treatment to each orchard treatment
orchard_out_props[1,] <- c(1) # from first lab treatment to each orchard 
#orchard_out_props[2,] <- c(1) # from second lab treatment to each orchard 

# sizes allocated to each treatment
reef_areas <- c(A_reef)*10000 # m^2 given to each post-outplanting reef treatment/subpopulation, convert to cm^2 by multiplying by 10,000
lab_max <- c(4000*10) # total number of settlers that the lab can accommodate
lab_retain_max <- c(0) # total number of settlers that the lab can keep for a year
orchard_size <- c(30*80) # number of individuals each orchard treatment has space for (80 stars x 30 tiles per star, in reality might be larger if there can be more than one recruit per tile)


# coral transplanting
transplant <- rep(0, years) # years in which corals get transplanted from the orchard
#transplant[10] <- 1 # in 10th year, move corals from orchard to reef

null_mat <- matrix(0, nrow = years, ncol = n)
#rest_pars$trans_mats[[1]][[1]][which(transplant!=0)[1],] <- c(0, 0, 0, 2,0)# max number of colonies of each size class to move to reef in first transplant event
trans_mats <- list()
trans_mats[[1]] <- list() # first orchard 
trans_mats[[1]][[1]] <- null_mat # number of corals in each size class that originated from the first source of colonies for this orchard to transplant at each timepoint
trans_mats[[1]][[2]] <- null_mat # number of corals in each size class that originated from the second source of colonies for this orchard to transplant at each timepoint

# trans_mats[[2]] <- list() # second orchard
# trans_mats[[2]][[1]] <- null_mat # first source
# trans_mats[[2]][[2]] <- null_mat # second source

# where on the reef to put the transplants
#rest_pars$trans_reef[[1]][[1]][which(transplant!=0)[1],] <- c(1, 1)# reef and source subpop to transport the corals to
trans_reef <- list()
trans_reef[[1]] <- list() # first orchard
trans_reef[[1]][[1]] <- matrix(c(1, 2), nrow = years, ncol = 2, byrow = T) # first source corals in this orchard get transplanted to the second source of corals in the first reef
trans_reef[[1]][[2]] <- matrix(c(1, 3), nrow = years, ncol = 2, byrow = T) # second source corals in this orchard get transplanted to the third source of corals in the second reef

rest_pars <- list(tile_props = tile_props, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)


sim1 <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars, N0.r, N0.o, N0.l)

```

```{r}
# plot results

reef1_tot <- model_summ(model_sim = sim1, location = "reef", metric = "ind", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))

orch1_tot <- model_summ(model_sim = sim1, location = "orchard", metric = "ind", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))

plot(x = c(1:years), y = reef1_tot, type = "l", las = 1, ylim = c(0, max(max(reef1_tot), max(orch1_tot))), xlab = "year", ylab = "Pop'n size", lwd = 2)
lines(x = c(1:years), y = orch1_tot, type = "l", col = "dodgerblue", lwd = 2, lty = 2)
legend("topleft", legend = c("reef", "orchard"), col = c("black", "dodgerblue"), lwd = 2, lty = c(1, 2))


```



REMEMBER the reef can still get recruits even if 100% go the the orchard first because any recruits that don't fit in the orchard will get put on the reef anyway (maybe update the model function to make this a parameter: should surplus recruits go to the reef?)


Plots to make: time series (with actual calendar years on the x-axis), then optimization: x-axis = orchard size, y-axis = 1) optimal proportion to outplant for max coral cover after x years, 2) coral cover after x years on orchard and reef at the optimum. Repeat with response = 1) coral area on reef and 2) reef (or orchard?) larval production
-- have multiple lines for multiple years (optimize coral cover 10 years in future, 25 years, 50, 75, etc.)

optimization: tertiary search algorithm? Will need to repeat for each random parameter combination

could also make a trade-off plot to show overlap of multiple objectives: x-axis = orchard size, y-axis = prop outplanted to reef, for each x-axis value calculate the y-values where is greater than some desired threshold value (like the contour lines from the heatmaps). Could then have different colored lines for different thresholds (e.g., blue = reef area is greater than x m2, green = orchard production is greater than x larvae/yr, orange = ROI is greater than x m2/dollar)
-- start at optimum (previously calculated), then use binary search algorithm (one for each size of optima) to find where it drops below threshold? And if optima is less than threshold, then that's just white space on the plot 

Once costs are incorporated: repeat with y-axis = optimal proportion to outplant for max m2 corals on reef per dollar spent? (ROI)
-- as placeholder for now, assume there is some maintenance in the orchard that increases with orchard size (e.g., algal scrubbing)


## optimization functions

```{r}

# function of orchard size, value to optimize ("reef_area", "reef_ROI"), starting bounds, and error tolerance (define other parameters outside the function)

reef_prop_opt <- function(orchard_size, opt_value, left0 = 0, right0 = 1, error_tol = 0.01){
  
  # assign the initial upper and lower reef_prop values
  right <- right0
  left <- left0
  
  # placeholder values for the orchard costs (CHANGE)
        c0 <- 1 # startup costs
        c1 <- 1 # maintenance costs
  
  
  while(right-left > error_tol){ # while the difference btw the upper and lower values is greater than the error tolerance
    
    # calculate the midpoints
    # ternary search algorithm so divide range into thirds
    mid1 <- left + (right-left)/3 # add 1/3 of the range
    mid2 <- right - (right-left)/3 # subtract 1/3 of the range
    
    # run the model with  reef_prop = mid1 and mid2
rest_pars1 <- list(tile_props = tile_props, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = mid1, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

sim1 <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars1, N0.r, N0.o, N0.l)


rest_pars2 <- list(tile_props = tile_props, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = mid2, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

sim2 <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars2, N0.r, N0.o, N0.l)

      if(opt_value == "reef_area"){ # if optimizing area on the reef
        
        # record reef areas
        out1 <- model_summ(model_sim = sim1, location = "reef", metric = "area_m2", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))
        out2 <- model_summ(model_sim = sim2, location = "reef", metric = "area_m2", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))
        
        out1 <- out1[length(out1)]
        out2 <- out2[length(out2)]

        if(out1 > out2){ # if value at the left is greater than value to the right
        right <- mid2 # the max is to the left so make the rightmost point the right midpoint
      } else{
        left <- mid1 # otherwise the max is to the right so make the leftmost point the left midpoint
      }
        
      } # end of if opt_value = "reef_area"

     if(opt_value == "reef_ROI"){ # if optimizing return on investment (area on reef per amount spend on orchard maintenance)
       
       # record reef areas
        out1 <- model_summ(model_sim = sim1, location = "reef", metric = "area_m2", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))
        out2 <- model_summ(model_sim = sim2, location = "reef", metric = "area_m2", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))
        
        out1 <- out1[length(out1)]
        out2 <- out2[length(out2)]

        # record total spent on orchard maintenance
        # baseline cost that depends on orchard size (reef stars) + per area cost of maintaining the orchard colonies each year
        orch1 <- model_summ(model_sim = sim1, location = "orchard", metric = "area_m2", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))
        orch2 <- model_summ(model_sim = sim2, location = "orchard", metric = "area_m2", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))
      
        
        cost1 <- c0*orchard_size + sum(orch1*c1)
        cost2 <- c0*orchard_size + sum(orch2*c1)
        
        out1 <- out1/cost1
        out2 <- out2/cost2
        
        if(out1 > out2){ # if value at the left is greater than value to the right
        right <- mid2 # the max is to the left so make the rightmost point the right midpoint
      } else{
        left <- mid1 # otherwise the max is to the right so make the leftmost point the left midpoint
      }
        
      } # end of if opt_value = "reef_ROI"
      
  } # end of while loop
  
  # record the values at the optimum
 reef_area_opt <- model_summ(model_sim = sim1, location = "reef", metric = "area_m2", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))
 
 orchard_area_opt <- model_summ(model_sim = sim1, location = "orchard", metric = "area_m2", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))
 
 ROI_opt <- c0*orchard_size + sum(orchard_area_opt*c1)
  
  # return optimal reef_prop and the reef and orchard metrics at this optimum
  return(list(reef_prop_opt = mid1, reef_area_opt = reef_area_opt, ROI_opt = ROI_opt, orchard_area_opt = orchard_area_opt)) 
  
  
}

```




test the optimum

```{r}

opt_test <- reef_prop_opt(orchard_size, opt_value = "reef_ROI", left0 = 0, right0 = 1, error_tol = 0.01)

opt_test$reef_prop_opt


prop_set <- seq(from = 0, to = 1, length.out = 100)

area_set <- rep(NA, length(prop_set))

for(i in 1:length(prop_set)){
  
  rest_pars.i <- list(tile_props = tile_props, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = prop_set[i], reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

sim.i <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.i, N0.r, N0.o, N0.l)

areas.i <- model_summ(model_sim = sim.i, location = "reef", metric = "area_m2", n_reef = length(reef_treatments), n_orchard = length(orchard_treatments), n_lab = length(lab_treatments))
  
area_set[i] <- areas.i[length(areas.i)]

}


plot(x = prop_set, y = area_set, type = "l", las = 1)
abline(v = opt_test$reef_prop_opt)

#prop_set[which(area_set == max(area_set))]

```

optimum seems to be very sensitive to how many babies you can get from the orchard (if you get a lot, then you don't need a big orchard). So if you decrease orchard yield and/or orchard fecundity or increase orchard mortality, then you will get a lower optimal proportion
-- it's also sensitive to density dependent mortality rate so try to get a good estimate of that

## basic timeseries

all recruits to orchard, intermediate, all recruits to lab

```{r}


reef_prop.100 <- c(1) 

rest_pars.100 <- list(tile_props = tile_props, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop.100, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_100 <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.100, N0.r, N0.o, N0.l)


reef_prop.50 <- c(0.5) 

rest_pars.50 <- list(tile_props = tile_props, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop.50, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_50 <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.50, N0.r, N0.o, N0.l)

reef_prop.0 <- c(0) 

rest_pars.0 <- list(tile_props = tile_props, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop.0, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

T2_0 <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.0, N0.r, N0.o, N0.l)

# reef population sizes
reef_100 <- apply(T2_100$reef_pops_pre[[1]][[1]], MARGIN = 2, sum) + apply(T2_100$reef_pops_pre[[1]][[2]], MARGIN = 2, sum) 

reef_50 <- apply(T2_50$reef_pops_pre[[1]][[1]], MARGIN = 2, sum) + apply(T2_50$reef_pops_pre[[1]][[2]], MARGIN = 2, sum) 

reef_0 <- apply(T2_0$reef_pops_pre[[1]][[1]], MARGIN = 2, sum) + apply(T2_0$reef_pops_pre[[1]][[2]], MARGIN = 2, sum) 

# orchard production
orchp_100 <- T2_100$orchard_rep[[1]][[1]] 

orchp_50 <- T2_50$orchard_rep[[1]][[1]]

orchp_0 <- T2_0$orchard_rep[[1]][[1]]

#plot(x = c(1:years), y = reef_100, type = "l", las = 1)
#lines(x = c(1:years), y = reef_50, type = "l")
#lines(x = c(1:years), y = reef_0, type = "l")



# plot cover (m2) instead

reef_100p <- rep(NA, years)

for(i in 1:years){
  
  reef_100p[i] <- (sum(T2_100$reef_pops_pre[[1]][[1]][,i]*A_mids) + sum(T2_100$reef_pops_pre[[1]][[2]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}

reef_0p <- rep(NA, years)

for(i in 1:years){
  
  reef_0p[i] <- (sum(T2_0$reef_pops_pre[[1]][[1]][,i]*A_mids) + sum(T2_0$reef_pops_pre[[1]][[2]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}

reef_50p <- rep(NA, years)

for(i in 1:years){
  
  reef_50p[i] <- (sum(T2_50$reef_pops_pre[[1]][[1]][,i]*A_mids) + sum(T2_50$reef_pops_pre[[1]][[2]][,i]*A_mids))/10000#/sum(reef_areas)*100
  
}


col_set <- c("orchid", "darkorange", "lightgreen")

# calculate cost per year: 
# need to know cost of lab maintenance

#par(mfrow = c(1, 2))
par(mar=c(0, 3.5, 0.5, 1), oma = c(3.5, 1.5, 2, 0))
plot(x = c(1:years), y = reef_100p, type = "l", las = 1, col = col_set[1], lwd = 2, xlab = NA, ylab = NA)
mtext(side = 1, "Time (years)", line = 2, cex = 1.2)
mtext(side = 2, expression("Coral Cover ("*m^2*")"), line = 2.5, cex = 1.2)
#text(x = years-1, y = max(reef_100p)-0.75, paste("$", "xx", "/year", sep = ""), col = col_set[1])
#text(x = years-1, y = max(reef_50p)-0.5, paste("$", "xx", "/year", sep = ""), col = col_set[2])
#text(x = years-1, y = max(reef_0p) + 0.25, paste("$", "xx", "/year", sep = ""), col = col_set[3])
lines(x = c(1:years), y = reef_50p, type = "l", col = col_set[2], lwd = 2)
lines(x = c(1:years), y = reef_0p, type = "l", col = col_set[3], lwd = 2)
legend("topleft", legend = c("100% to reef", "50%", "0% to reef"), lwd = 2, col = col_set, bty = "n")


# now plot orchard production
par(mar=c(0, 3.5, 0.5, 1), oma = c(3.5, 1.5, 2, 0))
plot(x = c(1:years), y = orchp_100/(10^6), type = "l", las = 1, col = col_set[1], lwd = 2, xlab = NA, ylab = NA, ylim = c(0, max(orchp_0, orchp_50, orchp_100)/(10^6)))
mtext(side = 1, "Time (years)", line = 2, cex = 1.1)
#mtext(side = 2, "Orchard production (larvae x 10^6)", line = 2)
mtext(side = 2, expression("Orchard production (larvae x"~10^6*")"), line = 2, cex = 1.2)
lines(x = c(1:years), y = orchp_50/(10^6), type = "l", col = col_set[2], lwd = 2)
lines(x = c(1:years), y = orchp_0/(10^6), type = "l", col = col_set[3], lwd = 2)
legend("topleft", legend = c("100% to reef", "50%", "0% to reef"), lwd = 2, col = col_set, bty = "n")


```


## ROI


money invested in orchard (prop. to orchard size) on the x-axis

```{r}

prop_set1 <- c(0, 0.5, 1) # proportion outplanted to reef
cap_set1 <- seq(from = 0, to = 200, length.out = 25) # max orchard capacity

pop_mat1 <- matrix(NA, nrow = length(cap_set1), ncol = length(prop_set1))
#pcover_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))
area_mat1 <- matrix(NA, nrow = length(cap_set1), ncol = length(prop_set1))

for(i in 1:length(prop_set1)){
  
  for(j in 1:length(cap_set1)){
    
    reef_prop.ij <- prop_set1[i]
   orchard_size.ij <- cap_set1[j]
   
rest_pars.ij <- list(tile_props = tile_props, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop.ij, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size.ij, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

  sim.ij <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.ij, N0.r, N0.o, N0.l)
    
  
  # record final population size
  pop_mat1[j,i] <- sum(sim.ij$reef_pops_pre[[1]][[1]][,years]) + sum(sim.ij$reef_pops_pre[[1]][[2]][,years])
  
  # record area covered
  area_mat1[j,i] <- (sum(sim.ij$reef_pops_pre[[1]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[1]][[2]][,years]*A_mids))/10000
  
  # record final % cover
  #pcover_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[2]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]*A_mids))/sum(reef_areas)*100
  
  }
}



# repeat with higher lab mortality
```



```{r}
#years

plot(x = cap_set1, y = area_mat1[,1], type = "l", las = 1, col = col_set[3], lwd = 2, xlab = NA, ylab = NA, ylim = c(0, 10))
mtext(side = 1, "Orchard size (max)", line = 2, cex = 1.1)
mtext(side = 2, expression("Coral Cover ("*m^2*") at 30 yrs"), line = 2.5, cex = 1.1)
lines(x = cap_set1, y = area_mat1[,2], type = "l", col = col_set[2], lwd = 2)
lines(x = cap_set1, y = area_mat1[,3], type = "l", col = col_set[1], lwd = 2)
legend("right", legend = c("100% to reef", "50% to reef", "0% to reef"), lwd = 2, col = col_set, bty = "n")

#area_mat1

```

remember the surplus always goes to the reef, and the bigger the orchard capacity is the lower the surplus (except bigger orchard also equals bigger production so I think as the orchard gets really big you can actually get an increase in the surplus, which is why reef cover increases even if 0% is going to the reef). And when 100% goes to the reef, orchard capacity doesn't matter (only the initial conditions) since the orchard will never grow


## heatmap

```{r}

prop_set <- seq(from = 0, to = 1, length.out = 25) # proportion outplanted to reef
cap_set <- seq(from = 0, to = 200, length.out = 25) # max orchard capacity

pop_mat <- matrix(NA, nrow = length(cap_set), ncol = length(prop_set))
#pcover_mat <- matrix(NA, nrow = length(inv_set), ncol = length(prop_set))
area_mat <- matrix(NA, nrow = length(cap_set), ncol = length(prop_set))

for(i in 1:length(prop_set)){
  
  for(j in 1:length(cap_set)){
    
    reef_prop.ij <- prop_set[i]
   orchard_size.ij <- cap_set[j]
   
rest_pars.ij <- list(tile_props = tile_props, orchard_yield = orchard_yield, reef_yield = reef_yield, reef_prop = reef_prop.ij, reef_out_props = reef_out_props, orchard_out_props = orchard_out_props, reef_areas = reef_areas, lab_max = lab_max, lab_retain_max = lab_retain_max, orchard_size = orchard_size.ij, transplant = transplant, trans_mats = trans_mats, trans_reef = trans_reef)

  sim.ij <- rse_mod1(years, n, A_mids, surv_pars.r, dens_pars.r, growth_pars.r, shrink_pars.r, frag_pars.r, fec_pars.r, surv_pars.o, dens_pars.o, growth_pars.o, shrink_pars.o, frag_pars.o, fec_pars.o, lambda, lambda_R, sigma_s, sigma_f, ext_rand, seeds, dist_yrs, dist_pars.r, dist_effects.r, dist_pars.o, dist_effects.o, orchard_treatments, reef_treatments, lab_treatments, lab_pars, rest_pars.ij, N0.r, N0.o, N0.l)
    
  
  # record final population size
  pop_mat[j,i] <- sum(sim.ij$reef_pops_pre[[1]][[1]][,years]) + sum(sim.ij$reef_pops_pre[[1]][[2]][,years])
  
  # record area covered
  area_mat[j,i] <- (sum(sim.ij$reef_pops_pre[[1]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[1]][[2]][,years]*A_mids))/10000
  
  # record final % cover
  #pcover_mat[i,j] <- (sum(sim.ij$reef_pops_pre[[2]][[1]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[2]][,years]*A_mids) + sum(sim.ij$reef_pops_pre[[2]][[3]][,years]*A_mids))/sum(reef_areas)*100
  
  }
}

#area_mat[, length(prop_set)]

# repeat with higher lab mortality
```



```{r}
# filled.contour(x = prop_set, y = cap_set, area_mat, key.title = title(main = expression("Cover ("*m^2*")"), cex.main = 0.8, line = 0.5),
#                color.palette = function(n) hcl.colors(n, "blues", rev = TRUE), plot.axes = {
#   axis(1)
#   axis(2)
#   contour(x = prop_set, y = cap_set, area_mat, levels = 0.75, lwd = 2, drawlabels = T, add = T, vfont = c("sans serif", "bold"), labcex = 1.1)})
# mtext(side = 1, "Prop. outplanted to reef", line = 2.5, adj = 0.25)
# mtext(side = 2, "Max orchard capacity", line = 2.5)


#area_mat[ ,length(prop_set)] <- 0

filled.contour(x = cap_set, y = prop_set, area_mat, key.title = title(main = expression("Reef \nCover ("*m^2*")"), cex.main = 0.8, line = 0.5),
               color.palette = function(n) hcl.colors(n, "blues", rev = TRUE), plot.axes = {
  axis(1)
  axis(2)
  contour(x = cap_set, y = prop_set, area_mat, levels = 120, lwd = 2, drawlabels = F, add = T)})
mtext(side = 1, "Orchard size (max)", line = 2, adj = 0.25, cex = 1.1)
mtext(side = 2, "Prop. outplanted to reef", line = 2.5, cex = 1.1)

```


# scenario 4: orchard use

should the orchard be used for gamete collection or transplanting colonies?

---
title: "rest_pars"
output: html_document
date: "2026-01-30"
---

README: estimating restoration parameters from Fundemar's data

```{r setup, include=FALSE}

# command + option + i for new code chunk
# command + shift + enter to run entire code chunk
# command + enter to run single line of code

library(tidyverse) # command + shift + m for %>%
library(readxl)
library(janitor)

```


from the original "Adicion_Sustratos" matrix (which was just for DLAB in 2025), it looks like they put ~100 tiles in each tank (divided among substrate types) and had 40 tanks

Goal is to know 1) how many embryos they put in each tank, 2) how many tiles per tank, and 3) settlement rates on the tiles. Want to know 1) and 2) to estimate how many tiles they would use for a given number of embryos, and need to know 3) for model parameters


Adicion_Sustratos_Unificada = spawning event, number of embryos, Tank ID, substrate type, and number of substrates

Matriz_Asentamiento_Unificada = number of settlers on the substrates (Tank ID should match A_S_U)

Matriz_Supervivencia_Reclutas_Unificada = recruit survival, but comparing time at T0 to number of settlers in  M_A_U matrix should give survival in the lab?)


```{r}
# read in the data

add_subs <- read_excel("data/Fundemar/Adicion_Sustratos_Unificada.xlsx", sheet = 1) %>% clean_names()

add_subs_APAL <- add_subs %>% filter(species == "APAL")

#View(add_subs_APAL)

sett_mat <- read_excel("data/Fundemar/Matriz_Asentamiento_Unificada.xlsx", sheet = 1) %>% clean_names()

sett_mat_APAL <- sett_mat %>% filter(species == "APAL")

#View(sett_mat_APAL)

surv_mat <- read_excel("data/Fundemar/Matriz_Supervivencia_Reclutas_Unificada.xlsx", sheet = 1) %>% clean_names()

#unique(surv_mat$coral_species)

surv_mat_APAL <- surv_mat %>% filter(coral_species == "Acropora palmata")

# View(surv_mat_APAL) # doesn't have 2025 yet

```


```{r}
# estimating embryos per tank and number of tiles per tank

#View(add_subs_APAL)

#add_subs_APAL %>% group_by(species, spawning_event, spawning_day, spawning_month, spawning_year, year_of_substrate_addition, month_of_substrate_addition, day_of_substrate_addition, tank_id) %>% summarize(n_substrates = sum(amount_of_substrates)) %>% ungroup() %>% arrange(tank_id) %>% view()


#add_subs_APAL %>% group_by(species, spawning_event, spawning_day, tank_id) %>% summarize(n_substrates = sum(amount_of_substrates), embryos_ml_mn = min(embryos_ml), embryos_ml_mx = min(embryos_ml)) %>% ungroup() %>% arrange(spawning_day) %>% mutate(emb_diff = embryos_ml_mx - embryos_ml_mn) %>% view()


tank_counts <- add_subs_APAL %>% group_by(species, spawning_event, spawning_day, tank_id) %>% summarize(n_substrates = sum(amount_of_substrates), embryos_ml = min(embryos_ml), n_embryos = min(no_embryos), vol_embryos_ml = min(volume_of_embryos_ml)) %>% ungroup() %>% arrange(spawning_day)# %>% view()

#View(tank_counts)

mean(tank_counts$embryos_ml) # mean volume put in the tanks = 7293
min(tank_counts$embryos_ml) # 7250
max(tank_counts$embryos_ml) # 7330

mean(tank_counts$vol_embryos_ml) # mean embryos per mL = 1.9
min(tank_counts$vol_embryos_ml) # min = 1.5
max(tank_counts$vol_embryos_ml) # max = 2.07

mean(tank_counts$n_substrates)

#unique(add_subs$embryos_ml[which(add_subs$species %in% c("APAL", "DLAB"))])

#hist(add_subs$embryos_ml)

```

So on average, they are putting about 7,300 mLs in a tank, and on average there are 2 embryos per mL, and they have about 100 substrates per tank

-- so to calculate the number of substrates to use, divide the total mLs collected by 7,300*2 ( = 14600) to get the number of tanks, then multiply that by 100 to get the number of substrates needed (point of this is to avoid scenarios where very little spawn was collected but all model still uses max capacity of tiles, which would mean each tile might have unrealistically low numbers of recruits)

```{r}
# now estimate settlement rates

#unique(add_subs_APAL$spawning_year) # all 2025

#View(sett_mat_APAL[which(sett_mat_APAL$id_rearing_container == "11A"),])

#colnames(sett_mat_APAL)

#sett_mat_APAL_summ <- sett_mat_APAL %>% filter(year_scored == 2025) %>% group_by(month_scored, monitoring_or_random_count, id_rearing_container, substrate_type) %>%  summarize(max_settlers = max(as.numeric(number_of_total_settlers)), n_substrates_sett = n()) #%>% ungroup() %>% group_by(month_scored, id_rearing_container) %>%  summarize(n_substrates_sett = n(), n_settlers = sum(as.numeric(max_settlers))) %>% ungroup() %>% rename(tank_id = id_rearing_container)
  
#sett_mat_APAL_summ <- sett_mat_APAL %>% filter(year_scored == 2025) %>% group_by(month_scored, day_scored, id_rearing_container) %>%  summarize(n_substrates_sett = n(), n_settlers = sum(as.numeric(number_of_total_settlers))) %>% ungroup() %>% rename(tank_id = id_rearing_container)


sett_mat_APAL_summ <- sett_mat_APAL %>% filter(year_scored == 2025) %>% group_by(month_scored, day_scored, id_rearing_container) %>%  summarize(n_substrates_sett = n(), n_settlers = mean(as.numeric(number_of_total_settlers))) %>% ungroup() %>% rename(tank_id = id_rearing_container)


#View(sett_mat_APAL_summ)

#mean(sett_mat_APAL_summ$n_settlers)

sett_rates_APAL <- tank_counts %>% left_join(sett_mat_APAL_summ, by = "tank_id")

#View(sett_rates_APAL)


# day scored = day when counting took place; just use the day with the max number observed for that tile since interested in settlement and not post-settlement mortality? 
# QUESTION: are they removing the substrates after they have been counted, so there is no double counting on different days scored? Or are they recounting substrates that were previously counted to see if there were any new settlers?

# since we don't know, just look at average number of settlers per tile? But also don't know how many substrates there were that had settlers on them...

# for now, assume there is no recounting

# really only care about total number of settlers in the tank? Or number of settlers in the tank and number of substrates with at least one settler?

# maybe they only count a subset of the substrates in a tank?


# in the report they say that the goal is ~30 recruits per substrate

mean(as.numeric(sett_mat_APAL$number_of_total_settlers[which(sett_mat_APAL$year_scored==2025 & sett_mat_APAL$substrate_type=="Cookie cement")]))
mean(as.numeric(sett_mat_APAL$number_of_total_settlers[which(sett_mat_APAL$year_scored==2025 & sett_mat_APAL$substrate_type=="Gear")]))

mean(as.numeric(sett_mat_APAL$number_of_total_settlers[which(sett_mat_APAL$year_scored==2025)]))

median(as.numeric(sett_mat_APAL$number_of_total_settlers[which(sett_mat_APAL$year_scored==2025)]))

hist(as.numeric(sett_mat_APAL$number_of_total_settlers[which(sett_mat_APAL$year_scored==2025)]))

#mean(sett_rates_APAL$n_settlers/sett_rates_APAL$n_substrates_sett)

# have about 20 on average

# multiply average number of settlers per tile (mean = ~20) by the number of tiles per tank (~100) to get total number of settlers in the tank, and divide the total number of embryos in the tank by the number of settlers in the tank to get an estimate of settlement rate

sett_rates_APAL <- sett_rates_APAL %>% mutate(sett_rate = n_settlers*n_substrates/n_embryos)

mean(sett_rates_APAL$sett_rate) # 0.1467558


```

so the average settlement rate is about 15% (might be higher; this is using number of embryos as the initial number when in reality not all of those embryos become larvae)


```{r}



# try replicating the box plot in fundemar's report

# %>% group_by(id_rearing_container, substrate_type, day_scored, month_scored) %>% mutate(number_of_total_settlers = mean(as.numeric(number_of_total_settlers))) %>% ungroup()

sett_mat_APAL %>% filter(year_scored == 2025) %>% 
ggplot(aes(x=as.factor(substrate_type), y=as.numeric(number_of_total_settlers))) + 
    geom_boxplot() +
   #facet_wrap(~substrate_type, scales = "free")+
  labs(title = "Larval settlement",
       y = "Average settlement", x = "Substrate") +
  theme(legend.position = "none")

# pretty close but not an exact match with Fig. 2



```



